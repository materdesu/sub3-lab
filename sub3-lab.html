<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SUB3 LAB</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #222222;
    --accent: #e8ff00;
    --accent2: #ff4444;
    --accent3: #4488ff;
    --text: #f0f0f0;
    --text-muted: #666666;
    --text-dim: #333333;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 4px;
    color: var(--accent);
  }

  .logo span { color: var(--text-muted); }

  .strava-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #fc4c02;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
  }

  .strava-btn.connected {
    background: var(--surface2);
    border: 1px solid #fc4c02;
    color: #fc4c02;
  }

  /* VDOT CARD */
  .vdot-card {
    margin: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  .vdot-card::before {
    content: 'VDOT';
    font-family: 'Bebas Neue', sans-serif;
    font-size: 120px;
    color: #ffffff04;
    position: absolute;
    right: -10px;
    top: -10px;
    line-height: 1;
    pointer-events: none;
  }

  .vdot-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }

  .vdot-main .label {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-muted);
    text-transform: uppercase;
  }

  .vdot-main .number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 80px;
    line-height: 1;
    color: var(--accent);
  }

  .vdot-main .base {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .sub3-target {
    text-align: right;
  }

  .sub3-target .t-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text-muted);
    text-transform: uppercase;
  }

  .sub3-target .t-gap {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--accent2);
    line-height: 1;
  }

  .sub3-target .t-unit {
    font-size: 11px;
    color: var(--text-muted);
  }

  .progress-bar {
    background: var(--border);
    height: 4px;
    border-radius: 0;
    margin-bottom: 8px;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent3), var(--accent));
    width: 74%;
    position: relative;
    transition: width 1s ease;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    right: -1px;
    top: -4px;
    width: 12px;
    height: 12px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--accent);
  }

  .progress-labels {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 20px;
  }

  .progress-labels .goal { color: var(--accent); }

  /* PACE ZONES */
  .pace-zones {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
  }

  .pace-zone {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 8px 4px;
    border-radius: 2px;
    text-align: center;
  }

  .pace-zone.active { border-color: var(--accent); }

  .pace-zone .z-name {
    font-size: 8px;
    letter-spacing: 1px;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .pace-zone .z-pace {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  .pace-zone.active .z-pace { color: var(--accent); }

  .pace-zone .z-desc {
    font-size: 8px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* SECTION */
  .section {
    margin: 0 16px 16px;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .section-title {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-muted);
    text-transform: uppercase;
  }

  .section-action {
    font-size: 11px;
    color: var(--accent);
    cursor: pointer;
    background: none;
    border: none;
    font-family: 'Noto Sans JP', sans-serif;
  }

  /* CSV IMPORT */
  .import-zone {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 24px 16px;
    text-align: center;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .import-zone:hover, .import-zone.drag-over { border-color: var(--accent); }
  .import-zone .iz-icon { font-size: 32px; margin-bottom: 8px; }
  .import-zone .iz-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .import-zone .iz-sub { font-size: 11px; color: var(--text-muted); line-height: 1.7; }
  .import-result {
    background: var(--surface);
    border: 1px solid #4dc84d;
    border-radius: 4px;
    padding: 12px 16px;
    margin-bottom: 12px;
    font-size: 13px;
    color: #4dc84d;
    display: none;
  }

  /* SYNC BUTTON */
  .sync-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .sync-info { font-size: 12px; color: var(--text-muted); }
  .sync-info strong { color: var(--text); display: block; margin-bottom: 2px; }

  .btn-sync {
    background: #fc4c02;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    white-space: nowrap;
  }

  .btn-sync:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* GAP ANALYSIS */
  .gap-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 12px;
  }

  .gap-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .gap-avatar {
    width: 36px;
    height: 36px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .gap-title { font-size: 13px; font-weight: 500; }
  .gap-subtitle { font-size: 10px; color: var(--text-muted); margin-top: 1px; }

  .gap-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }

  .gap-metric {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 10px 8px;
    border-radius: 2px;
    text-align: center;
  }

  .gap-metric .gm-label {
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .gap-metric .gm-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 600;
    color: var(--accent);
  }

  .gap-metric.warn .gm-val { color: var(--accent2); }
  .gap-metric.ok .gm-val { color: #4dc84d; }

  .gap-message {
    font-size: 13px;
    line-height: 1.9;
    color: var(--text-muted);
    border-left: 2px solid var(--accent);
    padding-left: 14px;
  }

  .gap-message strong { color: var(--text); }

  /* LOG LIST */
  .log-list { display: flex; flex-direction: column; gap: 1px; }

  .log-item {
    background: var(--surface);
    padding: 14px 16px;
    display: grid;
    grid-template-columns: 60px 1fr auto;
    gap: 12px;
    align-items: center;
    border-left: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
  }

  .log-item:hover, .log-item:active {
    border-left-color: var(--accent);
    background: rgba(232,255,0,0.02);
  }

  .log-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .log-content {}

  .log-type-badge {
    display: inline-block;
    font-size: 9px;
    letter-spacing: 1px;
    padding: 2px 6px;
    border-radius: 1px;
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .type-easy { background: rgba(77,200,77,0.15); color: #4dc84d; }
  .type-tempo { background: rgba(255,200,0,0.15); color: #ffc800; }
  .type-interval { background: rgba(255,68,68,0.15); color: var(--accent2); }
  .type-long { background: rgba(68,136,255,0.15); color: var(--accent3); }
  .type-race { background: rgba(232,255,0,0.15); color: var(--accent); }

  .log-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  .log-stats {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    margin-top: 2px;
  }

  .log-vdot {
    text-align: right;
  }

  .log-vdot .vv {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 600;
    color: var(--accent);
    line-height: 1;
  }

  .log-vdot .vv-label {
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  /* NEXT MENU */
  .next-menu {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .next-item {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: 48px 1fr;
    gap: 12px;
    align-items: center;
  }

  .next-item:last-child { border-bottom: none; }

  .next-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    line-height: 1.4;
    text-align: center;
  }

  .next-date.today { color: var(--accent); }
  .next-date.key { color: var(--accent2); }

  .next-name { font-size: 13px; font-weight: 500; }
  .next-detail { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }

  /* BOTTOM NAV */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    padding-bottom: env(safe-area-inset-bottom);
  }

  .nav-item {
    padding: 12px 4px;
    text-align: center;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--text-muted);
    font-family: 'Noto Sans JP', sans-serif;
    transition: color 0.15s;
  }

  .nav-item.active { color: var(--accent); }

  .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
  .nav-label { font-size: 9px; letter-spacing: 1px; }

  /* PAGES */
  .page { display: none; padding-bottom: 80px; }
  .page.active { display: block; }

  /* FAB */
  .fab {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(232,255,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    transition: transform 0.2s;
  }

  .fab:active { transform: scale(0.92); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 200;
    align-items: flex-end;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--surface);
    border-top: 1px solid var(--border);
    border-radius: 12px 12px 0 0;
    padding: 24px 20px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .modal-handle {
    width: 40px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 20px;
  }

  .modal-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 20px;
  }

  /* FORM */
  .form-group {
    margin-bottom: 14px;
  }

  .form-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 6px;
    display: block;
  }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--accent);
  }

  .form-select option { background: #1a1a1a; }

  .form-textarea {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 14px;
    resize: none;
    height: 80px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .btn-primary {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 16px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 3px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.2s;
  }

  .btn-primary:active { opacity: 0.8; }

  /* COACH RESPONSE */
  .coach-response {
    font-size: 14px;
    line-height: 2;
    color: var(--text-muted);
    border-left: 2px solid var(--accent);
    padding-left: 16px;
    margin: 16px 0;
  }

  .coach-response strong { color: var(--text); }

  .modal-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }

  .m-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 12px 8px;
    border-radius: 2px;
    text-align: center;
  }

  .m-card .ml { font-size: 9px; letter-spacing: 1px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
  .m-card .mv { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--accent); }

  .btn-share {
    width: 100%;
    background: #1da1f2;
    color: white;
    border: none;
    padding: 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 8px;
  }

  .btn-close-modal {
    width: 100%;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 8px;
  }

  /* LOADING */
  .loading {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 13px;
    padding: 8px 0;
  }

  .dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: blink 1.2s infinite;
    margin: 0 2px;
  }

  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  /* STRAVA ACTIVITIES */
  .strava-activity {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 14px 16px;
    border-left: 2px solid #fc4c02;
    margin-bottom: 2px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .strava-activity:active { background: rgba(252,76,2,0.05); }

  .strava-activity .sa-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
  }

  .strava-activity .sa-name { font-size: 13px; font-weight: 500; }
  .strava-activity .sa-date { font-size: 10px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

  .strava-activity .sa-stats {
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    display: flex;
    gap: 16px;
  }

  .strava-activity .sa-stats span { color: var(--text); }

  /* TOAST */
  .toast {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 13px;
    z-index: 300;
    opacity: 0;
    transition: opacity 0.3s;
    white-space: nowrap;
  }

  .toast.show { opacity: 1; }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 13px;
    line-height: 2;
  }

  .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
</style>
</head>
<body>

<header>
  <div class="logo">SUB3 <span>LAB</span></div>
  <button class="strava-btn" id="stravaBtn" onclick="syncStrava()">
    ğŸ”„ StravaåŒæœŸ
  </button>
</header>

<div class="toast" id="toast"></div>

<!-- PAGE: HOME -->
<div class="page active" id="page-home">

  <!-- VDOT CARD -->
  <div class="vdot-card">
    <div class="vdot-top">
      <div class="vdot-main">
        <div class="label">Current VDOT</div>
        <div class="number" id="currentVdot">47</div>
        <div class="base">ãƒãƒ¼ãƒ• 1:51:53</div>
      </div>
      <div class="sub3-target">
        <div class="t-label">ã‚ã¨</div>
        <div class="t-gap" id="vdotGap">6</div>
        <div class="t-unit">VDOT pts</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-labels">
      <span>30</span>
      <span class="goal">SUB3 = VDOT 53</span>
    </div>

    <div class="pace-zones" id="paceZones"></div>
  </div>

  <!-- GAP ANALYSIS -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">AIã‚³ãƒ¼ãƒåˆ†æ</div>
      <button class="section-action" onclick="runGapAnalysis()">ä»Šé€±ã‚’åˆ†æ</button>
    </div>
    <div id="gapAnalysis">
      <div class="gap-card">
        <div class="gap-header">
          <div class="gap-avatar">ğŸƒ</div>
          <div>
            <div class="gap-title">AIã‚³ãƒ¼ãƒ</div>
            <div class="gap-subtitle">é€±æ¬¡ã‚®ãƒ£ãƒƒãƒ—åˆ†æ</div>
          </div>
        </div>
        <div class="gap-message" id="gapMessage">
          ã€Œä»Šé€±ã‚’åˆ†æã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ä»Šé€±ã®ç·´ç¿’å†…å®¹ã‚’åˆ†æã—ã¦ã‚µãƒ–ã‚¹ãƒªãƒ¼ã«å‘ã‘ãŸã‚®ãƒ£ãƒƒãƒ—ã¨æ”¹å–„ç‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- NEXT MENU -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">æ¨å¥¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    </div>
    <div class="next-menu" id="nextMenu">
      <div class="next-item">
        <div class="next-date today">02/22<br>SAT</div>
        <div>
          <div class="next-name">ãƒ­ãƒ³ã‚°èµ° 30km</div>
          <div class="next-detail">5'15ã€œ5'30/kmã€€HR&lt;145</div>
        </div>
      </div>
      <div class="next-item">
        <div class="next-date">02/24<br>MON</div>
        <div>
          <div class="next-name">Easy 10km</div>
          <div class="next-detail">6'00ã€œ6'20/kmã€€ãƒªã‚«ãƒãƒªãƒ¼</div>
        </div>
      </div>
      <div class="next-item">
        <div class="next-date key">02/25<br>TUE âš¡</div>
        <div>
          <div class="next-name">é–¾å€¤èµ° 15km</div>
          <div class="next-detail">4'42ã€œ4'48/kmã€€ä¸­é–“8kmã‚’T</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- PAGE: LOG -->
<div class="page" id="page-log">
  <div style="padding: 16px 16px 0;">

    <div class="import-zone" id="importZone"
      onclick="document.getElementById('csvFileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleCsvDrop(event)">
      <div class="iz-icon">ğŸ“‚</div>
      <div class="iz-title">Stravaãƒ‡ãƒ¼ã‚¿(CSV)ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      <div class="iz-sub">activities.csvã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ<br>Stravaâ†’è¨­å®šâ†’ãƒã‚¤ã‚¢ã‚«ã‚¦ãƒ³ãƒˆâ†’ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
    </div>
    <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleCsvFile(this.files[0])">
    <div class="import-result" id="importResult"></div>

    <div class="sync-bar">
      <div class="sync-info">
        <strong>Stravaé€£æº</strong>
        æœ€çµ‚åŒæœŸï¼š<span id="lastSync">æœªåŒæœŸ</span>
      </div>
      <button class="btn-sync" id="syncBtn" onclick="syncStrava()">åŒæœŸã™ã‚‹</button>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ç·´ç¿’ãƒ­ã‚°</div>
      <span id="logCount" style="font-size:11px;color:var(--text-muted);"></span>
    </div>
    <div class="log-list" id="logList"></div>
  </div>
</div>

<!-- PAGE: RECORD -->
<div class="page" id="page-record">
  <div style="padding: 16px;">
    <div class="section-title" style="margin-bottom:20px;">æ‰‹å‹•è¨˜éŒ²</div>

    <div class="form-group">
      <label class="form-label">æ—¥ä»˜</label>
      <input type="date" class="form-input" id="recDate">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ã‚¿ã‚¤ãƒ—</label>
        <select class="form-select" id="recType">
          <option value="easy">Easyèµ°</option>
          <option value="long">ãƒ­ãƒ³ã‚°èµ°</option>
          <option value="tempo">é–¾å€¤èµ°</option>
          <option value="interval">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</option>
          <option value="rep">ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³</option>
          <option value="race">ãƒ¬ãƒ¼ã‚¹</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">è·é›¢(km)</label>
        <input type="number" class="form-input" id="recDist" placeholder="21.1" step="0.1">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ã‚¿ã‚¤ãƒ  (hh:mm:ss)</label>
      <input type="text" class="form-input" id="recTime" placeholder="1:51:53">
    </div>

    <div class="form-group">
      <label class="form-label">å¹³å‡HR (bpm)</label>
      <input type="number" class="form-input" id="recHR" placeholder="148">
    </div>

    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢ãƒ»ä½“èª¿</label>
      <textarea class="form-textarea" id="recMemo" placeholder="ä½“èª¿ã€æ°—æ¸©ã€ã‚³ãƒ¼ã‚¹ã€æ„Ÿæƒ³ãªã©..."></textarea>
    </div>

    <button class="btn-primary" onclick="saveManualRun()">SAVE + AIã‚³ãƒ¼ãƒåˆ†æ</button>
  </div>
</div>

<!-- PAGE: STATS -->
<div class="page" id="page-stats">
  <div style="padding: 16px;">
    <div class="section-title" style="margin-bottom:20px;">çµ±è¨ˆ</div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
      <div class="gap-metric" style="padding:16px;">
        <div class="gm-label">ç·èµ°è¡Œè·é›¢</div>
        <div class="gm-val" id="totalDist">â€”</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">km</div>
      </div>
      <div class="gap-metric" style="padding:16px;">
        <div class="gm-label">è¨˜éŒ²æ•°</div>
        <div class="gm-val" id="totalRuns">â€”</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">æœ¬</div>
      </div>
      <div class="gap-metric" style="padding:16px;">
        <div class="gm-label">æœ€é«˜VDOT</div>
        <div class="gm-val" id="maxVdot">â€”</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">æ¨å®šå€¤</div>
      </div>
      <div class="gap-metric" style="padding:16px;">
        <div class="gm-label">ä»Šæœˆè·é›¢</div>
        <div class="gm-val" id="monthDist">â€”</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">km</div>
      </div>
    </div>

    <div class="gap-card">
      <div class="section-title" style="margin-bottom:16px;">VDOTæ¨ç§»</div>
      <canvas id="vdotChart" height="120"></canvas>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('home', this)">
    <span class="nav-icon">ğŸ </span>
    <span class="nav-label">HOME</span>
  </button>
  <button class="nav-item" onclick="showPage('log', this)">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label">LOG</span>
  </button>
  <button class="nav-item" onclick="showPage('record', this)">
    <span class="nav-icon">âœï¸</span>
    <span class="nav-label">è¨˜éŒ²</span>
  </button>
  <button class="nav-item" onclick="showPage('stats', this)">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">STATS</span>
  </button>
</nav>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal" onclick="closeDetailModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailTitle">ç·´ç¿’è©³ç´°</div>
    <div class="modal-metrics" id="detailMetrics"></div>
    <div class="coach-response" id="detailCoach">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> AIã‚³ãƒ¼ãƒãŒåˆ†æä¸­...</div>
    </div>
    <button class="btn-share" onclick="shareToX()">ğ• ã§ã‚·ã‚§ã‚¢</button>
    <button class="btn-close-modal" onclick="document.getElementById('detailModal').classList.remove('active')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const CONFIG = {
  clientId: '204782',
  clientSecret: 'f449cb78c79f9b8866c235ebcbc7a3868d2ca8bb',
  accessToken: 'bd23f6d58abecb8993176248bfd28d539f70835b',
  refreshToken: 'e8a62cbe37282dc23334c0f0e891b89de66abc9d',
  baseVdot: 47,
  targetVdot: 53,
  halfPR: '1:51:53'
};

// ===== VDOT CALCULATIONS =====
function calcVDOT(distKm, timeSec) {
  if (!distKm || !timeSec) return null;
  const speedMperMin = (distKm * 1000) / (timeSec / 60);
  const vo2 = -4.60 + 0.182258 * speedMperMin + 0.000104 * Math.pow(speedMperMin, 2);
  const pct = 0.8 + 0.1894393 * Math.exp(-0.012778 * (timeSec/60)) + 0.2989558 * Math.exp(-0.1932605 * (timeSec/60));
  const vdot = Math.round(vo2 / pct);
  return vdot > 20 && vdot < 90 ? vdot : null;
}

function getPaceZones(vdot) {
  const zones = {
    30: { easy: '7\'30"', marathon: '6\'28"', threshold: '5\'54"', interval: '5\'30"', rep: '5\'08"' },
    35: { easy: '6\'58"', marathon: '5\'59"', threshold: '5\'26"', interval: '5\'04"', rep: '4\'44"' },
    40: { easy: '6\'32"', marathon: '5\'36"', threshold: '5\'05"', interval: '4\'44"', rep: '4\'24"' },
    45: { easy: '6\'12"', marathon: '5\'18"', threshold: '4\'49"', interval: '4\'29"', rep: '4\'09"' },
    47: { easy: '6\'03"', marathon: '5\'12"', threshold: '4\'42"', interval: '4\'22"', rep: '4\'04"' },
    48: { easy: '5\'59"', marathon: '5\'09"', threshold: '4\'38"', interval: '4\'18"', rep: '4\'01"' },
    50: { easy: '5\'52"', marathon: '5\'02"', threshold: '4\'32"', interval: '4\'12"', rep: '3\'54"' },
    53: { easy: '5\'42"', marathon: '4\'54"', threshold: '4\'23"', interval: '4\'03"', rep: '3\'46"' },
    55: { easy: '5\'36"', marathon: '4\'48"', threshold: '4\'18"', interval: '3\'57"', rep: '3\'41"' },
  };
  const keys = Object.keys(zones).map(Number).sort((a,b) => a-b);
  let best = keys[0];
  for (const k of keys) { if (k <= vdot) best = k; }
  return zones[best] || zones[47];
}

function formatPace(distKm, timeSec) {
  const paceTotal = timeSec / distKm;
  const min = Math.floor(paceTotal / 60);
  const sec = Math.round(paceTotal % 60);
  return `${min}'${String(sec).padStart(2,'0')}"`;
}

function parseDuration(str) {
  if (!str) return 0;
  const parts = str.split(':').map(Number);
  if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
  if (parts.length === 2) return parts[0]*60 + parts[1];
  return parseInt(str) || 0;
}

function formatDuration(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

// ===== LOCAL STORAGE =====
function getLogs() {
  try { return JSON.parse(localStorage.getItem('sub3_logs') || '[]'); } catch { return []; }
}

function saveLogs(logs) {
  localStorage.setItem('sub3_logs', JSON.stringify(logs));
}

function addLog(log) {
  const logs = getLogs();
  log.id = Date.now();
  logs.unshift(log);
  saveLogs(logs);
  return log;
}

// ===== UI =====
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'log') renderLogList();
  if (name === 'stats') renderStats();
}

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ===== VDOT CARD =====
function renderVdotCard(vdot = CONFIG.baseVdot) {
  document.getElementById('currentVdot').textContent = vdot;
  document.getElementById('vdotGap').textContent = Math.max(0, CONFIG.targetVdot - vdot);
  const pct = Math.min(100, Math.max(0, (vdot - 30) / (CONFIG.targetVdot - 30) * 100));
  document.getElementById('progressFill').style.width = pct + '%';

  const zones = getPaceZones(vdot);
  const zoneData = [
    { name: 'Easy', pace: zones.easy, desc: 'æœ‰é…¸ç´ åŸºç›¤' },
    { name: 'M Pace', pace: zones.marathon, desc: 'ãƒãƒ©ã‚½ãƒ³', active: true },
    { name: 'Tempo', pace: zones.threshold, desc: 'é–¾å€¤èµ°', active: true },
    { name: 'Interval', pace: zones.interval, desc: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
    { name: 'Rep', pace: zones.rep, desc: 'ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³' },
  ];

  document.getElementById('paceZones').innerHTML = zoneData.map(z => `
    <div class="pace-zone ${z.active ? 'active' : ''}">
      <div class="z-name">${z.name}</div>
      <div class="z-pace">${z.pace}</div>
      <div class="z-desc">${z.desc}</div>
    </div>
  `).join('');
}

// ===== LOG LIST =====
function getTypeLabel(type) {
  const map = { easy: 'Easy', long: 'Long', tempo: 'Tempo', interval: 'Interval', rep: 'Rep', race: 'Race', run: 'Run' };
  return map[type] || 'Run';
}

function getTypeClass(type) {
  const map = { easy: 'type-easy', long: 'type-long', tempo: 'type-tempo', interval: 'type-interval', rep: 'type-interval', race: 'type-race', run: 'type-easy' };
  return map[type] || 'type-easy';
}

function renderLogList() {
  const logs = getLogs();
  const container = document.getElementById('logList');
  document.getElementById('logCount').textContent = logs.length + 'ä»¶';

  if (logs.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="emoji">ğŸƒ</div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“<br>StravaåŒæœŸã‹æ‰‹å‹•è¨˜éŒ²ã§è¿½åŠ ã—ã¦ãã ã•ã„</div>`;
    return;
  }

  container.innerHTML = logs.map((log, i) => {
    const date = new Date(log.date || log.start_date);
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const dateStr = `${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}<br>${days[date.getDay()]}`;
    const dist = log.distance ? (log.distance / 1000).toFixed(1) : (log.distKm || 0).toFixed(1);
    const timeSec = log.moving_time || parseDuration(log.duration);
    const pace = formatPace(parseFloat(dist), timeSec);
    const vdot = calcVDOT(parseFloat(dist), timeSec);

    return `
      <div class="log-item" onclick="showLogDetail(${i})">
        <div class="log-date">${dateStr}</div>
        <div class="log-content">
          <span class="log-type-badge ${getTypeClass(log.type || log.runType)}">${getTypeLabel(log.type || log.runType)}</span>
          <div class="log-name">${log.name || (dist + 'kmèµ°')}</div>
          <div class="log-stats">${dist}kmã€€${pace}/km${log.average_heartrate ? 'ã€€HR' + Math.round(log.average_heartrate) : ''}</div>
        </div>
        <div class="log-vdot">
          <div class="vv">${vdot || 'â€”'}</div>
          <div class="vv-label">VDOT</div>
        </div>
      </div>
    `;
  }).join('');
}

// ===== LOG DETAIL MODAL =====
let currentLogIndex = null;

async function showLogDetail(idx) {
  const logs = getLogs();
  const log = logs[idx];
  currentLogIndex = idx;

  const dist = log.distance ? (log.distance / 1000).toFixed(1) : (log.distKm || 0).toFixed(1);
  const timeSec = log.moving_time || parseDuration(log.duration);
  const pace = formatPace(parseFloat(dist), timeSec);
  const vdot = calcVDOT(parseFloat(dist), timeSec);
  const hr = log.average_heartrate ? Math.round(log.average_heartrate) : (log.hr || 'â€”');

  document.getElementById('detailTitle').textContent = log.name || getTypeLabel(log.type || log.runType) + ' ' + dist + 'km';
  document.getElementById('detailMetrics').innerHTML = `
    <div class="m-card"><div class="ml">è·é›¢</div><div class="mv">${dist}<span style="font-size:12px">km</span></div></div>
    <div class="m-card"><div class="ml">ãƒšãƒ¼ã‚¹</div><div class="mv">${pace}</div></div>
    <div class="m-card"><div class="ml">VDOT</div><div class="mv">${vdot || 'â€”'}</div></div>
  `;
  document.getElementById('detailCoach').innerHTML = `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> åˆ†æä¸­...</div>`;
  document.getElementById('detailModal').classList.add('active');

  // Claude APIã§ã‚³ãƒ¼ãƒãƒ³ã‚°
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: `ã‚ãªãŸã¯Jack Danielsã®VDOTãƒ¡ã‚½ãƒƒãƒ‰ã«ç²¾é€šã—ãŸãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚
é¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šå·å³¶å¤§è¼ã€31æ­³ã€ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³PB 1:51:53ï¼ˆVDOT 47ï¼‰ã€ç›®æ¨™ã¯ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³2:59:59ã€VDOT 53ï¼‰ã€‚
ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ãã€200ã€œ250å­—ã®æ—¥æœ¬èªã§ç°¡æ½”ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
å¼·èª¿ç®‡æ‰€ã¯<strong>ã‚¿ã‚°ã§å›²ã‚“ã§ãã ã•ã„ã€‚`,
        messages: [{
          role: "user",
          content: `ç·´ç¿’å†…å®¹ï¼š${log.name || getTypeLabel(log.type)}ã€è·é›¢${dist}kmã€ã‚¿ã‚¤ãƒ ${formatDuration(timeSec)}ã€ãƒšãƒ¼ã‚¹${pace}/kmã€HR${hr}bpmã€VDOTæ›ç®—${vdot}ã€‚ãƒ¡ãƒ¢ï¼š${log.memo || log.description || 'ãªã—'}ã€‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãã ã•ã„ã€‚`
        }]
      })
    });
    const data = await res.json();
    document.getElementById('detailCoach').innerHTML = data.content?.[0]?.text || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  } catch(e) {
    document.getElementById('detailCoach').innerHTML = `<strong>è¨˜éŒ²å®Œäº†ï¼</strong>\n\nVDOTæ›ç®—ï¼š${vdot || 'è¨ˆç®—ä¸­'}\nãƒšãƒ¼ã‚¹ï¼š${pace}/km\n\nå¼•ãç¶šãã‚µãƒ–ã‚¹ãƒªãƒ¼ã«å‘ã‘ã¦é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼`;
  }
}

function closeDetailModal(e) {
  if (e.target === document.getElementById('detailModal')) {
    document.getElementById('detailModal').classList.remove('active');
  }
}

// ===== SHARE TO X =====
function shareToX() {
  const logs = getLogs();
  if (currentLogIndex === null) return;
  const log = logs[currentLogIndex];
  const dist = log.distance ? (log.distance/1000).toFixed(1) : log.distKm;
  const timeSec = log.moving_time || parseDuration(log.duration);
  const vdot = calcVDOT(parseFloat(dist), timeSec);
  const pace = formatPace(parseFloat(dist), timeSec);
  const text = `ä»Šæ—¥ã®ç·´ç¿’ ğŸƒ\nè·é›¢ï¼š${dist}km\nãƒšãƒ¼ã‚¹ï¼š${pace}/km\nVDOTï¼š${vdot}\n\nã‚µãƒ–ã‚¹ãƒªãƒ¼ã¾ã§VDOT${Math.max(0, CONFIG.targetVdot - (vdot || CONFIG.baseVdot))}ãƒã‚¤ãƒ³ãƒˆï¼\n\n#ã‚µãƒ–ã‚¹ãƒªãƒ¼ #ãƒãƒ©ã‚½ãƒ³ #SUB3LAB`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`);
}

// ===== MANUAL RECORD =====
async function saveManualRun() {
  const dist = parseFloat(document.getElementById('recDist').value);
  const timeStr = document.getElementById('recTime').value;
  const type = document.getElementById('recType').value;
  const date = document.getElementById('recDate').value;
  const memo = document.getElementById('recMemo').value;
  const hr = document.getElementById('recHR').value;

  if (!dist || !timeStr || !date) {
    showToast('âš ï¸ æ—¥ä»˜ãƒ»è·é›¢ãƒ»ã‚¿ã‚¤ãƒ ã¯å¿…é ˆã§ã™');
    return;
  }

  const timeSec = parseDuration(timeStr);
  const log = { distKm: dist, duration: timeStr, runType: type, date, memo, hr: hr || null, name: `${getTypeLabel(type)} ${dist}km`, source: 'manual' };
  addLog(log);
  showToast('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('recDist').value = '';
  document.getElementById('recTime').value = '';
  document.getElementById('recMemo').value = '';
  document.getElementById('recHR').value = '';

  // ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  showPage('log', document.querySelectorAll('.nav-item')[1]);
  setTimeout(() => showLogDetail(0), 300);
}

// ===== STRAVA SYNC =====
async function syncStrava() {
  const btn = document.getElementById('syncBtn');
  btn.disabled = true;
  btn.textContent = 'åŒæœŸä¸­...';
  showToast('ğŸ”„ Stravaã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

  try {
    // Stravaãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    let accessToken = CONFIG.accessToken;

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å–å¾—
    const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=200&access_token=${accessToken}`);

    if (res.status === 401) {
      // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      const refreshRes = await fetch('https://www.strava.com/oauth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_id: CONFIG.clientId,
          client_secret: CONFIG.clientSecret,
          refresh_token: CONFIG.refreshToken,
          grant_type: 'refresh_token'
        })
      });
      const refreshData = await refreshRes.json();
      accessToken = refreshData.access_token;
      CONFIG.accessToken = accessToken;

      // å†å–å¾—ï¼ˆå…¨ä»¶ï¼‰
      const res2 = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=200&access_token=${accessToken}`);
      const activities = await res2.json();
      processStravaActivities(activities);
    } else {
      const activities = await res.json();
      processStravaActivities(activities);
    }

  } catch(e) {
    showToast('âŒ åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }

  btn.disabled = false;
  btn.textContent = 'åŒæœŸã™ã‚‹';
}

function processStravaActivities(activities) {
  if (!Array.isArray(activities)) {
    showToast('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    return;
  }

  const runs = activities.filter(a => a.type === 'Run' || a.sport_type === 'Run');
  const existing = getLogs();
  const existingIds = new Set(existing.map(l => l.strava_id).filter(Boolean));

  let added = 0;
  const newLogs = [];

  for (const run of runs) {
    if (!existingIds.has(run.id)) {
      newLogs.push({
        ...run,
        strava_id: run.id,
        runType: classifyRun(run),
        source: 'strava',
        id: Date.now() + added
      });
      added++;
    }
  }

  if (added > 0) {
    saveLogs([...newLogs, ...existing]);
    // VDOTã‚’æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã§æ›´æ–°
    const best = findBestVdot();
    if (best > CONFIG.baseVdot) renderVdotCard(best);
  }

  const now = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
  document.getElementById('lastSync').textContent = now;
  showToast(added > 0 ? `âœ… ${added}ä»¶ã®ç·´ç¿’ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼` : 'âœ… æœ€æ–°ã®çŠ¶æ…‹ã§ã™');
  renderLogList();
}

function classifyRun(activity) {
  const dist = activity.distance / 1000;
  const avgPace = activity.moving_time / dist;
  if (dist >= 25) return 'long';
  if (avgPace < 270) return 'interval'; // 4'30"/km ã‚ˆã‚Šé€Ÿã„
  if (avgPace < 300) return 'tempo';    // 5'00"/km ã‚ˆã‚Šé€Ÿã„
  return 'easy';
}

// ===== GAP ANALYSIS =====
async function runGapAnalysis() {
  const logs = getLogs();
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

  const weekLogs = logs.filter(l => {
    const d = new Date(l.date || l.start_date);
    return d >= oneWeekAgo;
  });

  document.getElementById('gapMessage').innerHTML = `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> ä»Šé€±ã®ç·´ç¿’ã‚’åˆ†æä¸­...</div>`;

  const totalDist = weekLogs.reduce((s, l) => s + (l.distance ? l.distance/1000 : (l.distKm || 0)), 0);
  const qualityRuns = weekLogs.filter(l => ['tempo','interval','rep'].includes(l.runType || l.type || classifyRun(l))).length;
  const longRun = weekLogs.find(l => ['long'].includes(l.runType || l.type) || (l.distance && l.distance/1000 >= 20));

  let summary = `ä»Šé€±ã®ç·´ç¿’ï¼š${weekLogs.length}å›ã€ç·è·é›¢${totalDist.toFixed(0)}kmã€Qualityèµ°${qualityRuns}æœ¬ã€ãƒ­ãƒ³ã‚°èµ°${longRun ? 'ã‚ã‚Š' : 'ãªã—'}`;
  if (weekLogs.length === 0) summary = 'ä»Šé€±ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“';

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: `ã‚ãªãŸã¯Jack Danielsã®VDOTãƒ¡ã‚½ãƒƒãƒ‰ã«ç²¾é€šã—ãŸãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚
é¸æ‰‹ï¼šå·å³¶å¤§è¼ã€VDOT 47ã€ç›®æ¨™ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT 53ï¼‰ã€‚
é€±æ¬¡ã‚®ãƒ£ãƒƒãƒ—åˆ†æã¨ã—ã¦ã€ä»Šé€±ã®ç·´ç¿’ã®ã€Œä½•ãŒè¶³ã‚Šãªã„ã‹ã€ã€Œä½•ãŒè‰¯ã‹ã£ãŸã‹ã€ã€Œæ¥é€±ä½•ã‚’ã™ã¹ãã‹ã€ã‚’å…·ä½“çš„ã«200ã€œ300å­—ã§åˆ†æã—ã¦ãã ã•ã„ã€‚<strong>ã‚¿ã‚°ã§é‡è¦ç®‡æ‰€ã‚’å¼·èª¿ã—ã¦ãã ã•ã„ã€‚`,
        messages: [{
          role: "user",
          content: summary
        }]
      })
    });
    const data = await res.json();
    document.getElementById('gapMessage').innerHTML = data.content?.[0]?.text || 'åˆ†æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  } catch(e) {
    document.getElementById('gapMessage').innerHTML = weekLogs.length === 0
      ? 'ã¾ã ä»Šé€±ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚StravaåŒæœŸã‹æ‰‹å‹•è¨˜éŒ²ã§ç·´ç¿’ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'
      : `<strong>ä»Šé€±ã®ã‚µãƒãƒªãƒ¼</strong>\n\nç·´ç¿’å›æ•°ï¼š${weekLogs.length}å›\nç·è·é›¢ï¼š${totalDist.toFixed(1)}km\nQualityèµ°ï¼š${qualityRuns}æœ¬\n\nã‚µãƒ–ã‚¹ãƒªãƒ¼ã«ã¯é€±70ã€œ90kmã¨é€±2å›ä»¥ä¸Šã®Qualityèµ°ãŒé‡è¦ã§ã™ã€‚`;
  }
}

// ===== STATS =====
function findBestVdot() {
  const logs = getLogs();
  let best = CONFIG.baseVdot;
  for (const l of logs) {
    const dist = l.distance ? l.distance/1000 : (l.distKm || 0);
    const timeSec = l.moving_time || parseDuration(l.duration);
    const v = calcVDOT(dist, timeSec);
    if (v && v > best) best = v;
  }
  return best;
}

function renderStats() {
  const logs = getLogs();
  const totalDist = logs.reduce((s, l) => s + (l.distance ? l.distance/1000 : (l.distKm || 0)), 0);
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthDist = logs.filter(l => new Date(l.date || l.start_date) >= monthStart)
    .reduce((s, l) => s + (l.distance ? l.distance/1000 : (l.distKm || 0)), 0);

  document.getElementById('totalDist').textContent = totalDist.toFixed(0);
  document.getElementById('totalRuns').textContent = logs.length;
  document.getElementById('maxVdot').textContent = findBestVdot();
  document.getElementById('monthDist').textContent = monthDist.toFixed(0);

  // ã‚·ãƒ³ãƒ—ãƒ«ãªVDOTæ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
  renderVdotChart(logs);
}

function renderVdotChart(logs) {
  const canvas = document.getElementById('vdotChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 300;
  const H = 120;
  canvas.width = W;
  canvas.height = H;

  const recentLogs = logs.slice(0, 20).reverse();
  const vdots = recentLogs.map(l => {
    const dist = l.distance ? l.distance/1000 : (l.distKm || 0);
    const timeSec = l.moving_time || parseDuration(l.duration);
    return calcVDOT(dist, timeSec);
  }).filter(Boolean);

  if (vdots.length < 2) {
    ctx.fillStyle = '#333';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãŒæºœã¾ã‚‹ã¨æ¨ç§»ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™', W/2, H/2);
    return;
  }

  const minV = Math.min(...vdots) - 2;
  const maxV = Math.max(...vdots) + 2;

  ctx.clearRect(0, 0, W, H);

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ©ã‚¤ãƒ³
  const targetY = H - ((53 - minV) / (maxV - minV)) * H;
  ctx.strokeStyle = 'rgba(232,255,0,0.3)';
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(0, targetY);
  ctx.lineTo(W, targetY);
  ctx.stroke();
  ctx.setLineDash([]);

  // ãƒ©ã‚¤ãƒ³
  ctx.strokeStyle = '#e8ff00';
  ctx.lineWidth = 2;
  ctx.beginPath();
  vdots.forEach((v, i) => {
    const x = (i / (vdots.length - 1)) * W;
    const y = H - ((v - minV) / (maxV - minV)) * H;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // ãƒ‰ãƒƒãƒˆ
  vdots.forEach((v, i) => {
    const x = (i / (vdots.length - 1)) * W;
    const y = H - ((v - minV) / (maxV - minV)) * H;
    ctx.fillStyle = '#e8ff00';
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
  });
}

// ===== CSV IMPORT =====
function handleCsvDrop(e) {
  e.preventDefault();
  document.getElementById('importZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleCsvFile(file);
}

function handleCsvFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const imported = parseStravaCsv(text);
      if (imported.length === 0) {
        showToast('âš ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      const existing = getLogs();
      const existingIds = new Set(existing.map(l => l.strava_id).filter(Boolean));
      const newLogs = imported.filter(l => !existingIds.has(l.strava_id));
      saveLogs([...newLogs, ...existing]);
      const result = document.getElementById('importResult');
      result.style.display = 'block';
      result.textContent = 'âœ… ' + newLogs.length + 'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ï¼ˆé‡è¤‡é™¤å¤–æ¸ˆã¿ï¼‰';
      renderLogList();
      const best = findBestVdot();
      renderVdotCard(best);
      showToast('âœ… ' + newLogs.length + 'ä»¶ã®ãƒ©ãƒ³ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼');
    } catch(err) {
      showToast('âŒ CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      console.error(err);
    }
  };
  reader.readAsText(file, 'UTF-8');
}

function parseStravaCsv(text) {
  const lines = text.split('\n');
  if (lines.length < 2) return [];
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è§£æ
  const headers = parseCsvLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
  
  const logs = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const cols = parseCsvLine(line);
    const row = {};
    headers.forEach((h, idx) => row[h] = (cols[idx] || '').replace(/"/g, '').trim());
    
    // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã®ã¿å¯¾è±¡ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä¸¡å¯¾å¿œï¼‰
    const type = row['ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ—'] || row['Activity Type'] || row['type'] || '';
    if (!type.includes('ãƒ©ãƒ³') && !type.toLowerCase().includes('run')) continue;
    
    // è·é›¢(km) - Stravaã®æ—¥æœ¬èªCSVã¯kmå˜ä½
    const distKm = parseFloat(row['è·é›¢'] || row['Distance'] || 0);
    if (distKm < 0.5) continue;
    
    // ã‚¿ã‚¤ãƒ (ç§’) - ç§»å‹•æ™‚é–“ã‚’å„ªå…ˆ
    const movingTime = parseInt(parseFloat(row['ç§»å‹•æ™‚é–“'] || row['Moving Time'] || row['çµŒéæ™‚é–“'] || 0));
    if (!movingTime) continue;
    
    // æ—¥ä»˜
    const dateStr = row['ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å®Ÿè¡Œæ—¥'] || row['Activity Date'] || row['start_date'] || '';
    const date = new Date(dateStr.replace(/\//g, '-'));
    if (isNaN(date.getTime())) continue;
    
    // å¿ƒæ‹æ•°
    const hr = parseFloat(row['å¹³å‡å¿ƒæ‹æ•°'] || row['Average Heart Rate'] || 0) || null;
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ID
    const actId = row['ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ID'] || row['Activity ID'] || (date.getTime() + i + '');
    
    // åå‰
    const name = row['ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å'] || row['Activity Name'] || (distKm.toFixed(1) + 'kmèµ°');

    const log = {
      id: Date.now() + i,
      strava_id: actId,
      name: name,
      date: date.toISOString(),
      distKm: distKm,
      distance: distKm * 1000,
      moving_time: movingTime,
      duration: formatDuration(movingTime),
      average_heartrate: hr,
      runType: classifyRunByPace(distKm, movingTime),
      source: 'strava_csv'
    };
    logs.push(log);
  }
  return logs;
}

function parseCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') {
      inQuotes = !inQuotes;
    } else if (line[i] === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += line[i];
    }
  }
  result.push(current);
  return result;
}

function classifyRunByPace(distKm, timeSec) {
  if (!distKm || !timeSec) return 'easy';
  const paceSecPerKm = timeSec / distKm;
  if (distKm >= 25) return 'long';
  if (paceSecPerKm < 270) return 'interval';
  if (paceSecPerKm < 295) return 'tempo';
  return 'easy';
}

// ===== INIT =====
function init() {
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
  document.getElementById('recDate').value = new Date().toISOString().split('T')[0];

  // VDOT card
  const bestVdot = findBestVdot();
  renderVdotCard(bestVdot);
}

init();
</script>
</body>
</html>
