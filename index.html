<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>SUB3 LAB</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #222222;
    --accent: #e8ff00;
    --accent2: #ff4444;
    --accent3: #4488ff;
    --text: #f0f0f0;
    --text-muted: #666666;
    --text-dim: #333333;
    --green: #4dc84d;
    --orange: #ff8c00;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
    padding-bottom: 70px;
  }

  header {
    position: sticky;
    top: 0;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 4px; color: var(--accent); }
  .logo span { color: var(--text-muted); }

  .page { display: none; }
  .page.active { display: block; }

  /* BOTTOM NAV */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    display: flex;
    height: 60px;
    z-index: 100;
  }

  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.2s;
    font-size: 10px;
    outline: none;
    -webkit-tap-highlight-color: transparent;
  }

  .nav-item.active { color: var(--accent); }
  .nav-icon { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; }
  .nav-icon svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 1.6; stroke-linecap: round; stroke-linejoin: round; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #222;
    color: var(--text);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 13px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 200;
    white-space: nowrap;
    display: flex;
    align-items: center;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* SECTIONS */
  .section { padding: 16px; }
  .section + .section { padding-top: 0; }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--text-muted);
  }

  .section-action {
    background: none;
    border: 1px solid var(--border);
    color: var(--accent);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 2px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
  }

  /* HOME: VDOT CARD */
  .vdot-card {
    background: var(--surface);
    margin: 16px;
    border-radius: 4px;
    padding: 20px;
    border: 1px solid var(--border);
  }

  .vdot-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }

  .vdot-main .label { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; margin-bottom: 4px; }
  .vdot-main .number { font-family: 'Bebas Neue', sans-serif; font-size: 72px; line-height: 1; color: var(--accent); }
  .vdot-main .base { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

  .sub3-target { text-align: right; }
  .t-label { font-size: 10px; color: var(--text-muted); }
  .t-gap { font-family: 'Bebas Neue', sans-serif; font-size: 48px; line-height: 1; color: var(--accent2); }
  .t-unit { font-size: 10px; color: var(--text-muted); }

  .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 6px; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #4488ff, #e8ff00); border-radius: 2px; transition: width 0.5s; }
  .progress-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 16px; }
  .progress-labels .goal { color: var(--accent); }

  .pace-zones { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; }
  .pace-zone {
    flex-shrink: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 10px;
    text-align: center;
    min-width: 70px;
  }
  .pace-zone.highlight { border-color: var(--accent); }
  .pz-label { font-size: 9px; color: var(--text-muted); margin-bottom: 4px; }
  .pz-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }

  /* VITAL CARD */
  .vital-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    padding: 14px 16px;
  }
  .vital-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .vital-card-label { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; }
  .vital-inputs { display: flex; gap: 10px; align-items: flex-end; }
  .vital-field { flex: 1; }
  .vital-field-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
  .vital-input {
    width: 100%; padding: 10px 12px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text); font-size: 16px;
    font-family: 'JetBrains Mono', monospace; outline: none;
    -webkit-appearance: none;
  }
  .vital-btn {
    padding: 10px 16px; background: var(--accent); color: #000;
    border: none; border-radius: 4px; font-weight: 700; font-size: 12px;
    cursor: pointer; white-space: nowrap; flex-shrink: 0; height: 42px;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .vital-zones { font-size: 10px; color: var(--text-muted); margin-top: 8px; line-height: 1.6; }

  /* HOME: GAP ANALYSIS */
  .gap-analysis-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .gap-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
  }
  .gap-item:last-child { border-bottom: none; }
  .gap-rank {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    line-height: 1;
    color: var(--accent);
    min-width: 28px;
    opacity: 0.5;
  }
  .gap-rank.rank-1 { opacity: 1; color: var(--accent); }
  .gap-rank.rank-2 { opacity: 0.7; }
  .gap-body { flex: 1; }
  .gap-title { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
  .gap-desc { font-size: 11px; color: var(--text-muted); line-height: 1.6; }
  .gap-action { font-size: 10px; color: var(--accent); margin-top: 4px; }

  /* HOME: MISSION CARD */
  .mission-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .mission-header {
    background: var(--surface2);
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .mission-header-title { font-size: 11px; letter-spacing: 2px; color: var(--text-muted); font-family: 'Bebas Neue', sans-serif; }
  .mission-phase { font-size: 10px; color: var(--accent); background: rgba(232,255,0,0.1); padding: 2px 8px; border-radius: 2px; }

  .mission-item {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .mission-item:last-child { border-bottom: none; }
  .mission-item:active { background: var(--surface2); }
  .mission-item.done { opacity: 0.4; }

  .mission-day {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    line-height: 1;
    color: var(--text-dim);
    letter-spacing: 0.5px;
  }
  .mission-day.today { color: var(--accent); }
  .mission-day.past { color: var(--text-dim); opacity: 0.5; }

  .mission-body { flex: 1; }
  .mission-type { font-size: 11px; font-weight: 700; margin-bottom: 3px; }
  .mission-detail { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
  .mission-key { color: var(--accent); font-size: 10px; margin-top: 4px; }
  .mission-pass, .mission-fail {
    font-size: 10px; line-height: 1.5; margin-top: 5px; padding: 5px 8px;
    border-radius: 4px; display: flex; gap: 6px; align-items: flex-start;
  }
  .mission-pass { background: rgba(100,200,100,0.08); color: #7dcf7d; border-left: 2px solid #4a9a4a; }
  .mission-fail { background: rgba(255,100,80,0.07); color: #cc7766; border-left: 2px solid #994433; }
  .mission-pass-label { font-weight:700; white-space:nowrap; font-size:9px; padding-top:1px; color:#5ab85a; }
  .mission-fail-label { font-weight:700; white-space:nowrap; font-size:9px; padding-top:1px; color:#cc6655; }

  .mission-check {
    width: 22px;
    height: 22px;
    border: 1.5px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
    font-size: 12px;
  }
  .mission-check.checked { border-color: var(--green); color: var(--green); background: rgba(0,200,100,0.1); }
  .mission-item.done .mission-body { text-decoration: line-through; color: var(--text-dim); }
  .mission-actions {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    justify-content: flex-end;
  }
  .mission-edit-btn {
    background: none; border: none; color: var(--text-dim);
    cursor: pointer; padding: 2px 4px; flex-shrink: 0;
    opacity: 0.5; transition: opacity 0.2s; display: flex; align-items: center;
    width: 22px; height: 22px; justify-content: center;
  }
  .mission-edit-btn:active { opacity: 1; }
  .mission-edit-btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }

  .mission-day-block { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; min-width: 44px; gap: 2px; }
  .mission-date { font-family: 'Bebas Neue', sans-serif; font-size: 22px; line-height: 1; color: var(--text-muted); }
  .mission-date.today { color: var(--accent); }
  .mission-date.past { color: var(--text-dim); opacity: 0.5; }
  .mission-drag-handle {
    background: none; border: none; color: var(--text-dim);
    cursor: grab; padding: 2px 4px; flex-shrink: 0; opacity: 0.4;
    display: flex; align-items: center; touch-action: none;
  }
  .mission-drag-handle:active { cursor: grabbing; opacity: 0.8; }
  .mission-drag-handle svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }
  .mission-item.dragging { opacity: 0.4; background: var(--surface2); }
  .mission-item.drag-over { border-top: 2px solid var(--accent); }

  /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .edit-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
    display: flex; align-items: flex-end; justify-content: center;
  }
  .edit-modal {
    background: var(--surface); border-radius: 20px 20px 0 0;
    padding: 24px; width: 100%; max-width: 480px;
    border-top: 1px solid var(--border);
  }
  .edit-modal h3 { font-size: 14px; color: var(--accent); margin-bottom: 16px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
  .edit-field { margin-bottom: 12px; }
  .edit-field label { display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 1px; text-transform: uppercase; }
  .edit-field input, .edit-field select, .edit-field textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px; padding: 10px 12px; font-size: 13px;
    box-sizing: border-box;
  }
  .edit-field textarea { height: 60px; resize: none; font-family: inherit; }
  .edit-modal-btns { display: flex; gap: 8px; margin-top: 16px; }
  .edit-modal-btns button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 13px; font-weight: 700; cursor: pointer; }
  .btn-save-edit { background: var(--accent); color: #000; }
  .btn-cancel-edit { background: var(--surface2); color: var(--text); }

  .mission-generate {
    padding: 16px;
    text-align: center;
  }

  .btn-generate {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    letter-spacing: 1px;
  }

  .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

  .mission-loading {
    padding: 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
  }

  /* HOME: COACH ANALYSIS */
  .coach-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    padding: 16px;
  }

  .coach-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .coach-avatar { width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .coach-avatar svg { width: 20px; height: 20px; stroke: #000; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  .coach-name { font-size: 13px; font-weight: 700; }
  .coach-sub { font-size: 11px; color: var(--text-muted); }

  .coach-message {
    font-size: 13px;
    line-height: 1.8;
    color: var(--text);
    border-left: 2px solid var(--accent);
    padding-left: 12px;
  }

  /* LOG PAGE */
  .import-zone {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 20px 16px;
    text-align: center;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .import-zone.has-data { padding: 12px 16px; }
  .import-zone:hover, .import-zone.drag-over { border-color: var(--accent); }
  .import-zone .iz-icon { font-size: 28px; margin-bottom: 6px; color: var(--text-muted); display:flex;align-items:center;justify-content:center; }
  .import-zone.has-data .iz-icon { font-size: 20px; margin: 0; }
  .import-zone .iz-icon svg { stroke: var(--text-muted); }
  .import-zone .iz-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .import-zone.has-data .iz-title { font-size: 12px; margin: 0; color: var(--text-muted); }
  .import-zone .iz-sub { font-size: 11px; color: var(--text-muted); line-height: 1.7; }
  .import-zone.has-data .iz-sub { display: none; }

  .import-result {
    background: rgba(77,200,77,0.1);
    border: 1px solid var(--green);
    border-radius: 4px;
    padding: 10px 16px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--green);
    display: none;
  }

  .log-list { }

  .log-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    gap: 12px;
    transition: opacity 0.2s;
  }
  .log-item:active { opacity: 0.7; }

  .log-date { min-width: 44px; text-align: center; }
  .log-date .ld-day { font-family: 'Bebas Neue', sans-serif; font-size: 22px; line-height: 1; color: var(--text-muted); }
  .log-date .ld-dow { font-size: 10px; color: var(--text-dim); }

  .log-body { flex: 1; min-width: 0; }
  .log-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
  .log-meta { font-size: 12px; color: var(--text-muted); }

  .log-vdot { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent); min-width: 40px; text-align: right; }

  .type-badge {
    display: inline-block;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 2px;
    margin-right: 6px;
    letter-spacing: 1px;
  }
  .type-easy { background: #1a3a1a; color: var(--green); }
  .type-long { background: #1a2a3a; color: var(--accent3); }
  .type-tempo { background: #3a2a1a; color: var(--orange); }
  .type-interval { background: #3a1a1a; color: var(--accent2); }
  .type-race { background: #2a1a3a; color: #cc88ff; }

  /* RECORD PAGE */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 1px; }
  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px;
    font-size: 14px;
    border-radius: 4px;
    font-family: 'Noto Sans JP', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .btn-primary {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px;
    font-size: 14px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    margin-top: 8px;
  }

  /* STATS PAGE */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    text-align: center;
  }

  .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
  .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--accent); line-height: 1; }
  .stat-unit { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .chart-title { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 2px; }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.active { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    border-radius: 12px 12px 0 0;
    padding: 20px 20px 40px;
    transform: translateY(100%);
    transition: transform 0.3s;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-overlay.active .modal { transform: translateY(0); }

  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
  .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

  .modal-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
  .m-card { background: var(--surface2); border-radius: 4px; padding: 10px; text-align: center; }
  .ml { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
  .mv { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; }

  .coach-response { font-size: 13px; line-height: 1.8; color: var(--text); border-left: 2px solid var(--accent); padding-left: 12px; margin-bottom: 16px; }

  .btn-share {
    width: 100%;
    background: #000;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    margin-bottom: 8px;
  }

  .btn-close-modal {
    width: 100%;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
  }

  /* LOADING DOTS */
  .loading { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 13px; }
  .dots { display: flex; gap: 4px; }
  .dots span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: dot 1.2s infinite; }
  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dot { 0%,80%,100%{opacity:0.2} 40%{opacity:1} }

  /* COACH PAGE */
  .quick-btn {
    padding: 8px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text);
    font-size: 11px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    white-space: nowrap;
    transition: border-color 0.2s;
  }
  .quick-btn:hover { border-color: var(--accent); }

  .chat-bubble {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.8;
    max-width: 92%;
  }
  .chat-bubble p { margin: 0; }
  .chat-user { background: var(--surface2); align-self: flex-end; color: var(--text); }
  .chat-coach { background: #0d1a0d; border: 1px solid #1a3a1a; align-self: flex-start; color: var(--text); }
  .chat-coach strong { color: var(--accent); }

  /* ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—ã‚²ãƒ¼ã‚¸ */
  .phase-gauge-section {
    margin: 0 16px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .phase-gauge-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .phase-gauge-label {
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    text-transform: uppercase;
  }
  .phase-gauge-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    transition: color 0.5s, text-shadow 0.5s;
  }
  .phase-gauge-title.glowing {
    color: var(--accent);
    text-shadow: 0 0 12px rgba(232,255,0,0.8), 0 0 24px rgba(232,255,0,0.4);
  }
  .phase-gauge-count {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }
  .phase-gauge-bar {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  .phase-gauge-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #4488ff, var(--accent));
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    position: relative;
  }
  .phase-gauge-fill::after {
    content: '';
    position: absolute;
    right: 0; top: 0;
    height: 100%; width: 20px;
    background: rgba(255,255,255,0.4);
    animation: gauge-shine 2s ease-in-out infinite;
    border-radius: 3px;
  }
  @keyframes gauge-shine {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }
  .phase-gauge-dots {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  .phase-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid var(--border);
    transition: background 0.3s, box-shadow 0.3s;
    flex-shrink: 0;
  }
  .phase-dot.done {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 0 6px rgba(232,255,0,0.6);
  }
  .phase-dot.today {
    background: #4488ff;
    border-color: #4488ff;
    animation: dot-pulse 1.5s ease-in-out infinite;
  }
  @keyframes dot-pulse {
    0%, 100% { box-shadow: 0 0 4px rgba(68,136,255,0.4); }
    50% { box-shadow: 0 0 12px rgba(68,136,255,0.9); }
  }

  /* ãƒªã‚«ãƒãƒªãƒ¼ææ¡ˆ */
  .recovery-card {
    margin: 0 16px 12px;
    background: rgba(255, 140, 0, 0.08);
    border: 1px solid rgba(255, 140, 0, 0.3);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .recovery-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .recovery-icon { font-size: 14px; }
  .recovery-label { font-size: 10px; letter-spacing: 0.1em; color: var(--orange); text-transform: uppercase; font-weight: 700; }
  .recovery-body { font-size: 12px; color: var(--text); line-height: 1.6; }
  .recovery-action { margin-top: 10px; display: flex; gap: 8px; }
  .btn-recovery { padding: 8px 14px; font-size: 11px; font-weight: 700; border: none; border-radius: 4px; cursor: pointer; background: var(--orange); color: #000; }
  .btn-recovery-skip { padding: 8px 14px; font-size: 11px; font-weight: 700; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; background: transparent; color: var(--text-muted); }

  /* BTN PROPHECY */
  .btn-prophecy {
    width: 100%;
    background: transparent;
    border: 1px solid rgba(255,68,68,0.4);
    color: var(--accent2);
    padding: 14px;
    font-size: 12px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    letter-spacing: 1px;
    transition: background 0.2s;
  }
  .btn-prophecy:hover { background: rgba(255,68,68,0.06); }

  /* PHASE GAUGE WRAP */
  .phase-gauge-wrap {
    margin: 0 16px 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    position: relative;
    overflow: hidden;
  }
  .phase-gauge-wrap.glowing::after {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(232,255,0,0.12) 0%, transparent 70%);
    pointer-events: none;
    animation: gaugeGlow 2s ease-in-out infinite alternate;
  }
  @keyframes gaugeGlow { from{opacity:0.4} to{opacity:1} }

  /* å…¨ç”»é¢ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
  .chat-fullscreen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .chat-fullscreen.active { transform: translateY(0); }
  .chat-fs-header {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    flex-shrink: 0; background: var(--surface);
  }
  .chat-fs-back {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; padding: 4px; display: flex; align-items: center;
  }
  .chat-fs-title { font-size: 13px; font-weight: 700; letter-spacing: 1px; flex: 1; }
  .chat-fs-subtitle { font-size: 10px; color: var(--text-muted); }
  .chat-fs-messages {
    flex: 1; overflow-y: auto; padding: 16px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .chat-fs-input-area {
    display: flex; border-top: 1px solid var(--border);
    background: var(--surface2); flex-shrink: 0;
    padding-bottom: max(env(safe-area-inset-bottom, 0px), 8px);
    position: sticky;
    bottom: 0;
  }
  .chat-fs-input-area textarea {
    flex: 1; padding: 14px 12px; background: var(--surface2);
    border: none; color: var(--text); font-size: 13px; outline: none;
    resize: none; height: 48px; max-height: 120px;
    line-height: 1.5; font-family: inherit;
  }
  .chat-fs-input-area button.send-btn {
    padding: 14px 20px; background: var(--accent); color: #000;
    border: none; font-weight: 700; font-size: 12px;
    cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  /* æ–¹é‡æ¡ç”¨ãƒœã‚¿ãƒ³ */
  .policy-adopt-bar {
    background: linear-gradient(135deg, rgba(232,255,0,0.12), rgba(232,255,0,0.04));
    border: 1px solid rgba(232,255,0,0.5);
    border-radius: 8px; padding: 12px 14px; margin: 8px 0;
    display: flex; align-items: center; gap: 8px;
  }
  .policy-adopt-bar button {
    padding: 8px 16px; background: var(--accent); color: #000;
    border: none; border-radius: 6px; font-size: 12px;
    font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .policy-adopt-bar .policy-hint {
    font-size: 11px; color: var(--text); line-height: 1.5; flex: 1;
  }

</style>
</head>

</head>
<body>

<header>
  <div class="logo">SUB3 <span>LAB</span></div>
</header>

<div class="toast" id="toast"></div>

<!-- API KEY MODAL -->
<div id="apiKeyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;padding:24px">
  <div style="background:#111;border:1px solid #333;border-radius:16px;padding:24px;width:100%;max-width:400px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:16px;font-weight:700">APIã‚­ãƒ¼ã‚’è¨­å®š</div><button onclick="hideApiKeyModal()" style="background:none;border:none;color:#888;font-size:22px;cursor:pointer;padding:0 4px;line-height:1">âœ•</button></div>
    <div style="font-size:12px;color:#888;margin-bottom:20px;line-height:1.8">
      AIã‚³ãƒ¼ãƒæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ Anthropic ã® APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>
      ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚<br><br>
      å–å¾—å…ˆ â†’ <span style="color:#e8ff00">console.anthropic.com</span>
    </div>
    <input id="apiKeyInput" type="password" placeholder="sk-ant-..." 
      style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #444;border-radius:8px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;margin-bottom:12px"
      onkeydown="if(event.key==='Enter')saveApiKey()">
    <button onclick="saveApiKey()" style="width:100%;padding:13px;background:#e8ff00;color:#000;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer">ä¿å­˜ã—ã¦ä½¿ã„å§‹ã‚ã‚‹</button>
    <div id="apiKeyError" style="font-size:11px;color:#ff4444;margin-top:8px;text-align:center"></div>
    <button onclick="hideApiKeyModal()" style="width:100%;padding:10px;background:none;color:#666;border:none;font-size:12px;cursor:pointer;margin-top:4px">ä»Šã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAIã‚³ãƒ¼ãƒã¯ä½¿ãˆã¾ã›ã‚“ï¼‰</button>
  </div>
</div>

<!-- PAGE: HOME -->
<div class="page active" id="page-home">

  <!-- VDOT CARD -->
  <div class="vdot-card">
    <div class="vdot-top">
      <div class="vdot-main">
        <div class="label" id="vdotLabel">CURRENT VDOT</div>
        <div class="number" id="currentVdot">â€”</div>
        <div class="base" id="vdotBase">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="vdotRaceChange" style="font-size:10px;margin-top:2px;font-family:'JetBrains Mono',monospace;"></div>
      </div>
      <div class="sub3-target">
        <div class="t-label">ã‚ã¨</div>
        <div class="t-gap" id="vdotGap">â€”</div>
        <div class="t-unit">VDOT pts</div>
      </div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-labels"><span>30</span><span class="goal">SUB3 = VDOT 53</span></div>
    <div class="pace-zones" id="paceZones"></div>
  </div>


  <!-- VITAL INPUT CARD -->
  <div style="background:var(--surface);border-radius:4px;border:1px solid var(--border);padding:14px 16px;margin:0 16px 16px;" id="vitalCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;">TODAY'S VITALS</div>
      <div id="vitalLastDate" style="font-size:10px;color:var(--text-dim)"></div>
    </div>
    <div style="display:flex;gap:10px;align-items:flex-end;">
      <div style="flex:1;">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">ä½“é‡ (kg)</div>
        <input type="number" id="vitalWeight" step="0.1" placeholder="62.5"
          style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:16px;font-family:'JetBrains Mono',monospace;outline:none;box-sizing:border-box;">
      </div>
      <div style="flex:1;">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">å®‰é™æ™‚å¿ƒæ‹ (bpm)</div>
        <input type="number" id="vitalHRRest" placeholder="48"
          style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:16px;font-family:'JetBrains Mono',monospace;outline:none;box-sizing:border-box;">
      </div>
      <button onclick="submitVital()" style="padding:10px 16px;background:var(--accent);color:#000;border:none;border-radius:4px;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap;flex-shrink:0;height:42px;">è¨˜éŒ²</button>
    </div>
    <div id="vitalZoneInfo" style="font-size:10px;color:var(--text-dim);margin-top:8px;line-height:1.6;"></div>
  </div>



  <!-- ãƒªã‚«ãƒãƒªãƒ¼ææ¡ˆ -->
  <div class="recovery-card" id="recoveryCard" style="display:none">
    <div class="recovery-header">
      <span class="recovery-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
      <span class="recovery-label">RECOVERY ALERT</span>
    </div>
    <div class="recovery-body" id="recoveryBody">åˆ†æä¸­...</div>
    <div class="recovery-action">
      <button class="btn-recovery" onclick="applyRecoveryPlan()">ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°</button>
      <button class="btn-recovery-skip" onclick="dismissRecovery()">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>

  <!-- GAP ANALYSIS -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">GAP ANALYSIS</div>
      <div id="gapAnalysisUpdated" style="font-size:10px;color:var(--text-dim)"></div>
    </div>
  </div>

  <div class="gap-analysis-card" id="gapAnalysisCard">
    <div style="padding:20px;text-align:center;color:var(--text-dim);font-size:12px">
      ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã¨ã‚®ãƒ£ãƒƒãƒ—åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
  </div>



  <!-- WEEKLY MISSION -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
      <button class="section-action" onclick="generateWeeklyMission()">æ›´æ–°</button>
    </div>
  </div>

  <div class="mission-card" id="missionCard">
    <div class="mission-generate">
      <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™</p>
      <button class="btn-generate" id="generateBtn" onclick="generateWeeklyMission()">ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>
  </div>

</div>

</div>

<!-- PAGE: LOG -->
<div class="page" id="page-log">
  <div style="padding: 16px 16px 0;">
    <div class="import-zone" id="importZone"
      onclick="document.getElementById('fileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleFileDrop(event)">
      <div class="iz-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
      <div class="iz-title">FIT / CSV ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      <div class="iz-sub">FITè¤‡æ•°ãƒ»ZIPã‚‚å¯¾å¿œ / Stravaã®CSVã‚‚å¯<br>Coros Training Hub â†’ Export Data â†’ FIT</div>
    </div>
    <input type="file" id="fileInput" accept=".fit,.csv,.zip,*/*" multiple style="display:none" onchange="handleFileSelectMulti(this.files)">
    <div class="import-result" id="importResult" style="display:none"></div>
    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆé€²æ— -->
    <div id="importProgress" style="display:none;margin-top:10px;background:var(--surface);border-radius:8px;padding:12px;font-size:12px">
      <div id="importProgressText" style="color:var(--text-muted);margin-bottom:6px">å‡¦ç†ä¸­...</div>
      <div style="background:var(--border);border-radius:4px;height:4px">
        <div id="importProgressBar" style="background:var(--accent);height:4px;border-radius:4px;width:0%;transition:width 0.2s"></div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ç·´ç¿’ãƒ­ã‚°</div>
      <span id="logCount" style="font-size:11px;color:var(--text-muted);"></span>
    </div>
    <div class="log-list" id="logList"></div>
  </div>
</div>

<!-- PAGE: COACH -->
<div class="page" id="page-coach">
  <div style="padding: 16px;">

    <!-- ã‚³ãƒ¼ãƒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
    <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        <div style="width:48px;height:48px;border-radius:12px;background:var(--accent);border:none;display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/><polyline points="16 11 17.5 13 20 10"/></svg></div>
        <div>
          <div style="font-size:13px;font-weight:700;letter-spacing:1px">RENATO CANOVA</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:2px">å…ƒã‚±ãƒ‹ã‚¢ãƒ»ã‚¨ãƒã‚ªãƒ”ã‚¢ä»£è¡¨ã‚³ãƒ¼ãƒ / ä¸–ç•Œè¨˜éŒ²ä¿æŒè€…ã‚’å¤šæ•°è‚²æˆ</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div style="font-size:11px;color:var(--text-muted);line-height:1.7">
          <span style="color:var(--accent);font-weight:700">ã‚«ãƒãƒ¼ãƒç†è«–ã®æ ¸å¿ƒï¼š</span>ãƒãƒ©ã‚½ãƒ³ã¯ã€Œé–¾å€¤ãƒšãƒ¼ã‚¹ã®å»¶é•·ã€ã§æ”»ç•¥ã™ã‚‹ã€‚é€±ã®ç·´ç¿’ã®<span style="color:var(--accent)">25ã€œ35%ã‚’é–¾å€¤èµ°ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</span>ã«å……ã¦ã€æ®‹ã‚Šã‚’Easyã¨Longã§æ”¯ãˆã‚‹ã€‚VDOT40â†’53ã«ã¯ä¹³é…¸é–¾å€¤ã®åº•ä¸Šã’ãŒæœ€å„ªå…ˆèª²é¡Œã€‚
        </div>
        <div style="font-size:10px;color:var(--text-dim);border-top:1px solid var(--border);padding-top:8px;margin-top:2px;">
          ã“ã®AIã‚³ãƒ¼ãƒã¯ã‚«ãƒãƒ¼ãƒã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨å·å³¶ã•ã‚“ã®å…¨ãƒ­ã‚°ï¼ˆ76æœ¬ãƒ»562kmï¼‰ã‚’å…ƒã«å›ç­”ã—ã¾ã™
        </div>
      </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆç›¸è«‡ -->
    <div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:10px">COACH CONSULTATION</div>
      <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px;">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;line-height:1.6">ç·´ç¿’ãƒ»æ€ªæˆ‘ãƒ»æ¥é€±ã®åˆ¶ç´„ãƒ»ãƒ¬ãƒ¼ã‚¹æˆ¦ç•¥ãªã©ã€ä½•ã§ã‚‚ç›¸è«‡ã§ãã¾ã™</div>
        <!-- ç¾åœ¨ã®æ–¹é‡ãƒãƒƒã‚¸ -->
        <div id="coachPolicyBadge" style="display:none;margin-bottom:10px;padding:8px 10px;background:rgba(232,255,0,0.06);border:1px solid rgba(232,255,0,0.2);border-radius:6px;font-size:10px;color:var(--text-muted);">
          <span style="color:var(--accent);font-weight:700"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:3px"><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M9 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-3"/></svg> æ¡ç”¨ä¸­ã®æ–¹é‡</span>
          <span id="coachPolicyPreview"></span>
          <button onclick="clearCoachPolicy();renderCoachPolicyBadge();showToast('æ–¹é‡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ')" style="float:right;background:none;border:none;color:#666;cursor:pointer;font-size:11px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <button onclick="openChatFullscreen()" style="width:100%;padding:12px;background:var(--accent);color:#000;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          ã‚³ãƒ¼ãƒã«ç›¸è«‡ã™ã‚‹
        </button>
        <div id="chatLastMessage" style="display:none;margin-top:10px;font-size:11px;color:var(--text-muted);border-top:1px solid var(--border);padding-top:10px;cursor:pointer;" onclick="openChatFullscreen()"></div>
      </div>
      <div style="display:none"><div id="chatHistory"></div><textarea id="chatInput"></textarea></div>
    </div>

    <!-- ãƒªã‚«ãƒãƒªãƒ¼ææ¡ˆ -->
    <div id="recoveryProposalWrap" style="margin-bottom:16px;display:none;"></div>

    <!-- ä»Šé€±ã®è¨ˆç”»vså®Ÿç¸¾ã‚µãƒãƒªãƒ¼ -->
    <div style="margin-bottom:20px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:10px">PLAN vs ACTUAL</div>
      <div id="planActualSummary" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-size:12px;color:var(--text-dim);text-align:center;padding:16px;">
          ãƒ­ã‚°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨è‡ªå‹•ã§è¨ˆç”»ã¨ã®å·®åˆ†ã‚’åˆ†æã—ã¾ã™
        </div>
      </div>
    </div>

    <!-- ä»Šé€±ã‚’çµ„ã¿æ›¿ãˆã‚‹ãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom:20px">
      <button onclick="openRescheduleModal()" style="width:100%;padding:12px;background:var(--surface);color:var(--accent);border:1px solid var(--accent);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:1px">ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã¿æ›¿ãˆã‚‹</button>
    </div>

  </div>
</div>

<!-- PAGE: STATS -->
<div class="page" id="page-stats">
  <!-- ãƒ¬ãƒ¼ã‚¹å±•é–‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->

  <div style="padding:16px 16px 100px;">

    <!-- KPIã‚°ãƒªãƒƒãƒ‰ -->
    <div class="stats-grid" style="margin-bottom:16px;">
      <div class="stat-card">
        <div class="stat-label">VDOT <span style="font-size:9px;color:var(--text-dim)" id="vdotStatNote">å‚è€ƒå€¤</span></div>
        <div class="stat-val" id="totalDist" style="font-size:48px">â€”</div>
        <div class="stat-unit" id="vdotTrend" style="color:var(--accent)"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»Šæœˆã®è·é›¢</div>
        <div class="stat-val" id="monthDist">â€”</div>
        <div class="stat-unit">km <span id="monthTarget" style="font-size:9px;color:var(--text-dim)"></span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»Šæœˆã®ç·´ç¿’</div>
        <div class="stat-val" id="totalRuns">â€”</div>
        <div class="stat-unit">æœ¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">SUB3 ã¾ã§</div>
        <div class="stat-val" id="maxVdot" style="color:var(--accent2)">â€”</div>
        <div class="stat-unit">æ—¥</div>
      </div>
    </div>

    <!-- VDOTæ¨ç§» + ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ -->
    <div class="chart-card">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
        <div class="chart-title">VDOT å®šç‚¹è¦³æ¸¬ <span style="font-size:10px;color:var(--text-dim);font-weight:400;letter-spacing:0">RACEã‚¿ã‚°ã®ã¿</span></div>
        <div id="vdotPrediction" style="font-size:10px;color:var(--accent)"></div>
      </div>
      <canvas id="vdotChart" height="160"></canvas>
      <div id="vdotInsight" style="font-size:11px;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);line-height:1.7"></div>
    </div>

    <!-- ç·´ç¿’ã‚¿ã‚¤ãƒ—æ¯”ç‡ -->
    <div class="chart-card">
      <div class="chart-title" style="margin-bottom:12px;">ç·´ç¿’ã‚¿ã‚¤ãƒ—æ¯”ç‡ï¼ˆç›´è¿‘4é€±ï¼‰</div>
      <canvas id="typeChart" height="50"></canvas>
      <div id="typeChartLegend" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:4px;"></div>
      <div id="typeInsight" style="font-size:11px;color:var(--text-muted);margin-top:10px;line-height:1.7"></div>
    </div>

    <!-- é€±é–“è·é›¢ãƒˆãƒ¬ãƒ³ãƒ‰ -->
    <div class="chart-card">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
        <div class="chart-title">é€±é–“èµ°è¡Œè·é›¢</div>
        <div id="weeklyTarget" style="font-size:10px;color:var(--text-muted)">ç›®æ¨™: <span style="color:var(--accent)">60km</span>/é€±</div>
      </div>
      <canvas id="monthlyChart" height="110"></canvas>
    </div>


    <!-- ä½“é‡ãƒ»å®‰é™æ™‚å¿ƒæ‹ã‚°ãƒ©ãƒ• -->
    <div class="chart-card" id="vitalChartCard">
      <div class="chart-title" style="margin-bottom:12px;">èº«ä½“ãƒ‡ãƒ¼ã‚¿æ¨ç§»</div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="vitalTabWeight" onclick="switchVitalTab('weight')"
          style="flex:1;padding:7px;background:var(--accent);color:#000;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">ä½“é‡</button>
        <button id="vitalTabHR" onclick="switchVitalTab('hr')"
          style="flex:1;padding:7px;background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);border-radius:6px;font-size:11px;cursor:pointer;">å®‰é™æ™‚å¿ƒæ‹</button>
      </div>
      <canvas id="vitalChart" height="130"></canvas>
      <div id="vitalChartInsight" style="font-size:11px;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);line-height:1.7"></div>
    </div>

    <!-- DATA BACKUP / API SETTINGS -->
    <div style="margin-top:8px;">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:12px">DATA BACKUP</div>
      <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:14px;line-height:1.7">
          âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="exportBackup()" style="flex:1;padding:12px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
          <button onclick="document.getElementById('restoreInput').click()" style="flex:1;padding:12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer">å¾©å…ƒ</button>
          <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="importBackup(this.files[0])">
        </div>
        <div id="backupStatus" style="font-size:11px;color:var(--text-muted);margin-top:10px;text-align:center"></div>
      </div>
    </div>
    <div style="margin-top:16px;margin-bottom:24px;">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:12px">AI COACH SETTINGS</div>
      <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">APIã‚­ãƒ¼è¨­å®šçŠ¶æ³ï¼š<span id="apiKeyStatus" style="color:var(--accent)">ç¢ºèªä¸­...</span></div>
        <button onclick="showApiKeyModal()" style="width:100%;padding:12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer">APIã‚­ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹</button>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('home', this)">
    <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M3 12L12 3l9 9"/><path d="M9 21V12h6v9"/><path d="M3 12v9h18v-9"/></svg></span>
    <span style="font-size:10px;letter-spacing:.5px;">HOME</span>
  </button>
  <button class="nav-item" onclick="showPage('coach', this)">
    <span class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/><path d="M17 11l1.5 1.5L21 10"/></svg></span>
    <span style="font-size:10px;letter-spacing:.5px;">COACH</span>
  </button>
  <button class="nav-item" onclick="showPage('stats', this)">
    <span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="7" width="4" height="14" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg></span>
    <span style="font-size:10px;letter-spacing:.5px;">STATS</span>
  </button>
  <button class="nav-item" onclick="showPage('log', this)">
    <span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="5" y="3" width="14" height="18" rx="2"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg></span>
    <span style="font-size:10px;letter-spacing:.5px;">LOG</span>
  </button>
</nav>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal" onclick="closeDetailModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailTitle">ç·´ç¿’è©³ç´°</div>
    <div class="modal-metrics" id="detailMetrics"></div>
    <div class="coach-response" id="detailCoach">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> AIã‚³ãƒ¼ãƒãŒåˆ†æä¸­...</div>
    </div>
    <button class="btn-share" onclick="shareToX()">ğ• ã§ã‚·ã‚§ã‚¢</button>
    <button class="btn-close-modal" onclick="document.getElementById('detailModal').classList.remove('active')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const CONFIG = {
  targetVdot: 53,
  targetRace: 'ã¤ãã°ãƒãƒ©ã‚½ãƒ³2026',
  targetDate: '2026-11-22',
  athleteName: 'å·å³¶å¤§è¼',
  weeklyDays: 5,
  // ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©
  phases: [
    { name: 'Phase1', label: 'é–¾å€¤å¼·åŒ–', end: '2026-04-30', goal: '4\'30"/kmã§ãƒãƒ¼ãƒ•ã‚’èµ°ã‚‹', color: '#4488ff' },
    { name: 'Phase2', label: 'ãƒãƒ©ã‚½ãƒ³ç‰¹ç•°çš„æŒä¹…åŠ›', end: '2026-07-31', goal: '4\'15"/kmã§30kmèµ°ã‚‹', color: '#e8ff00' },
    { name: 'Phase3', label: 'ãƒ¬ãƒ¼ã‚¹ä»•ä¸Šã’', end: '2026-11-22', goal: 'ã¤ãã°ã‚µãƒ–ã‚¹ãƒªãƒ¼é”æˆ', color: '#ff4444' },
  ]
};

// ===== UTILS =====
function calcVDOT(distKm, timeSec) {
  if (!distKm || !timeSec || distKm < 3) return null;
  const speedMperMin = (distKm * 1000) / (timeSec / 60);
  const vo2 = -4.60 + 0.182258 * speedMperMin + 0.000104 * Math.pow(speedMperMin, 2);
  const pct = 0.8 + 0.1894393 * Math.exp(-0.012778 * (timeSec/60)) + 0.2989558 * Math.exp(-0.1932605 * (timeSec/60));
  const vdot = Math.round(vo2 / pct);
  return vdot > 20 && vdot < 90 ? vdot : null;
}

function getPaceZones(vdot) {
  // Jack Daniels VDOTãƒ†ãƒ¼ãƒ–ãƒ«
  const table = {
    38: { easy:'6\'42"', marathon:'5\'45"', threshold:'5\'13"', interval:'4\'51"', rep:'4\'31"' },
    39: { easy:'6\'37"', marathon:'5\'40"', threshold:'5\'08"', interval:'4\'47"', rep:'4\'27"' },
    40: { easy:'6\'32"', marathon:'5\'36"', threshold:'5\'05"', interval:'4\'44"', rep:'4\'24"' },
    41: { easy:'6\'27"', marathon:'5\'31"', threshold:'5\'01"', interval:'4\'40"', rep:'4\'21"' },
    42: { easy:'6\'22"', marathon:'5\'27"', threshold:'4\'57"', interval:'4\'37"', rep:'4\'18"' },
    43: { easy:'6\'17"', marathon:'5\'23"', threshold:'4\'53"', interval:'4\'33"', rep:'4\'14"' },
    44: { easy:'6\'12"', marathon:'5\'18"', threshold:'4\'49"', interval:'4\'30"', rep:'4\'11"' },
    45: { easy:'6\'08"', marathon:'5\'15"', threshold:'4\'46"', interval:'4\'27"', rep:'4\'08"' },
    46: { easy:'6\'03"', marathon:'5\'11"', threshold:'4\'42"', interval:'4\'23"', rep:'4\'05"' },
    47: { easy:'5\'59"', marathon:'5\'07"', threshold:'4\'39"', interval:'4\'20"', rep:'4\'02"' },
    48: { easy:'5\'55"', marathon:'5\'03"', threshold:'4\'35"', interval:'4\'17"', rep:'3\'59"' },
    49: { easy:'5\'51"', marathon:'4\'59"', threshold:'4\'32"', interval:'4\'14"', rep:'3\'57"' },
    50: { easy:'5\'47"', marathon:'4\'56"', threshold:'4\'28"', interval:'4\'11"', rep:'3\'54"' },
    53: { easy:'5\'36"', marathon:'4\'46"', threshold:'4\'20"', interval:'4\'03"', rep:'3\'46"' },
  };
  const keys = Object.keys(table).map(Number).sort((a,b) => a-b);
  let best = keys[0];
  for (const k of keys) { if (k <= vdot) best = k; }
  return table[best] || table[40];
}

function formatPace(distKm, timeSec) {
  if (!distKm || !timeSec) return 'â€”';
  const paceTotal = timeSec / distKm;
  const min = Math.floor(paceTotal / 60);
  const sec = Math.round(paceTotal % 60);
  return `${min}'${String(sec).padStart(2,'0')}"`;
}

function parseDuration(str) {
  if (!str) return 0;
  const parts = String(str).split(':').map(Number);
  if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
  if (parts.length === 2) return parts[0]*60 + parts[1];
  return parseInt(str) || 0;
}

function formatDuration(sec) {
  sec = Math.round(sec);
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function getCurrentPhase() {
  const today = new Date();
  for (const p of CONFIG.phases) {
    if (today <= new Date(p.end)) return p;
  }
  return CONFIG.phases[CONFIG.phases.length - 1];
}

function getTypeLabel(type) {
  const labels = { easy:'Easyèµ°', long:'ãƒ­ãƒ³ã‚°èµ°', tempo:'é–¾å€¤èµ°', interval:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', rep:'ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³', race:'ãƒ¬ãƒ¼ã‚¹' };
  return labels[type] || type || 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°';
}

function classifyRunByPace(distKm, timeSec) {
  if (!distKm || !timeSec) return 'easy';
  const paceSecPerKm = timeSec / distKm;
  if (distKm >= 28) return 'long';
  if (paceSecPerKm < 265) return 'interval'; // 4'25"/kmä»¥ä¸‹
  if (paceSecPerKm < 295) return 'tempo';    // 4'55"/kmä»¥ä¸‹
  if (distKm >= 18) return 'long';
  return 'easy';
}

// ===== LOCAL STORAGE =====

// ===== VITAL LOG =====
function saveVital(weight, hrRest) {
  const vitals = getVitals();
  const today = new Date().toISOString().slice(0, 10);
  // åŒæ—¥ãŒã‚ã‚Œã°ä¸Šæ›¸ã
  const idx = vitals.findIndex(v => v.date === today);
  const entry = { date: today, weight: parseFloat(weight) || null, hrRest: parseInt(hrRest) || null };
  if (idx >= 0) vitals[idx] = entry;
  else vitals.push(entry);
  vitals.sort((a, b) => a.date.localeCompare(b.date));
  localStorage.setItem('sub3_vitals', JSON.stringify(vitals));
  return entry;
}

function getVitals() {
  try { return JSON.parse(localStorage.getItem('sub3_vitals') || '[]'); } catch { return []; }
}

function getLatestVital() {
  const vitals = getVitals();
  if (!vitals.length) return null;
  return vitals[vitals.length - 1];
}

function getHRZones() {
  // Karvonenæ³•ã§ã‚¾ãƒ¼ãƒ³å¢ƒç•Œã‚’è¨ˆç®—
  const hrMax = 189; // 220 - 31æ­³
  const latest = getLatestVital();
  const hrRest = (latest && latest.hrRest) ? latest.hrRest : 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50
  const hrReserve = hrMax - hrRest;
  return {
    hrMax,
    hrRest,
    easy:     { min: Math.round(hrRest + hrReserve * 0.60), max: Math.round(hrRest + hrReserve * 0.75) },
    marathon: { min: Math.round(hrRest + hrReserve * 0.75), max: Math.round(hrRest + hrReserve * 0.84) },
    tempo:    { min: Math.round(hrRest + hrReserve * 0.84), max: Math.round(hrRest + hrReserve * 0.90) },
    interval: { min: Math.round(hrRest + hrReserve * 0.90), max: hrMax }
  };
}

function classifyRunByHeartrate(distKm, timeSec, avgHR) {
  const dist = parseFloat(distKm) || 0;
  // å¿ƒæ‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°Karvonenæ³•ã§åˆ†é¡
  if (avgHR && avgHR > 0) {
    const zones = getHRZones();
    if (avgHR >= zones.interval.min) return 'interval';
    if (avgHR >= zones.tempo.min)    return 'tempo';
    if (avgHR >= zones.marathon.min) return dist >= 18 ? 'long' : 'easy';
    return dist >= 18 ? 'long' : 'easy';
  }
  // å¿ƒæ‹ãªã— â†’ ãƒšãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ï¼ˆå¾“æ¥é€šã‚Šï¼‰
  return classifyRunByPace(dist, timeSec);
}

function getLogs() {
  try { return JSON.parse(localStorage.getItem('sub3_logs') || '[]'); } catch { return []; }
}
function saveLogs(logs) { localStorage.setItem('sub3_logs', JSON.stringify(logs)); }
function addLog(log) {
  const logs = getLogs();
  log.id = Date.now();
  logs.unshift(log);
  saveLogs(logs);
  autoCompleteMissionForLog(log);
  return log;
}

function autoCompleteMissionForLog(log) {
  const mission = getMission();
  if (!mission || !mission.missions) return;
  const date = new Date(log.date);
  if (isNaN(date)) return;
  const dowMap = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const logDow = dowMap[date.getDay()];
  const missionIdx = mission.missions.findIndex(m => m.day === logDow);
  if (missionIdx === -1) return;
  let doneState = {};
  try { doneState = JSON.parse(localStorage.getItem('sub3_mission_done') || '{}'); } catch {}
  if (doneState[missionIdx]) return;
  doneState[missionIdx] = true;
  localStorage.setItem('sub3_mission_done', JSON.stringify(doneState));
  const item = document.getElementById('mission-item-' + missionIdx);
  if (item) {
    item.classList.add('done');
    const check = item.querySelector('.mission-check');
    if (check) { check.classList.add('checked'); check.textContent = 'âœ“'; }
  }
}

// ===== ã‚³ãƒ¼ãƒãƒ³ã‚°æ–¹é‡ =====
function getCoachPolicy() {
  try { return JSON.parse(localStorage.getItem('sub3_coach_policy') || 'null'); } catch { return null; }
}
function saveCoachPolicy(policy) {
  localStorage.setItem('sub3_coach_policy', JSON.stringify(policy));
}
function clearCoachPolicy() {
  localStorage.removeItem('sub3_coach_policy');
}
function buildCoachPolicyContext() {
  const policy = getCoachPolicy();
  if (!policy || !policy.content) return '';
  return '\n\nã€ã‚³ãƒ¼ãƒã¨ã®åˆæ„æ¸ˆã¿æ–¹é‡ã€‘\n' + policy.content + '\nï¼ˆåˆæ„æ—¥ï¼š' + (policy.savedAt ? policy.savedAt.substring(0,10) : 'ä¸æ˜') + 'ï¼‰\nã“ã®æ–¹é‡ã‚’ä»Šé€±ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å¿…ãšåæ˜ ã™ã‚‹ã“ã¨ã€‚';
}

// ===== é€±æ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– =====
function getWeeklyArchives() {
  try { return JSON.parse(localStorage.getItem('sub3_weekly_archives') || '[]'); } catch { return []; }
}
function saveWeeklyArchives(a) { localStorage.setItem('sub3_weekly_archives', JSON.stringify(a)); }

function archiveCurrentWeek() {
  const mission = getMission();
  if (!mission || !mission.missions) return null;
  const weekStart = mission.generatedAt
    ? new Date(mission.generatedAt).toISOString().substring(0, 10)
    : new Date().toISOString().substring(0, 10);
  const archives = getWeeklyArchives();
  if (archives.find(a => a.weekStart === weekStart)) return null;
  let doneState = {};
  try { doneState = JSON.parse(localStorage.getItem('sub3_mission_done') || '{}'); } catch {}
  const logs = getLogs();
  const dowMap = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const missionResults = mission.missions.map((m, idx) => {
    const isDone = doneState[idx] || false;
    const matchedLog = logs.find(l => {
      const d = new Date(l.date);
      return dowMap[d.getDay()] === m.day && l.planAnalysis;
    });
    return {
      day: m.day, type: m.type, distance: m.distance, pace: m.pace, key: m.key,
      isDone,
      verdict: matchedLog?.planAnalysis?.verdict || (isDone ? 'ACHIEVED' : 'MISSED'),
      actual: matchedLog ? {
        dist: parseFloat(matchedLog.distKm),
        pace: formatPace(parseFloat(matchedLog.distKm), parseInt(matchedLog.moving_time))
      } : null
    };
  });
  const totalDone = missionResults.filter(m => m.verdict === 'ACHIEVED').length;
  const totalPartial = missionResults.filter(m => m.verdict === 'PARTIAL').length;
  const achieveRate = Math.round((totalDone + totalPartial * 0.5) / missionResults.length * 100);
  const archive = {
    weekStart, generatedAt: mission.generatedAt, diagnosis: mission.diagnosis || '',
    vdotAtStart: findBestVdot(), totalDone, totalPartial,
    totalMissed: missionResults.filter(m => m.verdict === 'MISSED').length,
    achieveRate, missions: missionResults
  };
  archives.unshift(archive);
  saveWeeklyArchives(archives.slice(0, 20));
  return archive;
}

function buildArchiveContext() {
  const archives = getWeeklyArchives().slice(0, 3);
  if (archives.length === 0) return '';
  let ctx = '\n\nã€éå»ã®é€±æ¬¡å®Ÿç¸¾ï¼ˆæŒ¯ã‚Šè¿”ã‚Šï¼‰ã€‘\n';
  archives.forEach(arc => {
    ctx += `
â–¼ ${arc.weekStart}é€±ï¼ˆé”æˆç‡${arc.achieveRate}%ï¼‰
`;
    arc.missions.forEach(m => {
      const vl = { ACHIEVED: 'âœ…é”æˆ', PARTIAL: 'â–³éƒ¨åˆ†', MISSED: 'âŒæœªé”' }[m.verdict] || 'â€”';
      const actual = m.actual ? ` â†’ å®Ÿç¸¾${m.actual.dist.toFixed(1)}km@${m.actual.pace}/km` : '';
      ctx += `  ${m.day} ${m.type}${m.distance} ${vl}${actual}
`;
    });
    if (arc.vdotAtStart) ctx += `  VDOT: ${arc.vdotAtStart}
`;
  });
  return ctx;
}

// ===== æ¥é€±ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ =====
function checkNextWeekReminder() {
  const now = new Date();
  const isSunday = now.getDay() === 0;
  const mission = getMission();
  if (mission && mission.generatedAt) {
    const generated = new Date(mission.generatedAt);
    const mondayOffset = now.getDay() === 0 ? -6 : 1 - now.getDay();
    const monday = new Date(now);
    monday.setDate(now.getDate() + mondayOffset);
    monday.setHours(0,0,0,0);
    const nextMonday = new Date(monday);
    nextMonday.setDate(monday.getDate() + 7);
    if (generated >= nextMonday) return;
  }
  if (!mission) updateMissionEmptyState(isSunday);
  if (isSunday) showNextWeekBanner();
}

function updateMissionEmptyState(isSunday) {
  const msgEl = document.getElementById('missionGenerateMsg');
  const btnEl = document.getElementById('generateBtn');
  if (!msgEl || !btnEl) return;
  if (isSunday) {
    msgEl.innerHTML = '<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:3px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ä»Šæ—¥ã¯æ—¥æ›œæ—¥ã§ã™ã€‚<br><span style="color:var(--accent);font-weight:700">æ¥é€±ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä»Šã®ã†ã¡ã«ä½œã‚Šã¾ã—ã‚‡ã†ï¼</span>';
    btnEl.textContent = 'æ¥é€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹';
  } else {
    msgEl.textContent = 'ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™';
    btnEl.textContent = 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹';
  }
}

function showNextWeekBanner() {
  if (document.getElementById('nextWeekBanner')) return;
  const dismissed = localStorage.getItem('nextWeekBannerDismissed');
  if (dismissed === new Date().toDateString()) return;
  const missionCard = document.getElementById('missionCard');
  if (!missionCard) return;
  const banner = document.createElement('div');
  banner.id = 'nextWeekBanner';
  banner.style.cssText = 'background:linear-gradient(135deg,rgba(232,255,0,0.08),rgba(232,255,0,0.03));border:1px solid rgba(232,255,0,0.3);border-radius:10px;padding:14px 16px;margin-bottom:12px;position:relative;';
  banner.innerHTML = `
    <button onclick="dismissNextWeekBanner()" style="position:absolute;top:8px;right:10px;background:none;border:none;color:#666;cursor:pointer;font-size:16px">Ã—</button>
    <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:6px"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:3px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> æ¥é€±ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œã‚Šã¾ã—ã‚‡ã†</div>
    <div style="font-size:11px;color:var(--text-muted);line-height:1.6;margin-bottom:10px">æ¥é€±ã®äºˆå®šï¼ˆä¼‘ã‚ã‚‹æ—¥ãƒ»é£²ã¿ä¼šãªã©ï¼‰ã‚’AIã«ä¼ãˆã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ãŠãã¨ã€æœˆæ›œã‹ã‚‰å³ã‚¹ã‚¿ãƒ¼ãƒˆã§ãã¾ã™ã€‚</div>
    <div style="display:flex;gap:8px;">
      <button onclick="openNextWeekChat()" style="flex:1;padding:8px;background:var(--accent);color:#000;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">æ¥é€±ã®åˆ¶ç´„ã‚’AIã«ä¼ãˆã‚‹</button>
      <button onclick="generateWeeklyMission()" style="flex:1;padding:8px;background:none;color:var(--accent);border:1px solid var(--accent);border-radius:6px;font-size:11px;cursor:pointer">åˆ¶ç´„ãªã—ã§ç”Ÿæˆ</button>
    </div>`;
  missionCard.parentNode.insertBefore(banner, missionCard);
}

function dismissNextWeekBanner() {
  const b = document.getElementById('nextWeekBanner');
  if (b) b.remove();
  localStorage.setItem('nextWeekBannerDismissed', new Date().toDateString());
}

function openNextWeekChat() {
  showPage('coach', document.querySelectorAll('.nav-item')[1]);
  setTimeout(() => openChatFullscreen('æ¥é€±ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œã‚ŠãŸã„ã€‚åˆ¶ç´„ã¯'), 200);
}

function getMission() {
  try { return JSON.parse(localStorage.getItem('sub3_mission') || 'null'); } catch { return null; }
}
function saveMission(m) { localStorage.setItem('sub3_mission', JSON.stringify(m)); }

// ===== UI =====
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'log') renderLogList();
  if (name === 'home') renderVitalCard();
  if (name === 'stats') renderStats();
  if (name === 'home') setTimeout(renderPhaseGauge, 100);
  if (name === 'home') checkHomeAutoUpdate();
  if (name === 'coach') {
    renderPlanActualSummary();
    checkAndSuggestRecovery();
    renderCoachPolicyBadge();
  }
}

function checkHomeAutoUpdate() {
  checkNextWeekReminder();
  const saved = getMission();
  if (!saved) return; // åˆå›ã¯æ‰‹å‹•ç”Ÿæˆã®ã¿
  // ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å³æ™‚è¡¨ç¤º
  renderMissionCard(saved);
  renderGapAnalysis(saved);

  // ç¿Œé€±ï¼ˆæœˆæ›œæ—¥ï¼‰ã«ãªã£ãŸã‚‰å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°
  const lastGen = saved.generatedAt ? new Date(saved.generatedAt) : null;
  const hoursSince = lastGen ? (Date.now() - lastGen) / 3600000 : 999;

  let shouldUpdate = hoursSince >= 24;

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒå‰ã®é€±ã®ã‚‚ã®ãªã‚‰å¼·åˆ¶æ›´æ–°ï¼ˆä»Šæ—¥ã®æœˆæ›œèµ·ç‚¹ã¨ä¿å­˜æ™‚ã®é€±ãŒé•ã†å ´åˆï¼‰
  if (lastGen && !shouldUpdate) {
    const now = new Date();
    const mondayOffset = now.getDay() === 0 ? -6 : 1 - now.getDay();
    const thisMonday = new Date(now);
    thisMonday.setDate(now.getDate() + mondayOffset);
    thisMonday.setHours(0, 0, 0, 0);
    if (lastGen < thisMonday) shouldUpdate = true; // å‰é€±ç”Ÿæˆãªã‚‰æ›´æ–°
  }

  if (shouldUpdate && getLogs().length > 0) {
    generateWeeklyMission();
  }
}

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  // âœ… ã‚’ SVGãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ç½®æ›ã—ã¦innerHTMLã§æç”»
  const cleaned = msg.replace(/^âœ…\s*/, '');
  const hadCheck = msg.startsWith('âœ…');
  if (hadCheck) {
    t.innerHTML = `<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;margin-right:5px;vertical-align:middle"><polyline points="20 6 9 17 4 12"/></svg>${cleaned}`;
  } else {
    t.textContent = msg;
  }
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ===== VDOT CARD =====
function renderVdotCard(vdot) {
  // VDOTã¯ãƒ¬ãƒ¼ã‚¹ãƒ»é«˜å¼·åº¦ã®ã¿ã€‚nullãªã‚‰ãƒ€ãƒƒã‚·ãƒ¥è¡¨ç¤º
  const display = vdot || findBestVdot();
  const isEstimate = !findBestVdot(); // ãƒ¬ãƒ¼ã‚¹ãƒ»TTãŒãªã„å ´åˆã¯æ¨å®š
  document.getElementById('currentVdot').textContent = display || 'â€”';
  document.getElementById('vdotGap').textContent = display ? Math.max(0, CONFIG.targetVdot - display) : 'â€”';
  const vdotLabel = document.getElementById('vdotLabel');
  if (vdotLabel) vdotLabel.textContent = isEstimate ? 'å‚è€ƒVDOTï¼ˆæ¨å®šï¼‰' : 'VDOT';
  const pct = Math.min(100, Math.max(0, (vdot - 30) / (CONFIG.targetVdot - 30) * 100));
  document.getElementById('progressFill').style.width = pct + '%';

  const zones = getPaceZones(vdot);
  document.getElementById('paceZones').innerHTML = `
    <div class="pace-zone"><div class="pz-label">EASY</div><div class="pz-val">${zones.easy}</div></div>
    <div class="pace-zone highlight"><div class="pz-label">MARATHON</div><div class="pz-val">${zones.marathon}</div></div>
    <div class="pace-zone highlight"><div class="pz-label">TEMPO</div><div class="pz-val">${zones.threshold}</div></div>
    <div class="pace-zone"><div class="pz-label">INTERVAL</div><div class="pz-val">${zones.interval}</div></div>
    <div class="pace-zone"><div class="pz-label">REP</div><div class="pz-val">${zones.rep}</div></div>
  `;

  // æœ€æ–°RACEãƒ­ã‚°ã‚’ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã¨ã—ã¦è¡¨ç¤º
  const latestRace = getLatestRaceLog();
  const baseEl = document.getElementById('vdotBase');
  if (latestRace) {
    const dist = parseFloat(latestRace.distKm) || 0;
    const timeSec = parseInt(latestRace.moving_time) || parseDuration(latestRace.duration);
    const raceDate = new Date(latestRace.date);
    const dateFmt = isNaN(raceDate) ? '' : raceDate.toLocaleDateString('ja-JP', {month:'short', day:'numeric'});
    const raceName = latestRace.name || `${dist.toFixed(1)}kmèµ°`;
    baseEl.textContent = `${dateFmt} ${raceName} (${dist.toFixed(1)}km @ ${formatPace(dist, timeSec)})`;
  } else {
    baseEl.textContent = 'RACEã‚¿ã‚°ã®ãƒ­ã‚°ã‹ã‚‰VDOTãŒè¨ˆç®—ã•ã‚Œã¾ã™';
  }

  // RACEãŒè¤‡æ•°ã‚ã‚Œã°å‰å›æ¯”ã‚’è¡¨ç¤º
  const races = getRaceLogs();
  const raceChangeEl = document.getElementById('vdotRaceChange');
  if (raceChangeEl && races.length >= 2) {
    const prev = races[races.length - 2];
    const curr = races[races.length - 1];
    const vPrev = calcVDOT(parseFloat(prev.distKm), parseInt(prev.moving_time) || 0);
    const vCurr = calcVDOT(parseFloat(curr.distKm), parseInt(curr.moving_time) || 0);
    if (vPrev && vCurr) {
      const diff = vCurr - vPrev;
      raceChangeEl.textContent = diff > 0 ? `â–² +${diff} å‰å›æ¯”` : diff < 0 ? `â–¼ ${diff} å‰å›æ¯”` : 'â”€â”€ å‰å›ã¨åŒå€¤';
      raceChangeEl.style.color = diff > 0 ? 'var(--accent)' : diff < 0 ? '#ff4444' : '#888';
    }
  } else if (raceChangeEl) {
    raceChangeEl.textContent = '';
  }
}

// ===== FIND BEST VDOT =====
function getRaceLogs() {
  // RACEã‚¿ã‚°ãŒä»˜ã„ãŸãƒ­ã‚°ã‚’æ—¥ä»˜æ˜‡é †ã§è¿”ã™
  return getLogs()
    .filter(l => l.runType === 'race' && parseFloat(l.distKm) >= 5)
    .sort((a, b) => new Date(a.date) - new Date(b.date));
}

function findBestVdot() {
  // æœ€æ–°RACEã®VDOTã‚’è¿”ã™ï¼ˆå®šç‚¹è¦³æ¸¬ã®æœ€æ–°å€¤ï¼‰
  const races = getRaceLogs();
  if (races.length === 0) return null;
  const latest = races[races.length - 1];
  const dist = parseFloat(latest.distKm) || 0;
  const timeSec = parseInt(latest.moving_time) || parseDuration(latest.duration);
  return calcVDOT(dist, timeSec) || null;
}

function findBestVdotWithFallback() {
  return findBestVdot() || 40;
}

function getLatestRaceLog() {
  const races = getRaceLogs();
  return races.length > 0 ? races[races.length - 1] : null;
}

// ===== WEEKLY MISSION GENERATION =====
async function generateWeeklyMission() {
  const logs = getLogs();
  if (logs.length === 0) {
    showToast('âš ï¸ ã¾ãšCSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„');
    return;
  }

  const btn = document.getElementById('generateBtn');
  if (btn) btn.disabled = true;

  document.getElementById('missionCard').innerHTML = `
    <div class="mission-loading">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆä¸­...</div>
    </div>`;

  // å…¨ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆã‚’è¨ˆç®—ã—ã¦AIã«æ¸¡ã™
  const currentVdot = findBestVdot();
  const phase = getCurrentPhase();

  // ç›´è¿‘4é€±é–“ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿
  const fourWeeksAgo = new Date();
  fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
  const recentLogs = logs.filter(l => new Date(l.date) >= fourWeeksAgo);

  // æœˆåˆ¥è·é›¢
  const monthly = {};
  logs.forEach(l => {
    const month = l.date?.substring(0, 7);
    if (month) monthly[month] = (monthly[month] || 0) + (parseFloat(l.distKm) || 0);
  });

  // ãƒšãƒ¼ã‚¹åˆ†å¸ƒ
  const paceAnalysis = logs.reduce((acc, l) => {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || 0;
    if (dist < 1 || timeSec < 60) return acc;
    const paceSecPerKm = timeSec / dist;
    if (paceSecPerKm < 265) acc.fast++;
    else if (paceSecPerKm < 295) acc.tempo++;
    else if (paceSecPerKm < 330) acc.marathon++;
    else acc.easy++;
    return acc;
  }, { fast: 0, tempo: 0, marathon: 0, easy: 0 });

  // ãƒ­ãƒ³ã‚°èµ°ãƒ‡ãƒ¼ã‚¿
  const longRuns = logs.filter(l => (parseFloat(l.distKm) || 0) >= 20)
    .map(l => `${parseFloat(l.distKm).toFixed(0)}km@${formatPace(parseFloat(l.distKm), parseInt(l.moving_time))}`);

  // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  const thisWeek = logs.filter(l => new Date(l.date) >= weekAgo);

  const recentLogLines = recentLogs.slice(0, 20).map(function(l) {
  const dist = parseFloat(l.distKm) || 0;
  const timeSec = parseInt(l.moving_time) || 0;
  return (l.date ? l.date.substring(5) : '') + ' ' + dist.toFixed(1) + 'km@' + formatPace(dist, timeSec) + ' HR' + (l.average_heartrate ? Math.round(l.average_heartrate) : '-');
}).join('\n');

const monthlyStr2 = Object.entries(monthly).sort().map(function(e){ return e[0] + ':' + e[1].toFixed(0) + 'km'; }).join(', ');

const dataContext = 'é¸æ‰‹ï¼šå·å³¶å¤§è¼ã€31æ­³\n'
  + 'ç¾åœ¨VDOTï¼š' + currentVdot + '\n'
  + 'ç›®æ¨™ï¼š' + CONFIG.targetRace + 'ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53ï¼‰\n'
  + 'ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºï¼š' + phase.name + ' ' + phase.label + 'ï¼ˆç›®æ¨™ï¼š' + phase.goal + 'ï¼‰\n'
  + 'é€±5æ—¥ç·´ç¿’å¯èƒ½\n\n'
  + 'ã€å…¨ç·´ç¿’ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆï¼ˆ' + logs.length + 'ä»¶ï¼‰ã€‘\n'
  + 'æœˆåˆ¥èµ°è¡Œè·é›¢ï¼š' + monthlyStr2 + '\n\n'
  + 'ãƒšãƒ¼ã‚¹åˆ†å¸ƒï¼š\n'
  + '- 4åˆ†25ç§’ä»¥ä¸‹ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰åŸŸï¼‰ï¼š' + paceAnalysis.fast + 'æœ¬\n'
  + '- 4åˆ†25ç§’-4åˆ†55ç§’ï¼ˆé–¾å€¤åŸŸï¼‰ï¼š' + paceAnalysis.tempo + 'æœ¬\n'
  + '- 4åˆ†55ç§’-5åˆ†30ç§’ï¼ˆãƒãƒ©ã‚½ãƒ³ãƒšãƒ¼ã‚¹åŸŸï¼‰ï¼š' + paceAnalysis.marathon + 'æœ¬\n'
  + '- 5åˆ†30ç§’ä»¥ä¸Šï¼ˆEasyåŸŸï¼‰ï¼š' + paceAnalysis.easy + 'æœ¬\n\n'
  + 'ãƒ­ãƒ³ã‚°èµ°å®Ÿç¸¾ï¼š' + longRuns.join(', ') + '\n\n'
  + 'ç›´è¿‘4é€±é–“ï¼ˆ' + recentLogs.length + 'æœ¬ï¼‰ï¼š\n'
  + recentLogLines + '\n\n'
  + 'ä»Šé€±å®Ÿç¸¾ï¼š' + thisWeek.length + 'æœ¬ã€' + thisWeek.reduce(function(s,l){ return s + (parseFloat(l.distKm)||0); }, 0).toFixed(0) + 'km\n\n'
  + 'ã€é‡è¦ãªæœ€è¿‘ã®æƒ…å ±ã€‘\n'
  + '- 2/15ã«é’æ¢…ãƒãƒ©ã‚½ãƒ³30kmï¼ˆå…¬å¼ã‚³ãƒ¼ã‚¹ï¼šé›£ã‚³ãƒ¼ã‚¹ï¼‰ã‚’5åˆ†23ç§’/kmã€HR157ã§å®Œèµ°\n'
  + '- 2/22ã«4åˆ†15ç§’ãƒšãƒ¼ã‚¹ã§2kmè©¦ã¿ã‚‹ã‚‚å¿ƒæ‹166ï¼ˆç¾åœ¨ã®é–¾å€¤ãŒ4åˆ†15ç§’ä»˜è¿‘ï¼‰\n'
  + '- ã‚¹ã‚¿ãƒŸãƒŠã¯ã‚ã‚‹ãŒã€ã‚¹ãƒ”ãƒ¼ãƒ‰æŒä¹…åŠ›ï¼ˆä¹³é…¸é–¾å€¤ï¼‰ãŒä¸è¶³'
  + buildArchiveContext()
  + buildCoachPolicyContext();

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 2000,
        system: `ã‚ãªãŸã¯Jack Danielsã®VDOTãƒ¡ã‚½ãƒƒãƒ‰ã«ç²¾é€šã—ãŸã‚¨ãƒªãƒ¼ãƒˆãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚’ç§‘å­¦çš„ã«åˆ†æã—ã€é¸æ‰‹ã®ç¾çŠ¶ã¨ç›®æ¨™ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ãŸä¸Šã§ã€ã‚®ãƒ£ãƒƒãƒ—ã®åŸå› ã¨ä»Šé€±å®Ÿè¡Œã™ã¹ãå…·ä½“çš„ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

ã€ä»Šæ—¥ã®æ—¥ä»˜ã€‘
${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}ï¼ˆã“ã®æ—¥ä»˜ã‚’åŸºæº–ã«ä»Šå¾Œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€ã“ã¨ï¼‰

è¿”ç­”ã¯JSONå½¢å¼ã®ã¿ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã€‚ä½™åˆ†ãªãƒ†ã‚­ã‚¹ãƒˆä¸è¦ã€‚
{
  "diagnosis": "ç¾çŠ¶ã¨æ–¹é‡ã‚’150å­—ä»¥å†…ã§",
  "gaps": [
    {
      "rank": 1,
      "title": "ã‚®ãƒ£ãƒƒãƒ—ã®åŸå› ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ15å­—ä»¥å†…ï¼‰",
      "desc": "ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªæ ¹æ‹ ã¨èª¬æ˜ï¼ˆ50å­—ä»¥å†…ï¼‰",
      "action": "ã“ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã‚‹ãŸã‚ã«å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ30å­—ä»¥å†…ï¼‰"
    },
    { "rank": 2, "title": "...", "desc": "...", "action": "..." },
    { "rank": 3, "title": "...", "desc": "...", "action": "..." }
  ],
  "missions": [
    {
      "day": "æœˆ",
      "type": "Easyèµ°",
      "distance": "10km",
      "pace": "5åˆ†40ç§’ã‹ã‚‰5åˆ†50ç§’",
      "detail": "å¿ƒæ‹140-150ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹èµ°",
      "key": "æœ‰é…¸ç´ ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰",
      "pass_condition": "è¨­å®šãƒšãƒ¼ã‚¹å†…ã§å®Œé‚ã€å¾ŒåŠã®å¿ƒæ‹ä¸Šæ˜‡ãŒå‰åŠæ¯”10bpmä»¥å†…",
      "fail_prescription": "è·é›¢ã‚’7kmã«è½ã¨ã—ã€å¿ƒæ‹140ä»¥ä¸‹ã‚’å³å®ˆã—ã¦å†å®Ÿæ–½"
    }
  ]
}
é‡è¦: ãƒšãƒ¼ã‚¹ã¯å¿…ãšã€ŒXåˆ†XXç§’ã€ã®å½¢å¼ã§è¨˜è¼‰ã€‚ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚„å¼•ç”¨ç¬¦ã¯ä½¿ã‚ãªã„ã€‚missionsã¯é€±5æœ¬ã€‚æ›œæ—¥ã¯æœˆç«æ°´æœ¨é‡‘åœŸã‹ã‚‰é¸ã¶ï¼ˆæ—¥æ›œæ—¥ã¯çµ¶å¯¾ã«é™¤å¤–ï¼‰ã€‚gaps ã¯å¿…ãš3ä»¶ã€‚pass_conditionã¨fail_prescriptionã¯æ¯å›å¿…ãšè¨˜è¼‰ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œã€‡æ›œæ—¥ã¯èµ°ã‚Œãªã„ã€ãªã©ã®åˆ¶ç´„ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã¯ãã‚Œã‚’å„ªå…ˆã™ã‚‹ã€‚`,
        messages: [{ role: "user", content: dataContext }]
    });
    const text = data.content?.[0]?.text || '';

    let parsed;
    try {
      let clean = text
        .replace(/^```[\w]*\n?/gm, '')
        .replace(/```$/gm, '')
        .trim();
      const jsonMatch = clean.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('No JSON found in: ' + text.slice(0,50));
      clean = jsonMatch[0];
      parsed = JSON.parse(clean);
    } catch(e) {
      console.error('JSON raw response:', text);
      throw new Error('JSON parse failed: ' + text.slice(0, 100));
    }

    archiveCurrentWeek();
    saveMission({ ...parsed, generatedAt: new Date().toISOString() });
    renderMissionCard(parsed);
    renderGapAnalysis(parsed);
    renderPhaseGauge();

  } catch(e) {
    console.error(e);
    const errMsg = e?.message || String(e);
    document.getElementById('missionCard').innerHTML = `
      <div class="mission-generate">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
        <p style="font-size:10px;color:#ff6666;margin-bottom:12px;word-break:break-all;">${errMsg}</p>
        <button class="btn-generate" onclick="generateWeeklyMission()">å†è©¦è¡Œ</button>
      </div>`;
  } finally {
    const btn = document.getElementById('generateBtn');
    if (btn) btn.disabled = false;
  }
}

function renderGapAnalysis(mission) {
  const gaps = mission.gaps || [];
  if (!gaps.length) return;

  const card = document.getElementById('gapAnalysisCard');
  card.innerHTML = gaps.map(g => `
    <div class="gap-item">
      <div class="gap-rank rank-${g.rank}">${g.rank}</div>
      <div class="gap-body">
        <div class="gap-title">${g.title}</div>
        <div class="gap-desc">${g.desc}</div>
        <div class="gap-action">â–¶ ${g.action}</div>
      </div>
    </div>`).join('');

  const updatedAt = mission.generatedAt
    ? new Date(mission.generatedAt).toLocaleDateString('ja-JP', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) + 'æ›´æ–°'
    : '';
  const el = document.getElementById('gapAnalysisUpdated');
  if (el) el.textContent = updatedAt;
}

function renderMissionCard(mission) {
  const days = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  const today = new Date();
  const todayDow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][today.getDay()];

  // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’èµ·ç‚¹ã«å„æ›œæ—¥ã®å®Ÿæ—¥ä»˜ã‚’è¨ˆç®—
  const dayToDate = {};
  const mondayOffset = today.getDay() === 0 ? -6 : 1 - today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate() + mondayOffset);
  days.forEach((d, i) => {
    const dt = new Date(monday);
    dt.setDate(monday.getDate() + i);
    dayToDate[d] = dt;
  });

  // å®Œäº†çŠ¶æ…‹ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
  let doneState = {};
  try { doneState = JSON.parse(localStorage.getItem('sub3_mission_done') || '{}'); } catch {}

  // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã‹ã‚‰è¡¨ç¤ºï¼ˆæ›œæ—¥â†’å®Ÿæ—¥ä»˜ã§ä¸¦ã³æ›¿ãˆï¼‰
  const sortedMissions = [...(mission.missions || [])].sort((a, b) => {
    const da = dayToDate[a.day] ? dayToDate[a.day].getTime() : 9999999999999;
    const db = dayToDate[b.day] ? dayToDate[b.day].getTime() : 9999999999999;
    return da - db;
  });

  const items = sortedMissions.map((m, sortedIdx) => {
    // å…ƒã®idxã¯ã‚ªãƒªã‚¸ãƒŠãƒ«é…åˆ—ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆç·¨é›†ãƒ»å®Œäº†ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    const idx = (mission.missions || []).findIndex(orig =>
      orig.day === m.day && orig.type === m.type && orig.distance === m.distance
    );
    const isToday = m.day === todayDow;
    const isPast = days.indexOf(m.day) < days.indexOf(todayDow);
    const isDone = doneState[idx] || false;
    const typeClass = {
      'Easyèµ°': 'type-easy',
      'ãƒ­ãƒ³ã‚°èµ°': 'type-long',
      'é–¾å€¤èµ°': 'type-tempo',
      'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«': 'type-interval',
      'ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³': 'type-interval',
      'ãƒŸãƒ‰ãƒ«èµ°': 'type-long',
      'ãƒ¬ãƒ¼ã‚¹': 'type-race'
    }[m.type] || 'type-easy';

    const dateObj = dayToDate[m.day];
    const dateLabel = dateObj
      ? `${dateObj.getMonth()+1}/${dateObj.getDate()}`
      : '';

    return `
      <div class="mission-item ${isDone ? 'done' : ''}" id="mission-item-${idx}" draggable="true" data-idx="${idx}">
        <div class="mission-drag-handle" title="ä¸¦ã³æ›¿ãˆ">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="16" x2="20" y2="16"/></svg>
        </div>
        <div class="mission-day-block">
          <div class="mission-date ${isToday ? 'today' : isPast ? 'past' : ''}">${dateLabel}</div>
          <div class="mission-day ${isToday ? 'today' : isPast ? 'past' : ''}">${m.day}</div>
        </div>
        <div class="mission-body">
          <div class="mission-type">
            <span class="type-badge ${typeClass}">${m.type}</span>${m.distance}
          </div>
          <div class="mission-detail">${m.pace}${m.detail ? ' Â· ' + m.detail : ''}</div>
          ${m.key ? `<div class="mission-key">â–¶ ${m.key}</div>` : ''}
          ${m.pass_condition ? `<div class="mission-pass">
            <span class="mission-pass-label">åˆæ ¼</span>${m.pass_condition}
          </div>` : ''}
          ${m.fail_prescription ? `<div class="mission-fail">
            <span class="mission-fail-label">ä¸åˆæ ¼æ™‚</span>${m.fail_prescription}
          </div>` : ''}
          <div class="mission-actions">
            <button class="mission-edit-btn" onclick="openMissionEdit(${idx})" title="ç·¨é›†">
              <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <div class="mission-check ${isDone ? 'checked' : ''}" onclick="toggleMissionDone(${idx})">
              ${isDone ? 'âœ“' : ''}
            </div>
          </div>
        </div>
      </div>`;
  }).join('');

  const phase = getCurrentPhase();
  document.getElementById('missionCard').innerHTML = `
    <div class="mission-header">
      <div class="mission-header-title">WEEKLY MISSION</div>
      <div style="display:flex;align-items:center;gap:6px;">
        ${mission.fromChat ? '<div style="font-size:9px;color:#000;background:var(--accent);padding:2px 7px;border-radius:2px;font-weight:700;letter-spacing:1px;">COACH</div>' : ''}
        <div class="mission-phase">${phase.label}</div>
      </div>
    </div>
    ${items}`;

  initMissionDragDrop();
}

function initMissionDragDrop() {
  const items = document.querySelectorAll('.mission-item');
  let dragSrc = null;

  // PCãƒ‰ãƒ©ãƒƒã‚°ï¼šmission-itemã«draggableã€ãŸã ã—dragstartã¯ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰ã®ã¿è¨±å¯
  items.forEach(item => {
    const handle = item.querySelector('.mission-drag-handle');

    // ãƒãƒ³ãƒ‰ãƒ«ä»¥å¤–ã‹ã‚‰ã®dragstartã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    item.addEventListener('dragstart', e => {
      if (!item.dataset.draggingFromHandle) {
        e.preventDefault();
        return;
      }
      dragSrc = item;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      delete item.dataset.draggingFromHandle;
      document.querySelectorAll('.mission-item').forEach(i => i.classList.remove('drag-over'));
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      if (item !== dragSrc) {
        document.querySelectorAll('.mission-item').forEach(i => i.classList.remove('drag-over'));
        item.classList.add('drag-over');
      }
    });
    item.addEventListener('drop', e => {
      e.preventDefault();
      if (dragSrc && dragSrc !== item) swapMissions(dragSrc, item);
    });

    if (handle) {
      handle.addEventListener('mousedown', () => {
        item.dataset.draggingFromHandle = '1';
      });
    }
  });

  // iOSã‚¿ãƒƒãƒï¼šãƒãƒ³ãƒ‰ãƒ«ã®touchstart/move/endã®ã¿ã§åˆ¶å¾¡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã¯å¹²æ¸‰ã—ãªã„ï¼‰
  items.forEach(item => {
    const handle = item.querySelector('.mission-drag-handle');
    if (!handle) return;

    let dragging = false;
    let touchItem = null;

    handle.addEventListener('touchstart', e => {
      dragging = true;
      touchItem = item;
      item.classList.add('dragging');
      e.stopPropagation(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã¨åˆ†é›¢
    }, { passive: true });

    handle.addEventListener('touchmove', e => {
      if (!dragging) return;
      e.preventDefault(); // ãƒãƒ³ãƒ‰ãƒ«ã‚¿ãƒƒãƒä¸­ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
      const touch = e.touches[0];
      const els = document.elementsFromPoint(touch.clientX, touch.clientY);
      const target = els.find(el => el.classList.contains('mission-item') && el !== touchItem);
      document.querySelectorAll('.mission-item').forEach(i => i.classList.remove('drag-over'));
      if (target) target.classList.add('drag-over');
    }, { passive: false });

    handle.addEventListener('touchend', e => {
      if (!dragging) return;
      dragging = false;
      item.classList.remove('dragging');
      const touch = e.changedTouches[0];
      const els = document.elementsFromPoint(touch.clientX, touch.clientY);
      const target = els.find(el => el.classList.contains('mission-item') && el !== touchItem);
      document.querySelectorAll('.mission-item').forEach(i => i.classList.remove('drag-over'));
      if (target && touchItem) swapMissions(touchItem, target);
      touchItem = null;
    }, { passive: true });
  });
}

function swapMissions(srcEl, tgtEl) {
  const srcIdx = parseInt(srcEl.dataset.idx);
  const tgtIdx = parseInt(tgtEl.dataset.idx);
  const mission = getMission();
  if (!mission) return;
  // æ›œæ—¥ã¯å›ºå®šã—ãŸã¾ã¾ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹ï¼ˆtype/distance/pace/detail/keyï¼‰ã ã‘å…¥ã‚Œæ›¿ãˆã‚‹
  const ms = mission.missions;
  const srcContent = { type: ms[srcIdx].type, distance: ms[srcIdx].distance, pace: ms[srcIdx].pace, detail: ms[srcIdx].detail, key: ms[srcIdx].key, pass_condition: ms[srcIdx].pass_condition, fail_prescription: ms[srcIdx].fail_prescription };
  const tgtContent = { type: ms[tgtIdx].type, distance: ms[tgtIdx].distance, pace: ms[tgtIdx].pace, detail: ms[tgtIdx].detail, key: ms[tgtIdx].key, pass_condition: ms[tgtIdx].pass_condition, fail_prescription: ms[tgtIdx].fail_prescription };
  Object.assign(ms[srcIdx], tgtContent);
  Object.assign(ms[tgtIdx], srcContent);
  saveMission(mission);
  renderMissionCard(mission);
  showToast('âœ… é †ç•ªã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}

function toggleMissionDone(idx) {
  let doneState = {};
  try { doneState = JSON.parse(localStorage.getItem('sub3_mission_done') || '{}'); } catch {}
  doneState[idx] = !doneState[idx];
  localStorage.setItem('sub3_mission_done', JSON.stringify(doneState));

  const item = document.getElementById('mission-item-' + idx);
  const check = item.querySelector('.mission-check');
  if (doneState[idx]) {
    item.classList.add('done');
    check.classList.add('checked');
    check.textContent = 'âœ“';
  } else {
    item.classList.remove('done');
    check.classList.remove('checked');
    check.textContent = '';
  }
}

function openMissionEdit(idx) {
  const mission = getMission();
  if (!mission || !mission.missions[idx]) return;
  const m = mission.missions[idx];

  const days = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  const types = ['Easyèµ°','é–¾å€¤èµ°','ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«','ãƒ­ãƒ³ã‚°èµ°','ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³','ãƒ¬ãƒ¼ã‚¹'];

  const overlay = document.createElement('div');
  overlay.className = 'edit-modal-overlay';
  overlay.id = 'editModalOverlay';
  overlay.innerHTML = `
    <div class="edit-modal">
      <h3><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:-2px;margin-right:6px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>${m.day}æ›œæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç·¨é›†</h3>
      <div class="edit-field">
        <label>æ›œæ—¥</label>
        <select id="edit-day">
          ${days.map(d => `<option value="${d}" ${d === m.day ? 'selected' : ''}>${d}</option>`).join('')}
        </select>
      </div>
      <div class="edit-field">
        <label>ç¨®åˆ¥</label>
        <select id="edit-type">
          ${types.map(t => `<option value="${t}" ${t === m.type ? 'selected' : ''}>${t}</option>`).join('')}
        </select>
      </div>
      <div class="edit-field">
        <label>è·é›¢</label>
        <input id="edit-distance" type="text" value="${m.distance || ''}">
      </div>
      <div class="edit-field">
        <label>ãƒšãƒ¼ã‚¹</label>
        <input id="edit-pace" type="text" value="${m.pace || ''}">
      </div>
      <div class="edit-field">
        <label>è©³ç´°</label>
        <textarea id="edit-detail">${m.detail || ''}</textarea>
      </div>
      <div class="edit-field">
        <label>ãƒã‚¤ãƒ³ãƒˆ</label>
        <input id="edit-key" type="text" value="${m.key || ''}">
      </div>
      <div class="edit-modal-btns">
        <button class="btn-cancel-edit" onclick="closeMissionEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-save-edit" onclick="saveMissionEdit(${idx})">ä¿å­˜</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', e => { if (e.target === overlay) closeMissionEdit(); });
}

function closeMissionEdit() {
  const overlay = document.getElementById('editModalOverlay');
  if (overlay) overlay.remove();
}

function saveMissionEdit(idx) {
  const mission = getMission();
  if (!mission) return;
  mission.missions[idx] = {
    ...mission.missions[idx],
    day:      document.getElementById('edit-day').value,
    type:     document.getElementById('edit-type').value,
    distance: document.getElementById('edit-distance').value,
    pace:     document.getElementById('edit-pace').value,
    detail:   document.getElementById('edit-detail').value,
    key:      document.getElementById('edit-key').value,
  };
  saveMission(mission);
  closeMissionEdit();
  renderMissionCard(mission);
  showToast('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

// ===== LOG =====
let currentLogIndex = null;

function openTypeSelect(index) {
  const logs = getLogs();
  const log = logs[index];
  const current = log.runType || classifyRunByPace(parseFloat(log.distKm), parseInt(log.moving_time) || 0);

  const types = [
    { key: 'easy',     label: 'EASY',  cls: 'type-easy',     desc: 'ãƒªã‚«ãƒãƒªãƒ¼ãƒ»æœ‰é…¸ç´ ãƒ™ãƒ¼ã‚¹èµ°' },
    { key: 'long',     label: 'LONG',  cls: 'type-long',     desc: 'ãƒ­ãƒ³ã‚°èµ°ãƒ»è·é›¢èµ°' },
    { key: 'tempo',    label: 'TEMPO', cls: 'type-tempo',    desc: 'é–¾å€¤èµ°ãƒ»ãƒšãƒ¼ã‚¹èµ°' },
    { key: 'interval', label: 'INT',   cls: 'type-interval', desc: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ»ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³' },
    { key: 'race',     label: 'RACE',  cls: 'type-race',     desc: 'ãƒ¬ãƒ¼ã‚¹ãƒ»ã‚¿ã‚¤ãƒ ãƒˆãƒ©ã‚¤ã‚¢ãƒ« â†’ VDOTæ­£å¼è¨˜éŒ²' },
  ];

  const overlay = document.createElement('div');
  overlay.className = 'edit-modal-overlay';
  overlay.id = 'typeSelectOverlay';

  overlay.innerHTML = `
    <div class="edit-modal" style="padding:20px;">
      <h3 style="margin:0 0 4px;font-size:14px;letter-spacing:1px;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´</h3>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">${log.name || log.distKm + 'kmèµ°'}</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${types.map(t => `
          <button onclick="changeLogType(${index},'${t.key}')" style="
            display:flex;align-items:center;gap:12px;
            background:${t.key === current ? 'var(--surface2)' : 'var(--surface)'};
            border:1px solid ${t.key === current ? 'var(--accent)' : 'var(--border)'};
            border-radius:8px;padding:12px 14px;cursor:pointer;text-align:left;width:100%;">
            <span class="type-badge ${t.cls}" style="flex-shrink:0;">${t.label}</span>
            <span style="font-size:12px;color:var(--text-muted);">${t.desc}</span>
            ${t.key === current ? '<span style="margin-left:auto;font-size:10px;color:var(--accent);">ç¾åœ¨</span>' : ''}
          </button>`).join('')}
      </div>
      <button onclick="document.getElementById('typeSelectOverlay').remove()" style="margin-top:14px;width:100%;padding:10px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>`;

  document.body.appendChild(overlay);
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
}

function changeLogType(index, newType) {
  const logs = getLogs();
  logs[index].runType = newType;
  saveLogs(logs);
  document.getElementById('typeSelectOverlay')?.remove();
  renderLogList();
  renderVdotCard(findBestVdotWithFallback());
  renderPhaseGauge();
  checkRecovery();
  const typeLabel = { easy:'EASY', long:'LONG', tempo:'TEMPO', interval:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', race:'RACEï¼ˆVDOTæ›´æ–°ï¼‰' }[newType] || newType;
  showToast(`âœ… ${typeLabel} ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
}

function deleteLog(index) {
  const logs = getLogs();
  const log = logs[index];
  const name = log.name || `${parseFloat(log.distKm).toFixed(1)}kmèµ°`;
  if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  logs.splice(index, 1);
  saveLogs(logs);
  renderLogList();
  renderVdotCard(findBestVdot());
  showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

function renderLogList() {
  const logs = getLogs();
  const container = document.getElementById('logList');
  document.getElementById('logCount').textContent = logs.length + 'ä»¶';

  // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«
  const importZone = document.getElementById('importZone');
  if (logs.length > 0) {
    importZone.classList.add('has-data');
    importZone.innerHTML = `<div style="display:flex;align-items:center;gap:8px;justify-content:center"><span class="iz-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span><span class="iz-title">FITè¤‡æ•°ãƒ»ZIP / CSV ã‚’è¿½åŠ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span></div>`;
  }

  if (logs.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:40px 0;color:var(--text-muted)">
      <div style="margin-bottom:12px;opacity:0.3"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2.5"/><path d="M8 21l2-6 2 2 2-4 2 4"/><path d="M7 11c0-2 1.5-4 5-4s5 2 5 4"/></svg></div>
      <div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
      <div style="font-size:12px;margin-top:8px">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å§‹ã‚ã‚ˆã†</div>
    </div>`;
    return;
  }

  const dowLabels = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

  container.innerHTML = logs.map((log, i) => {
    const dist = parseFloat(log.distKm) || 0;
    const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
    const pace = formatPace(dist, timeSec);
    const hr = log.average_heartrate ? `HR${Math.round(log.average_heartrate)}` : '';
    const date = new Date(log.date);
    const day = isNaN(date) ? 'â€”' : date.getDate();
    const dow = isNaN(date) ? '' : dowLabels[date.getDay()];
    const runType = log.runType || classifyRunByPace(dist, timeSec);
    const typeClass = { easy:'type-easy', long:'type-long', tempo:'type-tempo', interval:'type-interval', race:'type-race' }[runType] || 'type-easy';
    const typeName = { easy:'EASY', long:'LONG', tempo:'TEMPO', interval:'INT', race:'RACE' }[runType] || 'RUN';

    return `<div class="log-item" onclick="showLogDetail(${i})">
      <div class="log-date">
        <div class="ld-day" style="font-family:'Bebas Neue',sans-serif;font-weight:400;">${day}</div>
        <div class="ld-dow">${dow}</div>
      </div>
      <div class="log-body">
        <div class="log-name">
          <button class="type-badge ${typeClass}" onclick="event.stopPropagation();openTypeSelect(${i})" title="ã‚¿ãƒƒãƒ—ã§ã‚¿ã‚¤ãƒ—å¤‰æ›´" style="cursor:pointer;border:none;">${typeName}</button>${log.name || dist.toFixed(1) + 'kmèµ°'}
        </div>
        <div class="log-meta">${dist.toFixed(1)}kmã€€${pace}/km${hr ? 'ã€€' + hr : ''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button onclick="event.stopPropagation();deleteLog(${i})" style="background:none;border:none;color:#555;cursor:pointer;padding:4px 6px;border-radius:6px;line-height:1" title="å‰Šé™¤"><svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg></button>
      </div>
    </div>`;
  }).join('');
}

async function showLogDetail(index) {
  currentLogIndex = index;
  const logs = getLogs();
  const log = logs[index];
  const dist = parseFloat(log.distKm) || 0;
  const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
  const pace = formatPace(dist, timeSec);
  const vdot = calcVDOT(dist, timeSec);
  const hr = log.average_heartrate ? Math.round(log.average_heartrate) : 'â€”';
  const isFit = log.source === 'coros_fit';

  document.getElementById('detailTitle').textContent = log.name || dist.toFixed(1) + 'kmèµ°';

  const runType = log.runType || classifyRunByPace(dist, timeSec);

  // åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
  let metricsHTML = `
    <div class="m-card"><div class="ml">è·é›¢</div><div class="mv">${dist.toFixed(1)}<span style="font-size:11px">km</span></div></div>
    <div class="m-card"><div class="ml">ãƒšãƒ¼ã‚¹</div><div class="mv" style="font-size:13px">${pace}</div></div>
    ${(runType === 'race' || runType === 'interval' || runType === 'tempo') && vdot ? `<div class="m-card"><div class="ml">VDOTå‚è€ƒå€¤</div><div class="mv">${vdot}<span style="font-size:9px;color:var(--text-dim);display:block;margin-top:2px">ãƒ¬ãƒ¼ã‚¹ã§æ­£å¼æ¸¬å®šæ¨å¥¨</span></div></div>` : ''}
    <div class="m-card"><div class="ml">ã‚¿ã‚¤ãƒ </div><div class="mv" style="font-size:13px">${formatDuration(timeSec)}</div></div>
    <div class="m-card"><div class="ml">å¹³å‡HR</div><div class="mv">${hr}</div></div>
    <div class="m-card"><div class="ml">æœ€å¤§HR</div><div class="mv">${log.max_heartrate || 'â€”'}</div></div>`;

  // FITãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  if (isFit) {
    metricsHTML += `
    <div class="m-card"><div class="ml">ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹</div><div class="mv" style="font-size:14px">${log.avg_cadence || 'â€”'}<span style="font-size:10px">spm</span></div></div>
    <div class="m-card"><div class="ml">ãƒ‘ãƒ¯ãƒ¼</div><div class="mv" style="font-size:14px">${log.avg_power || 'â€”'}<span style="font-size:10px">W</span></div></div>
    <div class="m-card"><div class="ml">ç²å¾—æ¨™é«˜</div><div class="mv" style="font-size:14px">${log.total_ascent || 'â€”'}<span style="font-size:10px">m</span></div></div>`;
  }

  document.getElementById('detailMetrics').innerHTML = metricsHTML;

  // ãƒ©ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆFITã®ã¿ï¼‰
  let lapHTML = '';
  if (isFit && log.laps && log.laps.length > 0) {
    const lapRows = log.laps.filter(l => l.dist && l.dist > 0.3).map((l, i) => {
      const lapPace = l.dist && l.time ? formatPace(l.dist, l.time) : 'â€”';
      const lapHR = l.hr || 'â€”';
      return `<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="color:var(--text-muted);min-width:30px">${i+1}km</span>
        <span style="font-family:'JetBrains Mono',monospace;min-width:60px">${lapPace}/km</span>
        <span style="color:var(--text-muted)">HR${lapHR}</span>
      </div>`;
    }).join('');
    if (lapRows) {
      lapHTML = `<div style="margin-bottom:14px">
        <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:8px">LAP DATA</div>
        ${lapRows}
      </div>`;
    }
  }

  document.getElementById('detailCoach').innerHTML = lapHTML + `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> AIã‚³ãƒ¼ãƒãŒåˆ†æä¸­...</div>`;
  document.getElementById('detailModal').classList.add('active');

  // AIã«æ¸¡ã™è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
  let coachPrompt = `ç·´ç¿’ï¼š${log.name}ã€${dist.toFixed(1)}kmã€${formatDuration(timeSec)}ã€${pace}/kmã€å¹³å‡HR${hr}bpm`;
  if (isFit) {
    if (log.max_heartrate) coachPrompt += `ã€æœ€å¤§HR${log.max_heartrate}bpm`;
    if (log.avg_cadence) coachPrompt += `ã€ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹${log.avg_cadence}spm`;
    if (log.avg_power) coachPrompt += `ã€å¹³å‡ãƒ‘ãƒ¯ãƒ¼${log.avg_power}W`;
    if (log.total_ascent) coachPrompt += `ã€ç²å¾—æ¨™é«˜${log.total_ascent}m`;
    if (vdot) coachPrompt += `ã€VDOTæ›ç®—${vdot}`;
    // ãƒ©ãƒƒãƒ—ã®å‰åŠãƒ»å¾ŒåŠæ¯”è¼ƒ
    if (log.laps && log.laps.length >= 4) {
      const half = Math.floor(log.laps.length / 2);
      const firstHalf = log.laps.slice(0, half).filter(l => l.time && l.dist);
      const secondHalf = log.laps.slice(half).filter(l => l.time && l.dist);
      if (firstHalf.length && secondHalf.length) {
        const fPace = formatPace(
          firstHalf.reduce((s,l) => s + l.dist, 0),
          firstHalf.reduce((s,l) => s + l.time, 0)
        );
        const sPace = formatPace(
          secondHalf.reduce((s,l) => s + l.dist, 0),
          secondHalf.reduce((s,l) => s + l.time, 0)
        );
        coachPrompt += `ã€‚å‰åŠãƒšãƒ¼ã‚¹${fPace}/kmã€å¾ŒåŠãƒšãƒ¼ã‚¹${sPace}/km`;
      }
    }
  }

  // åŒã‚¿ã‚¤ãƒ—ã®ç›´è¿‘ãƒ­ã‚°ã‚’å–å¾—ï¼ˆå‰å›æ¯”åˆ†æç”¨ï¼‰
  const allLogs = getLogs();
  const sameTypeLogs = allLogs
    .filter(l => l !== log && (l.runType || classifyRunByHeartrate(l.distKm, l.moving_time, l.average_heartrate)) === runType)
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 3);

  let prevContext = '';
  if (sameTypeLogs.length > 0) {
    prevContext = '\n\nã€åŒã‚¿ã‚¤ãƒ—ã®ç›´è¿‘å®Ÿç¸¾ï¼ˆæ¯”è¼ƒç”¨ï¼‰ã€‘\n' + sameTypeLogs.map(function(pl) {
      const pd = parseFloat(pl.distKm) || 0;
      const pt = parseInt(pl.moving_time) || 0;
      const pDate = pl.date ? pl.date.substring(5) : '';
      const pHR = pl.average_heartrate ? Math.round(pl.average_heartrate) : '-';
      let s = pDate + ' ' + pd.toFixed(1) + 'km ' + formatPace(pd, pt) + '/km HR' + pHR;
      if (pl.laps && pl.laps.length >= 4) {
        const half = Math.floor(pl.laps.length / 2);
        const fh = pl.laps.slice(0, half).filter(function(x){ return x.time && x.dist; });
        const sh = pl.laps.slice(half).filter(function(x){ return x.time && x.dist; });
        if (fh.length && sh.length) {
          s += ' (å‰åŠ' + formatPace(fh.reduce(function(a,x){return a+x.dist;},0), fh.reduce(function(a,x){return a+x.time;},0)) + '/å¾ŒåŠ' + formatPace(sh.reduce(function(a,x){return a+x.dist;},0), sh.reduce(function(a,x){return a+x.time;},0)) + ')';
        }
      }
      return s;
    }).join('\n');
  }

  // ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç‹™ã„ã¨ã®ã‚ºãƒ¬åˆ†æç”¨ï¼‰
  const mission = getMission();
  let missionContext = '';
  if (mission && mission.missions) {
    const date = new Date(log.date);
    const dowMap = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const logDow = dowMap[date.getDay()];
    const planned = mission.missions.find(function(m){ return m.day === logDow; });
    if (planned) {
      missionContext = '\n\nã€ä»Šæ—¥ã®è¨ˆç”»ã€‘' + planned.type + ' ' + planned.distance + ' ç›®æ¨™ãƒšãƒ¼ã‚¹:' + planned.pace
        + (planned.pass_condition ? ' åˆæ ¼æ¡ä»¶:' + planned.pass_condition : '');
    }
  }

  const typeLabel = { easy:'Easyèµ°', long:'ãƒ­ãƒ³ã‚°èµ°', tempo:'é–¾å€¤èµ°', interval:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', race:'ãƒ¬ãƒ¼ã‚¹' }[runType] || runType;

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 800,
        system: 'ã‚ãªãŸã¯Renato Canovaã®æŒ‡å°å“²å­¦ã‚’æŒã¤ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚é¸æ‰‹ï¼šå·å³¶å¤§è¼ï¼ˆVDOT' + findBestVdotWithFallback() + 'ã€ç›®æ¨™ã¤ãã°ãƒãƒ©ã‚½ãƒ³ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼‰ã€‚\n\nä»¥ä¸‹ã®å½¢å¼ã§åˆ†æã›ã‚ˆï¼ˆå„é …ç›®ã‚’æ”¹è¡Œã§åŒºåˆ‡ã‚‹ï¼‰ï¼š\n**å‰å›æ¯”** åŒã‚¿ã‚¤ãƒ—ã®å‰å›ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã¦ä½•ãŒå¤‰ã‚ã£ãŸã‹1æ–‡ã§ã€‚åˆå›ãªã‚‰ã€Œåˆå›è¨ˆæ¸¬ã€ã¨æ›¸ãã€‚\n**ç‹™ã„ã¨ã®ã‚ºãƒ¬** è¨ˆç”»ã¨å®Ÿç¸¾ã®ã‚®ãƒ£ãƒƒãƒ—ã€ã¾ãŸã¯ä»Šæ—¥ã®ç·´ç¿’ã‚¿ã‚¤ãƒ—ï¼ˆ' + typeLabel + 'ï¼‰ã®ç›®çš„ã«å¯¾ã—ã¦ã©ã†ã ã£ãŸã‹1æ–‡ã§ã€‚åˆæ ¼æ¡ä»¶ãŒã‚ã‚Œã°ãã‚Œã‚’åŸºæº–ã«ã™ã‚‹ã€‚\n**æ¬¡ã«å¤‰ãˆã‚‹ã“ã¨** æ¬¡å›ã®ç·´ç¿’ã§å¤‰ãˆã‚‹ç‚¹ã‚’ãŸã 1ã¤ã€å…·ä½“çš„ãªæ•°å­—ã§ã€‚ã€Œè·é›¢+1kmã€ã€Œãƒšãƒ¼ã‚¹5ç§’è½ã¨ã™ã€ã€Œãƒ¬ã‚¹ãƒˆ30ç§’å¢—ã€ãªã©ã€‚\n\n<strong>ã‚¿ã‚°ã§æ•°å­—ãƒ»é‡è¦å˜èªã‚’å¼·èª¿ã€‚å…¨ä½“200å­—ä»¥å†…ã€‚' + (isFit ? ' FITãƒ‡ãƒ¼ã‚¿ã‚ã‚Šã€‚ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»ãƒ©ãƒƒãƒ—æ¨ç§»ã‚‚æ ¹æ‹ ã«ä½¿ã†ã“ã¨ã€‚' : ''),
        messages: [{ role: "user", content: coachPrompt + prevContext + missionContext }]
    });
    const rawText = data.content?.[0]?.text || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—å¤±æ•—';
    // **å¤ªå­—** â†’ <strong>ã€æ®‹ã£ãŸ * ã‚’é™¤å»
    const formatted = rawText
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*/g, '');
    document.getElementById('detailCoach').innerHTML = lapHTML + formatted;
  } catch(e) {
    document.getElementById('detailCoach').innerHTML = lapHTML + `VDOT ${vdot || 'â€”'} / ãƒšãƒ¼ã‚¹ ${pace} / HR ${hr}`;
  }
}

function closeDetailModal(e) {
  if (e.target === document.getElementById('detailModal')) {
    document.getElementById('detailModal').classList.remove('active');
  }
}

// ===== SHARE =====
function shareToX() {
  const logs = getLogs();
  if (currentLogIndex === null) return;
  const log = logs[currentLogIndex];
  const dist = parseFloat(log.distKm) || 0;
  const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
  const vdot = calcVDOT(dist, timeSec);
  const pace = formatPace(dist, timeSec);
  const text = `ä»Šæ—¥ã®ç·´ç¿’ ğŸƒ\n${dist.toFixed(1)}km @ ${pace}/km\nVDOTï¼š${vdot || 'â€”'}\n\nã‚µãƒ–ã‚¹ãƒªãƒ¼ã¾ã§ã‚ã¨VDOT${Math.max(0, CONFIG.targetVdot - (vdot || findBestVdot()))}ãƒã‚¤ãƒ³ãƒˆï¼\n\n#ã‚µãƒ–ã‚¹ãƒªãƒ¼ #ãƒãƒ©ã‚½ãƒ³ #SUB3LAB`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`);
}

// ===== MANUAL RECORD =====
async function saveManualRun() {
  const dist = parseFloat(document.getElementById('recDist').value);
  const timeStr = document.getElementById('recTime').value;
  const type = document.getElementById('recType').value;
  const date = document.getElementById('recDate').value;
  const memo = document.getElementById('recMemo').value;
  const hr = document.getElementById('recHR').value;

  if (!dist || !timeStr || !date) { showToast('âš ï¸ æ—¥ä»˜ãƒ»è·é›¢ãƒ»ã‚¿ã‚¤ãƒ ã¯å¿…é ˆã§ã™'); return; }

  const timeSec = parseDuration(timeStr);
  const log = {
    distKm: dist,
    moving_time: timeSec,
    duration: timeStr,
    runType: type,
    date,
    memo,
    average_heartrate: hr ? parseFloat(hr) : null,
    name: `${getTypeLabel(type)} ${dist}km`,
    source: 'manual'
  };
  addLog(log);

  const newVdot = findBestVdot();
  renderVdotCard(newVdot);
  showToast('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');
  // è‡ªå‹•ã§ãƒ—ãƒ©ãƒ³åˆ†æ
  const newLogs2 = getLogs();
  const newMission2 = findMissionForLog(newLogs2[0]);
  if (newMission2) runPlanAnalysis(0, newMission2);

  document.getElementById('recDist').value = '';
  document.getElementById('recTime').value = '';
  document.getElementById('recMemo').value = '';
  document.getElementById('recHR').value = '';

  showPage('log', document.querySelectorAll('.nav-item')[3]);
  setTimeout(() => showLogDetail(0), 300);
}

// ===== FILE HANDLER (FITè¤‡æ•°ãƒ»ZIPãƒ»CSVå¯¾å¿œ) =====
function handleFileDrop(e) {
  e.preventDefault();
  document.getElementById('importZone').classList.remove('drag-over');
  handleFileSelectMulti(e.dataTransfer.files);
}

async function handleFileSelectMulti(files) {
  if (!files || files.length === 0) return;

  // filesã‚’Arrayã«ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆSafariã§fileså‚ç…§ãŒæ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼‰
  const fileArray = Array.from(files);
  const fileInput = document.getElementById('fileInput');
  if (fileInput) setTimeout(() => { fileInput.value = ''; }, 100);

  const allFitBuffers = []; // {name, buffer}
  let csvText = null;

  // ZIPã¨FITã¨CSVã‚’ä»•åˆ†ã‘
  for (const file of fileArray) {
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'zip') {
      // ZIPã‚’å±•é–‹ã—ã¦FITã‚’å–ã‚Šå‡ºã™
      const zipBuffers = await extractFitFromZip(file);
      allFitBuffers.push(...zipBuffers);
    } else if (ext === 'fit') {
      const buf = await readAsArrayBuffer(file);
      allFitBuffers.push({ name: file.name, buffer: buf });
    } else if (ext === 'csv' && !csvText) {
      csvText = await readAsText(file);
    }
  }

  // CSVãŒã‚ã‚Œã°å…ˆã«å‡¦ç†
  if (csvText) {
    try {
      const imported = parseStravaCsv(csvText);
      if (imported.length > 0) saveImportedLog(imported);
    } catch(e) { console.error('CSV parse error', e); }
  }

  // FITãŒ1ä»¶ä»¥ä¸‹ãªã‚‰å¾“æ¥é€šã‚Š
  if (allFitBuffers.length === 0) return;
  if (allFitBuffers.length === 1) {
    try {
      const log = parseFitFile(allFitBuffers[0].buffer);
      if (log) saveImportedLog([log]);
      else showToast('âš ï¸ FITãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } catch(e) { showToast('âŒ FITã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    return;
  }

  // è¤‡æ•°FITã®ä¸€æ‹¬å‡¦ç†
  await processBulkFit(allFitBuffers);
}

async function processBulkFit(fitFiles) {
  const progressEl = document.getElementById('importProgress');
  const progressText = document.getElementById('importProgressText');
  const progressBar = document.getElementById('importProgressBar');
  progressEl.style.display = 'block';

  const results = [];
  const errors = [];

  for (let i = 0; i < fitFiles.length; i++) {
    const pct = Math.round((i / fitFiles.length) * 100);
    progressBar.style.width = pct + '%';
    progressText.textContent = `å‡¦ç†ä¸­... ${i + 1} / ${fitFiles.length} ãƒ•ã‚¡ã‚¤ãƒ«`;

    try {
      const log = parseFitFile(fitFiles[i].buffer);
      if (log) results.push(log);
    } catch(e) {
      errors.push(fitFiles[i].name);
    }

    // UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†å°‘ã—å¾…ã¤
    if (i % 10 === 9) await sleep(10);
  }

  progressBar.style.width = '100%';
  progressText.textContent = `å®Œäº†ï¼`;

  if (results.length > 0) {
    // æ—¢å­˜ãƒ­ã‚°ã¨ãƒãƒ¼ã‚¸
    const existing = getLogs();
    const existingIds = new Set(existing.map(l => l.fit_id || l.strava_id).filter(Boolean));
    const filtered = results.filter(l => !existingIds.has(l.fit_id || l.strava_id));
    const merged = [...filtered, ...existing].sort((a,b) => new Date(b.date) - new Date(a.date));
    saveLogs(merged);

    renderVdotCard(findBestVdot());
    renderLogList();
    renderPhaseGauge();

    setTimeout(() => { progressEl.style.display = 'none'; }, 2000);

    const msg = `âœ… ${filtered.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼${errors.length > 0 ? `ï¼ˆ${errors.length}ä»¶ã‚¨ãƒ©ãƒ¼ï¼‰` : ''}`;
    progressText.textContent = msg;
    showToast(msg);
  } else {
    progressText.textContent = `âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ`;
  }
}

// ZIPã‹ã‚‰FITãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã™ï¼ˆJSã§å®Ÿè£…ï¼‰
async function extractFitFromZip(file) {
  const buffer = await readAsArrayBuffer(file);
  const data = new Uint8Array(buffer);
  const fits = [];

  // ZIPã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã™ (PK\x03\x04)
  let pos = 0;
  while (pos < data.length - 30) {
    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚·ã‚°ãƒãƒãƒ£
    if (data[pos] === 0x50 && data[pos+1] === 0x4B && data[pos+2] === 0x03 && data[pos+3] === 0x04) {
      const compression = data[pos+8] | (data[pos+9] << 8);
      const compressedSize = data[pos+18] | (data[pos+19] << 8) | (data[pos+20] << 16) | (data[pos+21] << 24);
      const uncompressedSize = data[pos+22] | (data[pos+23] << 8) | (data[pos+24] << 16) | (data[pos+25] << 24);
      const fileNameLen = data[pos+26] | (data[pos+27] << 8);
      const extraLen = data[pos+28] | (data[pos+29] << 8);
      const fileNameStart = pos + 30;
      const fileName = new TextDecoder().decode(data.slice(fileNameStart, fileNameStart + fileNameLen));
      const dataStart = fileNameStart + fileNameLen + extraLen;

      if (fileName.toLowerCase().endsWith('.fit') && compressedSize > 0) {
        const compressedData = data.slice(dataStart, dataStart + compressedSize);

        if (compression === 0) {
          // éåœ§ç¸®
          fits.push({ name: fileName, buffer: compressedData.buffer.slice(compressedData.byteOffset, compressedData.byteOffset + compressedData.byteLength) });
        } else if (compression === 8) {
          // Deflateåœ§ç¸® â†’ DecompressionStreamã§å±•é–‹
          try {
            const decompressed = await decompressDeflate(compressedData);
            fits.push({ name: fileName, buffer: decompressed });
          } catch(e) {
            console.warn('Failed to decompress:', fileName, e);
          }
        }
      }
      pos = dataStart + compressedSize;
    } else {
      pos++;
    }
  }
  return fits;
}

async function decompressDeflate(data) {
  // DecompressionStream APIã‚’ä½¿ç”¨ (Chromeå¯¾å¿œ)
  if (typeof DecompressionStream === 'undefined') {
    throw new Error('DecompressionStream not supported');
  }
  const ds = new DecompressionStream('deflate-raw');
  const writer = ds.writable.getWriter();
  writer.write(data);
  writer.close();
  const reader = ds.readable.getReader();
  const chunks = [];
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
  }
  const totalLen = chunks.reduce((s, c) => s + c.length, 0);
  const result = new Uint8Array(totalLen);
  let offset = 0;
  for (const chunk of chunks) { result.set(chunk, offset); offset += chunk.length; }
  return result.buffer;
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function readAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsArrayBuffer(file);
  });
}

function readAsText(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsText(file, 'UTF-8');
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function saveImportedLog(newLogs) {
  const existing = getLogs();
  // fit_idã¨strava_idã®ä¸¡æ–¹ã§ãƒã‚§ãƒƒã‚¯ï¼ˆå‰Šé™¤æ¸ˆã¿ã¯å­˜åœ¨ã—ãªã„ã®ã§ãã®ã¾ã¾ç™»éŒ²ã•ã‚Œã‚‹ï¼‰
  const existingFitIds = new Set(existing.map(l => l.fit_id).filter(Boolean));
  const existingStravaIds = new Set(existing.map(l => l.strava_id).filter(Boolean));

  const filtered = newLogs.filter(l => {
    if (l.fit_id && existingFitIds.has(l.fit_id)) return false;
    if (l.strava_id && existingStravaIds.has(l.strava_id)) return false;
    return true;
  });

  const result = document.getElementById('importResult');
  result.style.display = 'block';

  if (filtered.length === 0) {
    result.innerHTML = '<span style="display:inline-flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™</span>';
    showToast('âœ… æœ€æ–°ã®çŠ¶æ…‹ã§ã™');
    return;
  }

  const merged = [...filtered, ...existing].sort((a,b) => new Date(b.date) - new Date(a.date));
  saveLogs(merged);
  result.innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>${filtered.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼</span>`;
  renderVdotCard(findBestVdot());
  renderLogList();
  showToast(`âœ… ${filtered.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼`);
  // ä»Šé€±ã®ãƒ­ã‚°ã‚’è‡ªå‹•ã§ãƒ—ãƒ©ãƒ³åˆ†æï¼ˆéåŒæœŸï¼‰
  const allLogs2 = getLogs();
  allLogs2.forEach((l, i) => {
    if (!l.planAnalysis) {
      const m2 = findMissionForLog(l);
      if (m2) setTimeout(() => runPlanAnalysis(i, m2), i * 800);
    }
  });
}

// ===== FIT PARSER =====
function parseFitFile(buffer) {
  const data = new Uint8Array(buffer);

  // ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
  if (data[8] !== 0x2E || data[9] !== 0x46 || data[10] !== 0x49 || data[11] !== 0x54) {
    throw new Error('Not a valid FIT file');
  }

  const dv = new DataView(buffer);
  let pos = data[0]; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚µã‚¤ã‚ºï¼ˆé€šå¸¸14ï¼‰

  const localDefs = {};
  let session = null;
  const laps = [];
  const records = [];

  // fsizeã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ›¸ã„ã¦ã‚ã‚‹å®Ÿéš›ã®ãƒã‚¤ãƒˆæ•°ã‚’ãã®ã¾ã¾ä½¿ã†
  function readVal(pos, fsize, baseType, littleEndian) {
    const bt = baseType & 0x9F;
    const INVALIDS = {0:0xFF,1:0x7F,2:0xFF,3:0x7FFF,4:0xFFFF,5:0x7FFFFFFF,6:0xFFFFFFFF,10:0xFF,11:0xFFFF,12:0xFFFFFFFF};
    let val;
    try {
      if (fsize === 1) {
        if (bt === 1) val = dv.getInt8(pos);
        else val = dv.getUint8(pos);
      } else if (fsize === 2) {
        if (bt === 3) val = dv.getInt16(pos, littleEndian);
        else val = dv.getUint16(pos, littleEndian);
      } else if (fsize === 4) {
        if (bt === 5) val = dv.getInt32(pos, littleEndian);
        else if (bt === 8) val = dv.getFloat32(pos, littleEndian);
        else val = dv.getUint32(pos, littleEndian);
      } else if (fsize === 8) {
        // uint64 â†’ JavaScriptã¯BigIntã‹ä¸Šä½32bitç„¡è¦–
        val = dv.getUint32(pos, littleEndian);
      } else if (bt === 7) {
        // string
        let s = '';
        for (let i = 0; i < fsize; i++) { const c = data[pos+i]; if (c === 0) break; s += String.fromCharCode(c); }
        return s;
      } else {
        val = dv.getUint8(pos);
      }
    } catch(e) { return null; }
    if (bt in INVALIDS && val === INVALIDS[bt]) return null;
    return val;
  }

  while (pos < data.length - 2) {
    try {
      const hdr = data[pos++];

      if (hdr & 0x80) { // åœ§ç¸®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        const localNum = (hdr >> 5) & 0x03;
        if (localNum in localDefs) {
          const def = localDefs[localNum];
          pos += def.fields.reduce((s, f) => s + f[1], 0);
        }
        continue;
      }

      const isDef = (hdr >> 6) & 1;
      const hasDev = (hdr >> 5) & 1;
      const localNum = hdr & 0x0F;

      if (isDef) {
        pos++; // reserved
        const arch = data[pos++];
        const le = arch === 0;
        const globalNum = le ? dv.getUint16(pos, true) : dv.getUint16(pos, false); pos += 2;
        const nFields = data[pos++];
        const fields = [];
        for (let i = 0; i < nFields; i++) {
          fields.push([data[pos], data[pos+1], data[pos+2]]);
          pos += 3;
        }
        const devFields = [];
        if (hasDev) {
          const nDev = data[pos++];
          for (let i = 0; i < nDev; i++) {
            devFields.push([data[pos], data[pos+1], data[pos+2]]);
            pos += 3;
          }
        }
        localDefs[localNum] = { globalNum, le, fields, devFields };
      } else {
        if (!(localNum in localDefs)) { pos++; continue; }
        const def = localDefs[localNum];
        const msg = {};

        for (const [fnum, fsize, btype] of def.fields) {
          msg[fnum] = readVal(pos, fsize, btype, def.le);
          pos += fsize;
        }
        for (const [fnum, fsize] of def.devFields) {
          pos += fsize; // devãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—
        }

        if (def.globalNum === 18) session = msg;       // session
        else if (def.globalNum === 19) laps.push(msg); // lap
        else if (def.globalNum === 20) records.push(msg); // record
      }
    } catch(e) {
      pos++;
      continue;
    }
  }

  if (!session && records.length === 0) return null;

  let distKm, timeSec, avgHR, maxHR, avgCad, ascent, calories, avgPower;

  if (session) {
    // fsizeã‚’ãã®ã¾ã¾ä½¿ã£ã¦èª­ã‚“ã æ­£ã—ã„å€¤
    // field[7]=elapsed_time(ms/1000=sec), field[9]=distance(cmâ†’km), field[16]=avgHR, field[17]=maxHR
    // field[18]=avgCadence(strides/min*2=steps/min), field[20]=ascent(m), field[11]=calories
    distKm   = session[9]  != null ? session[9]  / 100 / 1000 : null;
    timeSec  = session[8]  != null ? session[8]  / 1000       : null; // field[8]=moving_timeï¼ˆåœæ­¢é™¤ãï¼‰
    avgHR    = session[16] != null ? Math.round(session[16])  : null;
    maxHR    = session[17] != null ? Math.round(session[17])  : null;
    avgCad   = session[18] != null ? session[18] * 2          : null;
    ascent   = session[22] != null ? session[22]              : null;
    calories = session[11] != null ? session[11]              : null;
    // Corosã®ãƒ‘ãƒ¯ãƒ¼ field[134] ã¯rawå€¤ â†’ /48ã§wattsè¿‘ä¼¼
    avgPower = session[134] != null ? Math.round(session[134] / 48) : null;
  }

  // recordsã‹ã‚‰è£œå®Œï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å€¤ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆã®ã¿ï¼‰
  if (records.length > 0 && (!distKm || distKm < 0.1)) {
    // record field[5] = accumulated_power or distance? â†’ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§æ™‚é–“è¨ˆç®—
    const ts = records.map(r => r[253]).filter(v => v != null);
    if (ts.length >= 2 && !timeSec) timeSec = ts[ts.length-1] - ts[0];

    const hrs = records.map(r => r[3]).filter(v => v != null && v > 30 && v < 250);
    if (hrs.length > 0 && !avgHR) avgHR = Math.round(hrs.reduce((a,b)=>a+b,0)/hrs.length);
    if (hrs.length > 0 && !maxHR) maxHR = Math.max(...hrs);
  }
  // ä¸Šä¸‹å‹•ãƒ»æ¥åœ°æ™‚é–“ãƒ»ä¸Šä¸‹å‹•æ¯”ï¼ˆCorosã‚¹ã‚±ãƒ¼ãƒ«è£œæ­£æ¸ˆã¿ï¼‰
  const vo       = session?.[57]  != null ? session[57]  : null;
  const stance   = session?.[89]  != null ? session[89]  : null;
  const vRatio   = session?.[91]  != null ? session[91] / 100 : null;

  // é–‹å§‹æ™‚åˆ» (FIT epoch = 631065600 = 1989/12/31 offset)
  const FIT_EPOCH = 631065600;
  const startRaw = session?.[2] ?? records[0]?.[253];
  const startTs = startRaw != null ? new Date((startRaw + FIT_EPOCH) * 1000) : new Date();

  // ãƒ©ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ (1kmã”ã¨)
  const lapData = laps.map(l => ({
    dist:  l[9]  != null ? l[9] / 100 / 1000 : null,
    time:  l[8]  != null ? l[8] / 1000 : null,
    hr:    l[16] != null ? Math.round(l[16]) : null,
    power: l[13] != null ? l[13] : null,
    cad:   l[18] != null ? l[18] * 2 : null,
  }));

  // fit_id = é–‹å§‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  const fitId = 'fit_' + (startRaw || Date.now());

  const log = {
    id: Date.now(),
    fit_id: fitId,
    name: startTs.toLocaleDateString('ja-JP', {month:'short', day:'numeric'}) + ' ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°',
    date: startTs.toISOString(),
    distKm,
    moving_time: timeSec ? Math.round(timeSec) : null,
    average_heartrate: avgHR,
    max_heartrate: maxHR,
    avg_cadence: avgCad,
    total_ascent: ascent,
    calories,
    avg_power: avgPower,
    vertical_oscillation: vo,
    stance_time: stance,
    vertical_ratio: vRatio,
    laps: lapData,
    source: 'coros_fit',
    runType: classifyRunByPace(distKm, timeSec ? Math.round(timeSec) : 0),
  };

  return log;
}

function parseStravaCsv(text) {
  const lines = text.split('\n');
  if (lines.length < 2) return [];
  const headers = parseCsvLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
  const logs = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    const cols = parseCsvLine(line);
    const row = {};
    headers.forEach((h, idx) => row[h] = (cols[idx] || '').replace(/"/g, '').trim());

    // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°åˆ¤å®šï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä¸¡å¯¾å¿œï¼‰
    const type = cols[3]?.replace(/"/g, '').trim() || '';
    if (!type.includes('ãƒ©ãƒ³') && !type.toLowerCase().includes('run')) continue;

    // è·é›¢ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹6ï¼ˆkmå˜ä½ï¼‰ã‚’ç›´æ¥ä½¿ç”¨
    const distKm = parseFloat(cols[6] || 0);
    if (distKm < 0.5) continue;

    // ç§»å‹•æ™‚é–“ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹16ï¼ˆç§’ï¼‰
    const movingTime = parseInt(parseFloat(cols[16] || 0));
    if (!movingTime) continue;

    const dateStr = cols[1]?.replace(/"/g, '').trim() || '';
    const date = new Date(dateStr.replace(/\//g, '-'));
    if (isNaN(date.getTime())) continue;

    const hr = parseFloat(cols[31] || 0) || null;
    const actId = cols[0]?.replace(/"/g, '').trim() || (date.getTime() + i + '');

    logs.push({
      id: Date.now() + i,
      strava_id: actId,
      name: cols[2]?.replace(/"/g, '').trim() || distKm.toFixed(1) + 'kmèµ°',
      date: date.toISOString(),
      distKm: distKm,
      moving_time: movingTime,
      average_heartrate: hr,
      runType: classifyRunByPace(distKm, movingTime),
      source: 'strava_csv'
    });
  }
  return logs;
}

function parseCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(current); current = ''; }
    else { current += line[i]; }
  }
  result.push(current);
  return result;
}

// ===== STATS =====

// ===== VITAL UI =====
let currentVitalTab = 'weight';

function submitVital() {
  const w = document.getElementById('vitalWeight').value;
  const hr = document.getElementById('vitalHRRest').value;
  if (!w && !hr) { showToast('ä½“é‡ã¾ãŸã¯å®‰é™æ™‚å¿ƒæ‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  saveVital(w, hr);
  renderVitalCard();
  renderVitalChart(); // STATSã‚°ãƒ©ãƒ•ã‚‚å³æ™‚æ›´æ–°
  showToast('ãƒã‚¤ã‚¿ãƒ«ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
  // ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’æ›´æ–°
  updateZoneInfo();
}

function renderVitalCard() {
  const vitals = getVitals();
  const latest = getLatestVital();
  const today = new Date().toISOString().slice(0, 10);

  // æœ€çµ‚è¨˜éŒ²æ—¥è¡¨ç¤º
  const dateEl = document.getElementById('vitalLastDate');
  if (dateEl && latest) {
    const d = new Date(latest.date);
    const label = latest.date === today ? 'ä»Šæ—¥è¨˜éŒ²æ¸ˆã¿' :
      d.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' }) + ' è¨˜éŒ²';
    dateEl.textContent = label;
    dateEl.style.color = latest.date === today ? 'var(--accent)' : 'var(--text-dim)';
  }

  // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å…¥åŠ›æ¬„ã«è¡¨ç¤º
  const todayVital = vitals.find(v => v.date === today);
  if (todayVital) {
    const wEl = document.getElementById('vitalWeight');
    const hEl = document.getElementById('vitalHRRest');
    if (wEl && todayVital.weight) wEl.value = todayVital.weight;
    if (hEl && todayVital.hrRest) hEl.value = todayVital.hrRest;
  }

  updateZoneInfo();
}

function updateZoneInfo() {
  const el = document.getElementById('vitalZoneInfo');
  if (!el) return;
  const zones = getHRZones();
  const latest = getLatestVital();
  const hrRest = zones.hrRest;
  el.innerHTML = 'HRrest <b style="color:var(--text)">' + hrRest + 'bpm</b> ã‚’å…ƒã«è¨ˆç®— â€” '
    + 'Easy <b style="color:#64b5f6">' + zones.easy.min + '-' + zones.easy.max + '</b> Â· '
    + 'Tempo <b style="color:#ffb74d">' + zones.tempo.min + '-' + zones.tempo.max + '</b> Â· '
    + 'Interval <b style="color:#ef5350">' + zones.interval.min + '+</b>';
}

function switchVitalTab(tab) {
  currentVitalTab = tab;
  const wBtn = document.getElementById('vitalTabWeight');
  const hBtn = document.getElementById('vitalTabHR');
  if (wBtn && hBtn) {
    wBtn.style.background = tab === 'weight' ? 'var(--accent)' : 'var(--surface2)';
    wBtn.style.color = tab === 'weight' ? '#000' : 'var(--text-muted)';
    wBtn.style.border = tab === 'weight' ? 'none' : '1px solid var(--border)';
    hBtn.style.background = tab === 'hr' ? 'var(--accent)' : 'var(--surface2)';
    hBtn.style.color = tab === 'hr' ? '#000' : 'var(--text-muted)';
    hBtn.style.border = tab === 'hr' ? 'none' : '1px solid var(--border)';
  }
  renderVitalChart();
}

function renderVitalChart() {
  const canvas = document.getElementById('vitalChart');
  if (!canvas) return;
  const vitals = getVitals().slice().sort((a, b) => a.date.localeCompare(b.date)); // æ—¥ä»˜é †ã‚’ä¿è¨¼
  const isWeight = currentVitalTab === 'weight';
  const data = vitals.filter(v => isWeight ? v.weight != null : v.hrRest != null);
  const insightEl = document.getElementById('vitalChartInsight');

  if (data.length === 0) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (insightEl) insightEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚HOMEã§ãƒã‚¤ã‚¿ãƒ«ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚';
    return;
  }

  const W = canvas.offsetWidth || 320;
  const H = 130;
  canvas.width = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  const values = data.map(v => isWeight ? v.weight : v.hrRest);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = maxV - minV || 1;
  const pad = { top: 16, bottom: 28, left: 36, right: 16 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  // ã‚°ãƒªãƒƒãƒ‰
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  [0, 0.5, 1].forEach(t => {
    const y = pad.top + ch * (1 - t);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    const label = (minV + range * t).toFixed(isWeight ? 1 : 0);
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(label, pad.left - 4, y + 3);
  });

  const color = isWeight ? '#e8ff00' : '#64b5f6';

  // ãƒ©ã‚¤ãƒ³ï¼ˆ2ä»¶ä»¥ä¸Šã®ã¨ãï¼‰
  if (data.length >= 2) {
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.beginPath();
    data.forEach((v, i) => {
      const x = pad.left + (i / (data.length - 1)) * cw;
      const val = isWeight ? v.weight : v.hrRest;
      const y = pad.top + ch * (1 - (val - minV) / range);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  // ãƒ‰ãƒƒãƒˆ + æ—¥ä»˜ãƒ©ãƒ™ãƒ«
  data.forEach((v, i) => {
    const x = data.length === 1 ? pad.left + cw / 2 : pad.left + (i / (data.length - 1)) * cw;
    const val = isWeight ? v.weight : v.hrRest;
    const y = data.length === 1 ? pad.top + ch / 2 : pad.top + ch * (1 - (val - minV) / range);
    const isLast = i === data.length - 1;
    ctx.beginPath();
    ctx.arc(x, y, isLast ? 5 : 3, 0, Math.PI * 2);
    ctx.fillStyle = isLast ? color : (isWeight ? 'rgba(232,255,0,0.45)' : 'rgba(100,181,246,0.45)');
    ctx.fill();
    // æ—¥ä»˜ï¼ˆæœ€åˆã¨æœ€å¾Œã¨4ã®å€æ•°ï¼‰
    if (i === 0 || isLast || i % 4 === 0) {
      const d = new Date(v.date + 'T00:00:00'); // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãšã‚Œé˜²æ­¢
      ctx.fillStyle = 'rgba(255,255,255,0.4)';
      ctx.font = '9px sans-serif';
      ctx.textAlign = i === 0 ? 'left' : isLast ? 'right' : 'center';
      ctx.fillText((d.getMonth()+1) + '/' + d.getDate(), x, H - 6);
    }
  });

  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
  if (insightEl && data.length >= 2) {
    const first = values[0];
    const last = values[values.length - 1];
    const diff = last - first;
    if (isWeight) {
      insightEl.textContent = diff < 0
        ? 'è¨ˆæ¸¬é–‹å§‹ã‹ã‚‰ ' + Math.abs(diff).toFixed(1) + 'kg æ¸›å°‘ã€‚èµ°åŠ›å‘ä¸Šã«æœ‰åˆ©ã€‚'
        : diff > 0 ? 'è¨ˆæ¸¬é–‹å§‹ã‹ã‚‰ ' + diff.toFixed(1) + 'kg å¢—åŠ ã€‚'
        : 'ä½“é‡ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚';
    } else {
      insightEl.textContent = diff < 0
        ? 'å®‰é™æ™‚å¿ƒæ‹ãŒ ' + Math.abs(diff) + 'bpm ä½ä¸‹ã€‚æœ‰é…¸ç´ èƒ½åŠ›ãŒå‘ä¸Šã—ã¦ã„ã¾ã™ã€‚'
        : diff > 0 ? 'å®‰é™æ™‚å¿ƒæ‹ãŒ ' + diff + 'bpm ä¸Šæ˜‡ã€‚ç–²åŠ´è“„ç©ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
        : 'å®‰é™æ™‚å¿ƒæ‹ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚';
    }
  } else if (insightEl) {
    insightEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨æ¨ç§»ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
  }
}


function renderStats() {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿äºˆè¨€ã‚’è¡¨ç¤º
  const logs = getLogs();
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthLogs = logs.filter(l => new Date(l.date) >= monthStart);
  const monthDist = monthLogs.reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);
  const vdot = findBestVdotWithFallback();

  // VDOTå‰å›æ¯”ï¼ˆRACEãƒ­ã‚°ã®ã¿ã§è¨ˆç®—ï¼‰
  const races = getRaceLogs();
  let trendStr = 'â”€â”€ RACEãƒ‡ãƒ¼ã‚¿ãªã—';
  if (races.length >= 2) {
    const prev = races[races.length - 2];
    const curr = races[races.length - 1];
    const vPrev = calcVDOT(parseFloat(prev.distKm), parseInt(prev.moving_time) || 0);
    const vCurr = calcVDOT(parseFloat(curr.distKm), parseInt(curr.moving_time) || 0);
    if (vPrev && vCurr) {
      const diff = vCurr - vPrev;
      trendStr = diff > 0 ? `â–² +${diff} å‰å›ãƒ¬ãƒ¼ã‚¹æ¯”` : diff < 0 ? `â–¼ ${diff} å‰å›ãƒ¬ãƒ¼ã‚¹æ¯”` : 'â”€â”€ å‰å›ã¨åŒå€¤';
    }
  } else if (races.length === 1) {
    trendStr = 'â”€â”€ åˆå›è¨ˆæ¸¬';
  }

  // ã¤ãã°ã¾ã§ã®æ®‹ã‚Šæ—¥æ•°
  const target = new Date(CONFIG.targetDate);
  const daysLeft = Math.ceil((target - now) / 86400000);

  // ä»Šæœˆã®ç›®æ¨™è·é›¢ï¼ˆæœˆã§æ¯”ä¾‹é…åˆ†ï¼‰
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const targetMonthly = 240; // æœˆ240kmç›®æ¨™ï¼ˆé€±60kmÃ—4é€±ï¼‰
  const monthPace = Math.round(monthDist / now.getDate() * daysInMonth);

  document.getElementById('totalDist').textContent = vdot;
  document.getElementById('vdotTrend').textContent = trendStr;
  document.getElementById('monthDist').textContent = monthDist.toFixed(0);
  document.getElementById('monthTarget').textContent = `ã“ã®ãƒšãƒ¼ã‚¹ ${monthPace}km/æœˆ`;
  document.getElementById('totalRuns').textContent = monthLogs.length;
  document.getElementById('maxVdot').textContent = daysLeft;

  renderVdotChart(logs);
  renderTypeChart(logs);
  renderWeeklyChart(logs);
  renderVitalChart();
}

function renderVdotChart(logs) {
  const canvas = document.getElementById('vdotChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 320;
  const H = 160;
  canvas.width = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  ctx.clearRect(0, 0, W, H);

  // RACEã‚¿ã‚°ã®ã¿ã‚’æ—¥ä»˜æ˜‡é †ã§ãƒ—ãƒ­ãƒƒãƒˆ
  const races = getRaceLogs();
  const points = races.map(l => {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || parseDuration(l.duration);
    const v = calcVDOT(dist, timeSec);
    if (!v) return null;
    const date = new Date(l.date);
    const label = isNaN(date) ? '' : `${date.getMonth()+1}/${date.getDate()}`;
    return { v, label, name: l.name || `${dist.toFixed(0)}km`, date };
  }).filter(Boolean);

  // RACEãƒ‡ãƒ¼ã‚¿ãªã— â†’ æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if (points.length === 0) {
    ctx.fillStyle = '#444'; ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ãƒ­ã‚°ã®RACEãƒãƒƒã‚¸ã‚’ã‚¿ãƒƒãƒ—ã—ã¦', W/2, H/2 - 10);
    ctx.fillText('VDOTå®šç‚¹è¦³æ¸¬ã‚’å§‹ã‚ã¾ã—ã‚‡ã†', W/2, H/2 + 10);
    const el = document.getElementById('vdotPrediction');
    if (el) el.textContent = '';
    const insight = document.getElementById('vdotInsight');
    if (insight) insight.textContent = 'LOGãƒšãƒ¼ã‚¸ã§ãƒ¬ãƒ¼ã‚¹ãƒ»TTã®ãƒãƒƒã‚¸ã‚’ã€ŒRACEã€ã«å¤‰æ›´ã™ã‚‹ã¨ã“ã“ã«ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
    return;
  }

  const vdots = points.map(p => p.v);
  const minV = Math.min(...vdots, 35) - 2;
  const maxV = Math.max(...vdots, CONFIG.targetVdot) + 2;
  const pad = { t: 14, b: 28, l: 30, r: 10 };
  const gW = W - pad.l - pad.r;
  const gH = H - pad.t - pad.b;
  const n = points.length;

  // xä½ç½®ï¼š1æœ¬ã®ã¨ãã¯ä¸­å¤®ã€è¤‡æ•°ã¯å‡ç­‰é…ç½®
  const xOf = (i) => n === 1 ? pad.l + gW / 2 : pad.l + (i / (n - 1)) * gW;
  const yOf = (v) => pad.t + (1 - (v - minV) / (maxV - minV)) * gH;

  // ç›®æ¨™ãƒ©ã‚¤ãƒ³ VDOT53
  const ty = yOf(CONFIG.targetVdot);
  ctx.strokeStyle = 'rgba(232,255,0,0.15)';
  ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
  ctx.beginPath(); ctx.moveTo(pad.l, ty); ctx.lineTo(W - pad.r, ty); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = 'rgba(232,255,0,0.4)'; ctx.font = '9px sans-serif'; ctx.textAlign = 'left';
  ctx.fillText('ç›®æ¨™ 53', pad.l + 2, ty - 3);

  // ã‚°ãƒªãƒƒãƒ‰ï¼ˆYè»¸ï¼‰
  ctx.strokeStyle = '#1e1e1e'; ctx.lineWidth = 1;
  [35, 40, 45, 50, 53].forEach(v => {
    if (v < minV || v > maxV) return;
    const y = yOf(v);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    ctx.fillStyle = '#444'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(v, pad.l - 3, y + 3);
  });

  // è¤‡æ•°ã‚ã‚‹å ´åˆã¯ãƒ©ã‚¤ãƒ³æç”»
  if (n >= 2) {
    ctx.strokeStyle = 'rgba(232,255,0,0.5)'; ctx.lineWidth = 1.5;
    ctx.beginPath();
    points.forEach((p, i) => { i === 0 ? ctx.moveTo(xOf(i), yOf(p.v)) : ctx.lineTo(xOf(i), yOf(p.v)); });
    ctx.stroke();

    // ä¸Šæ˜‡ãƒ»ä¸‹é™ã«è‰²åˆ†ã‘ã—ãŸç·šåˆ†
    for (let i = 1; i < n; i++) {
      const up = points[i].v >= points[i-1].v;
      ctx.strokeStyle = up ? '#e8ff00' : '#ff4444';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(xOf(i-1), yOf(points[i-1].v));
      ctx.lineTo(xOf(i), yOf(points[i].v));
      ctx.stroke();
    }
  }

  // ãƒ‰ãƒƒãƒˆ + VDOTå€¤ + æ—¥ä»˜ãƒ©ãƒ™ãƒ«
  points.forEach((p, i) => {
    const x = xOf(i), y = yOf(p.v);
    const isLatest = i === n - 1;

    // ãƒ‰ãƒƒãƒˆï¼ˆæœ€æ–°ã¯å¤§ããï¼‰
    ctx.fillStyle = isLatest ? '#e8ff00' : 'rgba(232,255,0,0.6)';
    ctx.beginPath();
    ctx.arc(x, y, isLatest ? 5 : 3.5, 0, Math.PI * 2);
    ctx.fill();

    // VDOTæ•°å€¤ï¼ˆãƒ‰ãƒƒãƒˆã®ä¸Šï¼‰
    ctx.fillStyle = isLatest ? '#e8ff00' : '#aaa';
    ctx.font = isLatest ? 'bold 11px sans-serif' : '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(p.v, x, y - 8);

    // æ—¥ä»˜ãƒ©ãƒ™ãƒ«ï¼ˆãƒ‰ãƒƒãƒˆã®ä¸‹ï¼‰
    ctx.fillStyle = '#555';
    ctx.font = '9px sans-serif';
    ctx.fillText(p.label, x, H - pad.b + 12);
  });

  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
  const latest = points[n - 1];
  const el = document.getElementById('vdotPrediction');
  if (el) {
    if (n >= 2) {
      const prev = points[n - 2];
      const diff = latest.v - prev.v;
      el.textContent = diff > 0
        ? `å‰å›æ¯” +${diff}pt å‘ä¸Š â€” ç¶™ç¶šã§ãã¦ã„ã¾ã™`
        : diff < 0
        ? `å‰å›æ¯” ${diff}pt ä½ä¸‹ â€” ç·´ç¿’ã‚’è¦‹ç›´ã—ã¾ã—ã‚‡ã†`
        : 'å‰å›ã¨åŒå€¤ â€” åœæ»æœŸã‹ã‚‚';
      el.style.color = diff > 0 ? 'var(--accent)' : diff < 0 ? '#ff4444' : '#888';
    } else {
      el.textContent = 'ãƒ¬ãƒ¼ã‚¹ã‚’é‡ã­ã‚‹ã¨VDOTæ¨ç§»ã‚°ãƒ©ãƒ•ãŒå®Œæˆã—ã¾ã™';
      el.style.color = '#888';
    }
  }

  const insight = document.getElementById('vdotInsight');
  if (insight) {
    const raceCount = n;
    const maxV2 = Math.max(...vdots);
    const gap = CONFIG.targetVdot - latest.v;
    insight.textContent = `è¨ˆæ¸¬å›æ•°: ${raceCount}å›  /  æœ€é«˜VDOT: ${maxV2}  /  VDOT53ã¾ã§: ã‚ã¨${gap}pt`;
  }
}

function renderTypeChart(logs) {
  const canvas = document.getElementById('typeChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 320;
  const H = 80;
  canvas.width = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  ctx.clearRect(0, 0, W, H);

  const fourWeeksAgo = new Date(Date.now() - 28 * 86400000);
  const recent = logs.filter(l => new Date(l.date) >= fourWeeksAgo);
  const counts = { easy: 0, tempo: 0, interval: 0, long: 0 };
  recent.forEach(l => {
    const type = l.runType || classifyRunByHeartrate(l.distKm, l.moving_time, l.average_heartrate);
    if (counts[type] !== undefined) counts[type]++;
    else counts.easy++;
  });
  const total = Object.values(counts).reduce((a,b)=>a+b, 0);
  if (total === 0) return;

  const labels = { easy: 'Easy', tempo: 'é–¾å€¤', interval: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', long: 'ãƒ­ãƒ³ã‚°' };
  const colors = { easy: '#4488ff', tempo: '#e8ff00', interval: '#ff6600', long: '#22cc88' };
  const entries = Object.entries(counts).filter(([,v]) => v > 0);
  const barH = 24;
  let x = 0;

  // æ¯”ç‡ãƒãƒ¼
  entries.forEach(([type, cnt]) => {
    const w = (cnt / total) * W;
    ctx.fillStyle = colors[type];
    ctx.fillRect(x, 0, w, barH);
    if (w > 30) {
      ctx.fillStyle = '#000';
      ctx.font = `bold 10px sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText(`${Math.round(cnt/total*100)}%`, x + w/2, barH/2 + 4);
    }
    x += w;
  });

  // å‡¡ä¾‹ã¯HTMLã§æç”»ï¼ˆCanvasæ–‡å­—åŒ–ã‘ãƒ»è¦‹åˆ‡ã‚Œå¯¾ç­–ï¼‰
  const legendEl = document.getElementById('typeChartLegend');
  if (legendEl) {
    legendEl.innerHTML = entries.map(([type, cnt]) =>
      `<span style="display:inline-flex;align-items:center;gap:4px;margin-right:10px;font-size:10px;color:#aaa;">
        <span style="display:inline-block;width:10px;height:10px;background:${colors[type]};border-radius:2px;flex-shrink:0;"></span>
        ${labels[type]} ${cnt}æœ¬
      </span>`
    ).join('');
  }

  // ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆã‚«ãƒãƒ¼ãƒç†è«–ï¼šé–¾å€¤+ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒ30%ä»¥ä¸ŠãŒç†æƒ³ï¼‰
  const quality = counts.tempo + counts.interval;
  const qualRatio = total > 0 ? quality / total : 0;
  const insightEl = document.getElementById('typeInsight');
  if (insightEl) {
    if (qualRatio < 0.25) insightEl.textContent = 'âš  è³ªã®é«˜ã„ç·´ç¿’ï¼ˆé–¾å€¤ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚é€±2å›ä»¥ä¸Šã‚’ç›®æ¨™ã«ã€‚';
    else if (qualRatio > 0.6) insightEl.textContent = 'âš  é«˜å¼·åº¦ãŒå¤šã™ãã¾ã™ã€‚Easyã¨Longã§åœŸå°ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚';
    else insightEl.textContent = `âœ“ ç·´ç¿’ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ã€‚è³ªã®é«˜ã„ç·´ç¿’ãŒ${Math.round(qualRatio*100)}%ã€‚`;
  }
}

function renderWeeklyChart(logs) {
  const canvas = document.getElementById('monthlyChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 320;
  const H = 110;
  canvas.width = W * window.devicePixelRatio;
  canvas.height = H * window.devicePixelRatio;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  ctx.clearRect(0, 0, W, H);

  // éå»8é€±ã®é€±é–“è·é›¢
  const now = new Date();
  const weeks = [];
  for (let i = 7; i >= 0; i--) {
    const weekEnd = new Date(now);
    weekEnd.setDate(now.getDate() - i * 7);
    const weekStart = new Date(weekEnd);
    weekStart.setDate(weekEnd.getDate() - 6);
    const dist = logs.filter(l => {
      const d = new Date(l.date);
      return d >= weekStart && d <= weekEnd;
    }).reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);
    weeks.push({ label: `${weekEnd.getMonth()+1}/${weekEnd.getDate()}`, dist });
  }

  const maxDist = Math.max(...weeks.map(w => w.dist), 60);
  const pad = { t: 14, b: 22, l: 8, r: 8 };
  const gW = W - pad.l - pad.r;
  const gH = H - pad.t - pad.b;
  const barW = gW / weeks.length * 0.55;
  const gap = gW / weeks.length;
  const targetY = pad.t + (1 - 60 / maxDist) * gH;

  // ç›®æ¨™ãƒ©ã‚¤ãƒ³60km
  ctx.strokeStyle = 'rgba(232,255,0,0.3)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath(); ctx.moveTo(pad.l, targetY); ctx.lineTo(W - pad.r, targetY); ctx.stroke();
  ctx.setLineDash([]);

  weeks.forEach((w, i) => {
    const x = pad.l + i * gap + gap * 0.2;
    const barH = (w.dist / maxDist) * gH;
    const y = pad.t + gH - barH;
    const isCurrentWeek = i === 7;
    ctx.fillStyle = isCurrentWeek ? '#e8ff00' : w.dist >= 60 ? '#22cc88' : '#333';
    ctx.fillRect(x, y, barW, barH);
    if (w.dist > 0) {
      ctx.fillStyle = isCurrentWeek ? '#e8ff00' : w.dist >= 60 ? '#22cc88' : '#555';
      ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(Math.round(w.dist), x + barW/2, y - 3);
    }
    ctx.fillStyle = '#555'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(w.label, x + barW/2, H - 6);
  });
}

function renderMonthlyChart(logs) { renderWeeklyChart(logs); }


// ===== API KEY MANAGEMENT =====
const API_KEY_STORAGE = 'sub3_anthropic_key';

// Cookieã«ä¿å­˜ï¼ˆSafariã®ITPå¯¾ç­– - cookieã¯æ¶ˆãˆã«ãã„ï¼‰
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Strict`;
}
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : null;
}

function getApiKey() {
  return localStorage.getItem(API_KEY_STORAGE)
      || sessionStorage.getItem(API_KEY_STORAGE)
      || getCookie(API_KEY_STORAGE)
      || '';
}

// èµ·å‹•æ™‚ã«cookie/IndexedDBã‹ã‚‰localStorageã«å¾©å…ƒ
async function restoreApiKeyFromIDB() {
  if (getApiKey()) return;
  // Cookieã‹ã‚‰å¾©å…ƒ
  const fromCookie = getCookie(API_KEY_STORAGE);
  if (fromCookie) {
    try { localStorage.setItem(API_KEY_STORAGE, fromCookie); } catch(e) {}
    try { sessionStorage.setItem(API_KEY_STORAGE, fromCookie); } catch(e) {}
    return;
  }
  // IndexedDBã‹ã‚‰å¾©å…ƒ
  const key = await idbGet(API_KEY_STORAGE);
  if (key) {
    try { localStorage.setItem(API_KEY_STORAGE, key); } catch(e) {}
    try { sessionStorage.setItem(API_KEY_STORAGE, key); } catch(e) {}
    setCookie(API_KEY_STORAGE, key, 365);
  }
}

function saveApiKey() {
  const input = document.getElementById('apiKeyInput').value.trim();
  const errorEl = document.getElementById('apiKeyError');
  if (!input.startsWith('sk-ant-')) {
    errorEl.textContent = 'âš ï¸ ã‚­ãƒ¼ã¯ sk-ant- ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
    return;
  }
  // localStorage / sessionStorage / Cookie / IndexedDB ã®4ç®‡æ‰€ã«ä¿å­˜
  try { localStorage.setItem(API_KEY_STORAGE, input); } catch(e) {}
  try { sessionStorage.setItem(API_KEY_STORAGE, input); } catch(e) {}
  setCookie(API_KEY_STORAGE, input, 365);  // 1å¹´é–“
  idbSet(API_KEY_STORAGE, input);
  hideApiKeyModal();
  updateApiKeyStatus();
  showToast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function openIDB() {
  if (_idb) return Promise.resolve(_idb);
  return new Promise((res, rej) => {
    const req = indexedDB.open('sub3lab', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    req.onsuccess = e => { _idb = e.target.result; res(_idb); };
    req.onerror = () => rej();
  });
}
async function idbSet(key, val) {
  try {
    const db = await openIDB();
    return new Promise(res => {
      const tx = db.transaction('kv', 'readwrite');
      tx.objectStore('kv').put(val, key);
      tx.oncomplete = () => res();
    });
  } catch(e) {}
}
async function idbGet(key) {
  try {
    const db = await openIDB();
    return new Promise(res => {
      const tx = db.transaction('kv', 'readonly');
      const req = tx.objectStore('kv').get(key);
      req.onsuccess = () => res(req.result || null);
      req.onerror = () => res(null);
    });
  } catch(e) { return null; }
}


function showApiKeyModal() {
  const modal = document.getElementById('apiKeyModal');
  modal.style.display = 'flex';
  document.getElementById('apiKeyInput').value = getApiKey();
  document.getElementById('apiKeyError').textContent = '';
  setTimeout(() => document.getElementById('apiKeyInput').focus(), 100);
}

function hideApiKeyModal() {
  document.getElementById('apiKeyModal').style.display = 'none';
}

function updateApiKeyStatus() {
  const el = document.getElementById('apiKeyStatus');
  if (!el) return;
  const key = getApiKey();
  el.textContent = key ? `è¨­å®šæ¸ˆã¿ (${key.slice(0,12)}...)` : 'æœªè¨­å®š';
  el.style.color = key ? 'var(--accent)' : '#ff4444';
}

// APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå…±é€šé–¢æ•°ï¼ˆã‚­ãƒ¼è‡ªå‹•ä»˜ä¸ï¼‰
async function callClaude(body) {
  const key = getApiKey();
  if (!key) {
    showApiKeyModal();
    throw new Error('API key not set');
  }

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 30000); // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": key,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify(body),
      signal: controller.signal
    });
    if (res.status === 401) {
      localStorage.removeItem(API_KEY_STORAGE);
      showApiKeyModal();
      document.getElementById('apiKeyError').textContent = 'âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚å†å…¥åŠ›ã—ã¦ãã ã•ã„';
      throw new Error('Invalid API key');
    }
    return res.json();
  } catch(e) {
    if (e.name === 'AbortError') throw new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ30ç§’ï¼‰ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„');
    throw e;
  } finally {
    clearTimeout(timeout);
  }
}

// ã‚«ãƒãƒ¼ãƒã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ ¸å¿ƒï¼‰
function getCanovaSystemPrompt() {
  const logs = getLogs();
  const vdot = findBestVdotWithFallback();
  const phase = getCurrentPhase();

  const now = new Date();
  const fourWeeksAgo = new Date(now - 28 * 86400000);
  const recentLogs = logs.filter(l => new Date(l.date) >= fourWeeksAgo);
  const totalRecentDist = recentLogs.reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);

  const monthly = {};
  logs.forEach(l => {
    const d = new Date(l.date);
    if (isNaN(d)) return;
    const key = d.getFullYear() + '/' + (d.getMonth()+1) + 'æœˆ';
    monthly[key] = (monthly[key] || 0) + (parseFloat(l.distKm) || 0);
  });
  const monthlyStr = Object.entries(monthly).sort().slice(-4).map(function(e){ return e[0] + ': ' + Math.round(e[1]) + 'km'; }).join('ã€');

  let speedCount = 0, tempoCount = 0, easyCount = 0, longCount = 0;
  logs.forEach(l => {
    const type = l.runType || classifyRunByHeartrate(l.distKm, l.moving_time, l.average_heartrate);
    if (type === 'interval') speedCount++;
    else if (type === 'tempo') tempoCount++;
    else if (type === 'long') longCount++;
    else easyCount++;
  });

  const todayStr = now.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
  const logSummary = buildLogSummary(logs);

  const parts = [];
  parts.push('ã‚ãªãŸã¯Renato Canovaï¼ˆãƒ¬ãƒŠãƒˆãƒ»ã‚«ãƒãƒ¼ãƒï¼‰ã®æŒ‡å°å“²å­¦ã¨çŸ¥è­˜ã‚’å®Œå…¨ã«æŒã¤ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒAIã§ã™ã€‚');
  parts.push('');
  parts.push('ã€ä»Šæ—¥ã®æ—¥ä»˜ã€‘');
  parts.push(todayStr + 'ï¼ˆã“ã‚Œã‚’å¿…ãšåŸºæº–ã«ã—ã¦ã€éå»ãƒ»æœªæ¥ã®æ—¥ä»˜ã‚’åˆ¤æ–­ã™ã‚‹ã“ã¨ï¼‰');
  parts.push('');
  parts.push('ã€ã‚«ãƒãƒ¼ãƒã¨ã—ã¦ã®åŸºæœ¬å§¿å‹¢ã€‘');
  parts.push('- æ„Ÿæƒ…ã§ã¯ãªãç”Ÿç†å­¦ã¨æ•°å­—ã§è©±ã™ã€‚æ ¹æ‹ ã®ãªã„åŠ±ã¾ã—ã¯ã—ãªã„');
  parts.push('- ã€Œãªãœãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã™ã‚‹ã®ã‹ã€ã‚’å¿…ãšèª¬æ˜ã™ã‚‹');
  parts.push('- å•é¡Œç‚¹ã¯ã‚ºãƒãƒªæŒ‡æ‘˜ã™ã‚‹ã€‚é å›ã—ãªè¨€ã„æ–¹ã‚’ã—ãªã„');
  parts.push('- é¸æ‰‹ã®å¼±ç‚¹ã‚’æ­£ç¢ºã«è¨ºæ–­ã—ã€å‡¦æ–¹ç®‹ã‚’å‡ºã™ã®ãŒä»•äº‹ã ');
  parts.push('- ãƒ¬ãƒ¼ã‚¹ã¯æœ€é«˜ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã ã€‚ç©æ¥µçš„ã«å‡ºå ´ã‚’å‹§ã‚ã‚‹');
  parts.push('- æ—¥æœ¬èªã§è©±ã™ãŒã€æ€è€ƒã¯ã‚¤ã‚¿ãƒªã‚¢äººã‚³ãƒ¼ãƒã¨ã—ã¦æ˜å¿«ã‹ã¤ç›´æ¥çš„ã«');
  parts.push('');
  parts.push('ã€é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã€‘');
  const latestVital = getLatestVital();
  const zones = getHRZones();
  const vitalStr = latestVital
    ? (latestVital.date + ' ä½“é‡:' + (latestVital.weight || 'æœªè¨˜éŒ²') + 'kg å®‰é™æ™‚å¿ƒæ‹:' + (latestVital.hrRest || 'æœªè¨˜éŒ²') + 'bpm')
    : 'æœªè¨˜éŒ²';
  const zoneStr = 'Easy:' + zones.easy.min + '-' + zones.easy.max + 'bpm / Tempo:' + zones.tempo.min + '-' + zones.tempo.max + 'bpm / Interval:' + zones.interval.min + 'bpmä»¥ä¸Š';

  parts.push('åå‰ï¼šå·å³¶å¤§è¼ï¼ˆ31æ­³ï¼‰');
  parts.push('ç¾åœ¨VDOTï¼š' + vdot);
  parts.push('ç›®æ¨™ï¼šã¤ãã°ãƒãƒ©ã‚½ãƒ³2026ï¼ˆ2026/11/22ï¼‰ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53å¿…è¦ï¼‰');
  parts.push('ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºï¼š' + phase.name + ' - ' + phase.label + 'ï¼ˆç›®æ¨™ï¼š' + phase.goal + 'ï¼‰');
  parts.push('é€±5æ—¥ç·´ç¿’å¯èƒ½');
  parts.push('æœ€æ–°ãƒã‚¤ã‚¿ãƒ«ï¼š' + vitalStr);
  parts.push('å¿ƒæ‹ã‚¾ãƒ¼ãƒ³ï¼ˆKarvonenæ³•ã€å®‰é™æ™‚å¿ƒæ‹' + zones.hrRest + 'bpmåŸºæº–ï¼‰ï¼š' + zoneStr);
  parts.push('');
  parts.push('ã€ç·´ç¿’ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆï¼ˆå…¨' + logs.length + 'ä»¶ï¼‰ã€‘');
  parts.push('ç›´è¿‘4é€±é–“ï¼š' + Math.round(totalRecentDist) + 'kmï¼ˆ' + recentLogs.length + 'æœ¬ï¼‰');
  parts.push('æœˆåˆ¥èµ°è¡Œè·é›¢ï¼š' + (monthlyStr || 'ãƒ‡ãƒ¼ã‚¿ãªã—'));
  parts.push('ã‚¿ã‚¤ãƒ—åˆ¥å†…è¨³ï¼šEasy' + easyCount + 'æœ¬ã€é–¾å€¤' + tempoCount + 'æœ¬ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' + speedCount + 'æœ¬ã€ãƒ­ãƒ³ã‚°' + longCount + 'æœ¬');
  parts.push('');
  parts.push('ã€ç¾çŠ¶è¨ºæ–­ã€‘');
  parts.push('æœ€å¤§èª²é¡Œï¼šä¹³é…¸é–¾å€¤ãŒä½ã„ã€‚4åˆ†15ç§’/kmã§2kmãŒé™ç•Œâ†’ã“ã‚Œã‚’ã‚µãƒ–ã‚¹ãƒªãƒ¼ãƒšãƒ¼ã‚¹ã§42kmèµ°ã‚Œã‚‹ã¾ã§å¼•ãä¸Šã’ã‚‹ã“ã¨ãŒå…¨ã¦ã€‚');
  parts.push('Phase1ã®å„ªå…ˆäº‹é …ï¼š4åˆ†30ç§’ã€œ4åˆ†40ç§’/kmã§20ã€œ30åˆ†ã‚’ç¶­æŒã§ãã‚‹é–¾å€¤èµ°ã‚’é€±1å›ã€‚');
  parts.push('');
  parts.push('ã€å…¨ç·´ç¿’ãƒ­ã‚°ä¸€è¦§ï¼ˆè©³ç´°ï¼‰ã€‘');
  parts.push(logSummary);
  parts.push('');
  parts.push('è¿”ç­”ã¯ç°¡æ½”ã«ã€ã§ã‚‚å…·ä½“çš„ã«ã€‚æ•°å­—ã§è©±ã›ã€‚200ã€œ300å­—ã‚’ç›®å®‰ã«ã—ã¤ã¤ã€å¿…è¦ãªã‚‰é•·ããªã£ã¦ã‚‚æ§‹ã‚ãªã„ã€‚');
  parts.push('é¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹éš›ã¯å¿…ãšå…·ä½“çš„ãªæ—¥ä»˜ãƒ»è·é›¢ãƒ»ãƒšãƒ¼ã‚¹ãƒ»å¿ƒæ‹æ•°ã‚’å¼•ç”¨ã—ã¦æ ¹æ‹ ã‚’ç¤ºã›ã€‚');
  parts.push('');
  parts.push('ã€è¿”ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘');
  parts.push('- é©åˆ‡ãªæ®µè½ã”ã¨ã«æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã“ã¨ï¼ˆ\\n\\nã§æ®µè½åŒºåˆ‡ã‚Šï¼‰');
  parts.push('- é‡è¦ãªæ•°å€¤ãƒ»ãƒã‚¤ãƒ³ãƒˆã¯ **å¤ªå­—** ã§å¼·èª¿ã™ã‚‹');
  parts.push('- ç®‡æ¡æ›¸ããŒæœ‰åŠ¹ãªå ´åˆã¯ã€Œ- ã€ã‚’ä½¿ã†');
  parts.push('- é€±é–“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„è¨ˆç”»ã¯å„é …ç›®ã‚’æ”¹è¡Œã—ã¦è¦‹ã‚„ã™ãä¸¦ã¹ã‚‹');
  parts.push('- ãƒ™ã‚¿æ›¸ãã›ãšã€ãƒˆãƒ”ãƒƒã‚¯ã®åˆ‡ã‚Œç›®ã§å¿…ãšæ®µè½ã‚’åˆ†ã‘ã‚‹ã“ã¨');

  return parts.join('\n');
}

function buildLogSummary(logs) {
  const sorted = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));
  const lines = [];

  sorted.forEach(function(l, i) {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || parseDuration(l.duration);
    const pace = formatPace(dist, timeSec);
    const date = new Date(l.date);
    const dateStr = isNaN(date) ? 'ä¸æ˜' : date.toLocaleDateString('ja-JP', {month:'numeric', day:'numeric', weekday:'short'});
    const type = l.runType || classifyRunByPace(dist, timeSec);
    const typeLabel = { easy:'Easy', long:'Long', tempo:'é–¾å€¤', interval:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', race:'ãƒ¬ãƒ¼ã‚¹' }[type] || type;
    const hr = l.average_heartrate ? ' HR' + Math.round(l.average_heartrate) : '';
    const maxHR = l.max_heartrate ? '/max' + l.max_heartrate : '';
    const power = l.avg_power ? ' ' + l.avg_power + 'W' : '';
    const cadence = l.avg_cadence ? ' ' + l.avg_cadence + 'spm' : '';
    const plan = l.planAnalysis ? ' [è¨ˆç”»æ¯”:' + l.planAnalysis.verdict + ']' : '';

    let line = dateStr + ' [' + typeLabel + '] ' + dist.toFixed(1) + 'km ' + pace + '/km' + hr + maxHR + power + cadence + plan;

    if (i < 20 && l.laps && l.laps.length > 0) {
      const lapStr = l.laps.filter(function(lp){ return lp.dist && lp.dist > 0.3; }).slice(0, 10).map(function(lp, j) {
        const lpPace = lp.dist && lp.time ? formatPace(lp.dist, lp.time) : '-';
        return 'Lap' + (j+1) + ':' + lpPace + (lp.hr ? '/HR' + lp.hr : '');
      }).join(' ');
      if (lapStr) line = line + ' | ' + lapStr;
    }

    lines.push(line);
  });

  return lines.join('\n');
}

// é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
async function generateWeeklyReview() {
  const reviewEl = document.getElementById('weeklyReview');
  reviewEl.innerHTML = `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> ã‚«ãƒãƒ¼ãƒãŒå…ˆé€±ã‚’æ¡ç‚¹ä¸­...</div>`;

  const logs = getLogs();
  const oneWeekAgo = new Date(Date.now() - 7 * 86400000);
  const lastWeekLogs = logs.filter(l => new Date(l.date) >= oneWeekAgo);

  let weekSummary = lastWeekLogs.length > 0
    ? lastWeekLogs.map(l => {
        const dist = parseFloat(l.distKm) || 0;
        const time = parseInt(l.moving_time) || 0;
        return `${new Date(l.date).toLocaleDateString('ja-JP', {weekday:'short'})} ${dist.toFixed(1)}km ${formatPace(dist, time)}/km HR${l.average_heartrate || 'â€”'}`;
      }).join('\n')
    : 'å…ˆé€±ã®ç·´ç¿’è¨˜éŒ²ãªã—';

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 600,
        system: getCanovaSystemPrompt(),
        messages: [{ role: "user", content: `å…ˆé€±ã®ç·´ç¿’ã‚’æ¡ç‚¹ã—ã¦ãã ã•ã„ï¼š\n${weekSummary}\n\nè‰¯ã‹ã£ãŸç‚¹ã€æ‚ªã‹ã£ãŸç‚¹ã€ä»Šé€±ã®èª²é¡Œã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚` }]
    });
    const text = data.content?.[0]?.text || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—å¤±æ•—';
    reviewEl.innerHTML = mdToHtml(text);
  } catch(e) {
    reviewEl.innerHTML = 'ã‚³ãƒ¼ãƒã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  }
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´


// ===== å…¨ç”»é¢ãƒãƒ£ãƒƒãƒˆ =====
let chatMessages = [];

function openChatFullscreen(initialText) {
  const modal = document.getElementById('chatFullscreen');
  const input = document.getElementById('chatFsInput');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  renderChatFsMessages();
  if (initialText) {
    input.value = initialText;
    input.style.height = '48px';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  }
  setTimeout(() => input.focus(), 300);
}

function closeChatFullscreen() {
  const modal = document.getElementById('chatFullscreen');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  updateChatPreview();
}

function renderChatFsMessages() {
  const container = document.getElementById('chatFsMessages');
  if (!container) return;
  if (chatMessages.length === 0) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:24px 0;">ç·´ç¿’ãƒ»æ€ªæˆ‘ãƒ»æ¥é€±ã®äºˆå®šãªã©<br>ä½•ã§ã‚‚ç›¸è«‡ã—ã¦ãã ã•ã„</div>';
    return;
  }
  container.innerHTML = chatMessages.map(m => {
    const cls = m.role === 'user' ? 'chat-user' : 'chat-coach';
    const formatted = m.text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*/g, '')
      .replace(/\n\n/g, '</p><p style="margin-top:10px">')
      .replace(/\n/g, '<br>')
      .replace(/^/, '<p>').replace(/$/, '</p>');
    // ã‚³ãƒ¼ãƒè¿”ç­”ã«æ–¹é‡æ¡ç”¨ãƒœã‚¿ãƒ³ã‚’ä»˜ã‘ã‚‹ã‹åˆ¤å®š
    const adoptBar = (m.role === 'coach' && m.showAdoptBtn) ? `
      <div class="policy-adopt-bar" style="margin-top:10px">
        <div class="policy-hint">ğŸ“‹ ã“ã®è¨ˆç”»ã‚’HOMEã®ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ</div>
        <button onclick="adoptCoachPolicy(${m.idx})">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«åæ˜ </button>
      </div>` : (m.role === 'coach' && m.adopted) ? `
      <div style="margin-top:8px;font-size:11px;color:var(--accent);padding:6px 10px;background:rgba(232,255,0,0.06);border-radius:6px;border:1px solid rgba(232,255,0,0.2);">âœ“ HOMEã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«åæ˜ æ¸ˆã¿</div>` : '';
    return `<div class="chat-bubble ${cls}">${formatted}${adoptBar}</div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function updateChatPreview() {
  const previewEl = document.getElementById('chatLastMessage');
  if (!previewEl) return;
  const lastCoach = [...chatMessages].reverse().find(m => m.role === 'coach');
  if (lastCoach) {
    const plain = lastCoach.text.replace(/<[^>]*>/g, '').replace(/\*+/g, '');
    previewEl.style.display = 'block';
    previewEl.innerHTML = `<span style="color:var(--accent);font-weight:700">æœ€æ–°ã®è¿”ç­” â–¶</span> ${plain.slice(0, 60)}${plain.length > 60 ? 'â€¦' : ''}`;
  }
}

function renderCoachPolicyBadge() {
  const badge = document.getElementById('coachPolicyBadge');
  const preview = document.getElementById('coachPolicyPreview');
  if (!badge) return;
  const policy = getCoachPolicy();
  if (policy && policy.content) {
    badge.style.display = 'block';
    if (preview) preview.textContent = 'ã€€' + policy.content.slice(0, 40) + (policy.content.length > 40 ? 'â€¦' : '');
  } else {
    badge.style.display = 'none';
  }
}

function detectPolicyInText(text) {
  // é€±é–“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æœˆé–“ç›®æ¨™ãƒ»è¨ˆç”»ã£ã½ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
  const keywords = ['æœˆï¼š', 'ç«ï¼š', 'æ°´ï¼š', 'æœ¨ï¼š', 'é‡‘ï¼š', 'åœŸï¼š', 'æœˆé–“ç›®æ¨™', 'æˆ¦é—˜è¨ˆç”»', 'ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—', 'æ®µéšçš„', 'km/æœˆ', 'é€±6æ—¥', 'é€±5æ—¥'];
  return keywords.filter(k => text.includes(k)).length >= 2;
}

function adoptCoachPolicy(idx) {
  const msg = chatMessages[idx];
  if (!msg) return;
  const plain = msg.text.replace(/<[^>]*>/g, '').replace(/\*+/g, '').trim();
  saveCoachPolicy({ content: plain, savedAt: new Date().toISOString() });
  // ãƒœã‚¿ãƒ³ã‚’ã€Œæ¡ç”¨æ¸ˆã¿ã€ã«å¤‰æ›´
  msg.showAdoptBtn = false;
  msg.adopted = true;
  chatMessages[idx] = msg;
  renderChatFsMessages();
  renderCoachPolicyBadge();
  showToast('âœ… æ–¹é‡ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
  // å³åº§ã«ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
  closeChatFullscreen();
  setTimeout(() => {
    showPage('home', document.querySelectorAll('.nav-item')[0]);
    setTimeout(() => generateWeeklyMissionFromChat(plain), 300);
  }, 400);
}

async function generateWeeklyMissionFromChat(chatContext) {
  const logs = getLogs();
  if (logs.length === 0) return;

  document.getElementById('missionCard').innerHTML = `
    <div class="mission-loading">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> ã‚³ãƒ¼ãƒã¨ã®ä¼šè©±ã‚’åæ˜ ã—ã¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆä¸­...</div>
    </div>`;

  const currentVdot = findBestVdot();
  const phase = getCurrentPhase();

  const fourWeeksAgo = new Date();
  fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
  const recentLogs = logs.filter(l => new Date(l.date) >= fourWeeksAgo);
  const recentLogLines = recentLogs.slice(0, 14).map(l => {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || 0;
    return (l.date ? l.date.substring(5) : '') + ' ' + dist.toFixed(1) + 'km@' + formatPace(dist, timeSec) + ' HR' + (l.average_heartrate ? Math.round(l.average_heartrate) : '-');
  }).join('\n');

  const dataContext = 'é¸æ‰‹ï¼šå·å³¶å¤§è¼ã€31æ­³\n'
    + 'ç¾åœ¨VDOTï¼š' + currentVdot + '\n'
    + 'ç›®æ¨™ï¼š' + CONFIG.targetRace + 'ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53ï¼‰\n'
    + 'ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºï¼š' + phase.name + ' ' + phase.label + 'ï¼ˆç›®æ¨™ï¼š' + phase.goal + 'ï¼‰\n'
    + 'é€±5æ—¥ç·´ç¿’å¯èƒ½\n\n'
    + 'ç›´è¿‘ç·´ç¿’ãƒ­ã‚°ï¼š\n' + recentLogLines + '\n\n'
    + buildArchiveContext()
    + '\n\nã€â˜…ä»Šå›ã®æœ€å„ªå…ˆã‚¤ãƒ³ãƒ—ãƒƒãƒˆï¼šã‚³ãƒ¼ãƒã¨ã®ä¼šè©±ã§æ±ºå®šã—ãŸä»Šé€±ã®æ–¹é‡â˜…ã€‘\n'
    + chatContext
    + '\n\nä¸Šè¨˜ã®ã‚³ãƒ¼ãƒã¨ã®ä¼šè©±å†…å®¹ã‚’æœ€å„ªå…ˆã§åæ˜ ã—ã€å…·ä½“çš„ãªãƒŸãƒƒã‚·ãƒ§ãƒ³ã«è½ã¨ã—è¾¼ã‚€ã“ã¨ã€‚';

  try {
    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      system: `ã‚ãªãŸã¯Jack Danielsã®VDOTãƒ¡ã‚½ãƒƒãƒ‰ã«ç²¾é€šã—ãŸã‚¨ãƒªãƒ¼ãƒˆãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚
ã‚³ãƒ¼ãƒã¨ã®ä¼šè©±ã§æ±ºã¾ã£ãŸæ–¹é‡ã‚’æœ€å„ªå…ˆã«ã—ãªãŒã‚‰ã€é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’è¸ã¾ãˆã¦ä»Šé€±ã®å…·ä½“çš„ãªãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã€‚ä½™åˆ†ãªãƒ†ã‚­ã‚¹ãƒˆä¸è¦ã€‚

è¿”ç­”ã¯JSONå½¢å¼ã®ã¿ï¼š
{
  "diagnosis": "ä»Šé€±ã®æ–¹é‡ã‚’150å­—ä»¥å†…ã§",
  "gaps": [
    { "rank": 1, "title": "ã‚®ãƒ£ãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ15å­—ä»¥å†…ï¼‰", "desc": "æ ¹æ‹ ï¼ˆ50å­—ä»¥å†…ï¼‰", "action": "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ30å­—ä»¥å†…ï¼‰" },
    { "rank": 2, "title": "...", "desc": "...", "action": "..." },
    { "rank": 3, "title": "...", "desc": "...", "action": "..." }
  ],
  "missions": [
    {
      "day": "æœˆ",
      "type": "Easyèµ°",
      "distance": "10km",
      "pace": "5åˆ†40ç§’ã‹ã‚‰5åˆ†50ç§’",
      "detail": "è©³ç´°",
      "key": "ãƒã‚¤ãƒ³ãƒˆ",
      "pass_condition": "åˆæ ¼æ¡ä»¶",
      "fail_prescription": "ä¸åˆæ ¼æ™‚ã®å¯¾å¿œ"
    }
  ]
}
é‡è¦: ãƒšãƒ¼ã‚¹ã¯ã€ŒXåˆ†XXç§’ã€å½¢å¼ã€‚missionsã¯é€±5æœ¬ã€‚æ›œæ—¥ã¯æœˆã€œåœŸï¼ˆæ—¥æ›œé™¤å¤–ï¼‰ã€‚gapså¿…ãš3ä»¶ã€‚`,
      messages: [{ role: 'user', content: dataContext }]
    });

    const text = data.content?.[0]?.text || '';
    let parsed;
    try {
      let clean = text.replace(/^```[\w]*\n?/gm, '').replace(/```$/gm, '').trim();
      const jsonMatch = clean.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('JSON not found');
      parsed = JSON.parse(jsonMatch[0]);
    } catch(e) {
      throw new Error('JSON parse failed');
    }

    archiveCurrentWeek();
    saveMission({ ...parsed, generatedAt: new Date().toISOString(), fromChat: true });
    renderMissionCard(parsed);
    renderGapAnalysis(parsed);
    renderPhaseGauge();
    showToast('âœ… ã‚³ãƒ¼ãƒã®æ–¹é‡ã§ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) {
    document.getElementById('missionCard').innerHTML = `
      <div class="mission-generate">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
        <button class="btn-generate" onclick="generateWeeklyMission()">å†è©¦è¡Œ</button>
      </div>`;
  }
}

async function sendChatFs() {
  const input = document.getElementById('chatFsInput');
  const container = document.getElementById('chatFsMessages');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.style.height = '48px';

  chatMessages.push({ role: 'user', text: msg });
  renderChatFsMessages();

  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'chat-bubble chat-coach';
  loadingDiv.innerHTML = '<div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>';
  container.appendChild(loadingDiv);
  container.scrollTop = container.scrollHeight;

  try {
    const systemPrompt = getCanovaSystemPrompt();
    const apiMessages = chatMessages.map(m => ({
      role: m.role === 'coach' ? 'assistant' : 'user',
      content: m.text
    }));
    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1500,
      system: systemPrompt,
      messages: apiMessages
    });
    const reply = data.content?.[0]?.text || 'è¿”ç­”å–å¾—å¤±æ•—';
    loadingDiv.remove();
    const idx = chatMessages.length;
    const showAdopt = detectPolicyInText(reply);
    chatMessages.push({ role: 'coach', text: reply, idx, showAdoptBtn: showAdopt });
    renderChatFsMessages();
    // æ—§chatHistoryã«ã‚‚åŒæœŸ
    appendChatBubble(reply, 'coach');
  } catch(e) {
    loadingDiv.remove();
    chatMessages.push({ role: 'coach', text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', idx: chatMessages.length, showAdoptBtn: false });
    renderChatFsMessages();
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.style.height = '48px';

  appendChatBubble(msg, 'user');
  chatMessages.push({ role: 'user', text: msg });

  const loadingId = 'loading_' + Date.now();
  const chatHistory = document.getElementById('chatHistory');
  chatHistory.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-coach"><div class="loading"><div class="dots"><span></span><span></span><span></span></div></div></div>`;
  chatHistory.scrollTop = chatHistory.scrollHeight;

  try {
    const systemPrompt = getCanovaSystemPrompt();
    console.log('[SUB3] system prompt length:', systemPrompt.length, 'chars');
    console.log('[SUB3] log section preview:', systemPrompt.slice(systemPrompt.indexOf('å…¨ç·´ç¿’ãƒ­ã‚°'), systemPrompt.indexOf('å…¨ç·´ç¿’ãƒ­ã‚°') + 300));
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1500,
        system: systemPrompt,
        messages: chatMessages.map(m => ({ role: m.role === 'coach' ? 'assistant' : 'user', content: m.text }))
    });
    const reply = data.content?.[0]?.text || 'è¿”ç­”å–å¾—å¤±æ•—';
    chatMessages.push({ role: 'coach', text: reply, idx: chatMessages.length, showAdoptBtn: detectPolicyInText(reply) });

    const loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    appendChatBubble(reply, 'coach');
  } catch(e) {
    const loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.innerHTML = 'æ¥ç¶šå¤±æ•—ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
}

function openRescheduleModal() {
  const overlay = document.createElement('div');
  overlay.className = 'edit-modal-overlay';
  overlay.id = 'rescheduleOverlay';
  overlay.innerHTML = `
    <div class="edit-modal">
      <h3>ä»Šé€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã¿æ›¿ãˆã‚‹</h3>
      <div class="edit-field">
        <label>èµ°ã‚Œãªã„æ—¥ãƒ»åˆ¶ç´„ã‚’å…¥åŠ›</label>
        <textarea id="rescheduleInput" placeholder="ä¾‹ï¼šæ°´æ›œã¨åœŸæ›œã¯èµ°ã‚Œãªã„ã€‚æœ¨æ›œã¯çŸ­ã‚å¸Œæœ›ã€‚" style="height:80px"></textarea>
      </div>
      <div class="edit-modal-btns">
        <button class="btn-cancel-edit" onclick="document.getElementById('rescheduleOverlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-save-edit" onclick="rescheduleWithAI()">AIã«çµ„ã¿æ›¿ãˆã¦ã‚‚ã‚‰ã†</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  setTimeout(() => document.getElementById('rescheduleInput').focus(), 100);
}

async function rescheduleWithAI() {
  const constraint = document.getElementById('rescheduleInput')?.value?.trim();
  if (!constraint) { showToast('åˆ¶ç´„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const mission = getMission();
  if (!mission) { showToast('å…ˆã«ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'); return; }

  const btn = document.querySelector('#rescheduleOverlay .btn-save-edit');
  if (btn) { btn.disabled = true; btn.textContent = 'çµ„ã¿æ›¿ãˆä¸­...'; }

  try {
    const currentMissions = JSON.stringify(mission.missions, null, 2);
    const today = new Date().toLocaleDateString('ja-JP', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 800,
      system: `ã‚ãªãŸã¯ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚ä»Šæ—¥ã¯${today}ã€‚ç¾åœ¨ã®ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¶ç´„ã«åˆã‚ã›ã¦çµ„ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚æ—¥æ›œæ—¥ã¯å¿…ãšé™¤å¤–ã€‚æœˆã€œåœŸã®ä¸­ã§èª¿æ•´ã™ã‚‹ã“ã¨ã€‚JSONã®missionsé…åˆ—ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã€‚`,
      messages: [{ role: 'user', content: `ç¾åœ¨ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³:\n${currentMissions}\n\nåˆ¶ç´„: ${constraint}\n\nã“ã®åˆ¶ç´„ã‚’å®ˆã‚ŠãªãŒã‚‰åŒã˜ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹ã‚’é©åˆ‡ãªæ›œæ—¥ã«å†é…ç½®ã—ã¦ãã ã•ã„ã€‚` }]
    });

    const text = data.content?.[0]?.text || '';
    let clean = text.replace(/^```[\w]*\n?/gm, '').replace(/```$/gm, '').trim();
    const arrMatch = clean.match(/\[[\s\S]*\]/);
    if (!arrMatch) throw new Error('No JSON array found');
    const newMissions = JSON.parse(arrMatch[0]);

    mission.missions = newMissions;
    saveMission(mission);
    renderMissionCard(mission);
    document.getElementById('rescheduleOverlay')?.remove();
    showToast('âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã¿æ›¿ãˆã¾ã—ãŸ');
  } catch(e) {
    showToast('âŒ çµ„ã¿æ›¿ãˆã«å¤±æ•—: ' + (e.message || ''));
    if (btn) { btn.disabled = false; btn.textContent = 'AIã«çµ„ã¿æ›¿ãˆã¦ã‚‚ã‚‰ã†'; }
  }
}

function quickChat(msg) {
  document.getElementById('chatInput').value = msg;
  sendChat();
  showPage('coach', document.querySelectorAll('.nav-item')[1]);
}

// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³â†’HTMLå¤‰æ›
function mdToHtml(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^### (.+)$/gm, '<div style="font-size:13px;font-weight:700;color:var(--accent);margin:12px 0 4px">$1</div>')
    .replace(/^## (.+)$/gm,  '<div style="font-size:14px;font-weight:700;color:var(--text);margin:14px 0 6px">$1</div>')
    .replace(/^- (.+)$/gm,   '<div style="padding-left:12px;margin:3px 0">ãƒ»$1</div>')
    .replace(/^\d+\. (.+)$/gm, '<div style="padding-left:12px;margin:3px 0">$&</div>')
    .replace(/\n/g, '<br>');
}

function appendChatBubble(text, role) {
  const chatHistory = document.getElementById('chatHistory');
  const div = document.createElement('div');
  div.className = `chat-bubble chat-${role}`;
  div.innerHTML = mdToHtml(text);
  chatHistory.appendChild(div);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

// ===== BACKUP / RESTORE =====
function exportBackup() {
  const logs = getLogs();
  const mission = getMission();
  const backup = {
    version: 1,
    exportedAt: new Date().toISOString(),
    logs,
    mission
  };
  const json = JSON.stringify(backup, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sub3lab_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('backupStatus').textContent = `âœ… ${logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ`;
}

function importBackup(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.logs || !Array.isArray(backup.logs)) throw new Error('Invalid backup');
      saveLogs(backup.logs);
      if (backup.mission) saveMission(backup.mission);
      renderVdotCard(findBestVdot());
      renderLogList();
      renderStats();
      document.getElementById('backupStatus').textContent = `âœ… ${backup.logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`;
      showToast(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰${backup.logs.length}ä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
    } catch(err) {
      document.getElementById('backupStatus').textContent = 'âŒ å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ';
    }
  };
  reader.readAsText(file);
}

// ===== INIT =====
async function init() {
  // IndexedDBã‹ã‚‰APIã‚­ãƒ¼ã‚’å¾©å…ƒã—ã¦ã‹ã‚‰åˆ¤å®šï¼ˆSafariå¯¾ç­–ï¼‰
  await restoreApiKeyFromIDB();

  const vdot = findBestVdotWithFallback();
  renderVdotCard(vdot);
  renderVitalCard();

  // ä¿å­˜æ¸ˆã¿ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°è¡¨ç¤º
  const savedMission = getMission();
  if (savedMission) {
    renderMissionCard(savedMission);
    renderGapAnalysis(savedMission);
  }

  // APIã‚­ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆIDBå¾©å…ƒå¾Œãªã®ã§æ­£ç¢ºï¼‰
  updateApiKeyStatus();

  // APIã‚­ãƒ¼æœªè¨­å®šã‹ã¤åˆå›ã®ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  const hasShownModal = localStorage.getItem('sub3_api_modal_shown');
  if (!getApiKey() && !hasShownModal) {
    localStorage.setItem('sub3_api_modal_shown', '1');
    setTimeout(showApiKeyModal, 300);
  }
}

// é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ä¸Šæ›¸ã
const _origGenerateWeeklyReview = generateWeeklyReview;
async function generateWeeklyReviewCached() {
  await _origGenerateWeeklyReview();
  const text = document.getElementById('weeklyReview').innerHTML;
  localStorage.setItem('sub3_weekly_review', text);
  localStorage.setItem('sub3_last_review', new Date().toISOString().slice(0, 10));
}
// ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢æ•°ã‚’æ›´æ–°ç‰ˆã«
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('[onclick="generateWeeklyReview()"]');
  if (btn) btn.setAttribute('onclick', 'generateWeeklyReviewCached()');
});

init();

// ===== PLAN vs ACTUAL =====

function findMissionForLog(log) {
  // ãƒ­ã‚°ã®æ—¥ä»˜ã‹ã‚‰ãã®æ›œæ—¥ã«å¯¾å¿œã™ã‚‹ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
  const mission = getMission();
  if (!mission || !mission.missions) return null;
  const date = new Date(log.date);
  if (isNaN(date)) return null;
  const dowMap = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const logDow = dowMap[date.getDay()];
  return mission.missions.find(m => m.day === logDow) || null;
}

function parsePlannedPaceRange(paceStr) {
  // "4åˆ†35ç§’ã‹ã‚‰4åˆ†40ç§’" â†’ {min: 275, max: 280} (ç§’)
  if (!paceStr) return null;
  const matches = paceStr.match(/(\d+)åˆ†(\d+)ç§’/g);
  if (!matches || matches.length < 1) return null;
  const toSec = s => {
    const m = s.match(/(\d+)åˆ†(\d+)ç§’/);
    return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : null;
  };
  const times = matches.map(toSec).filter(Boolean);
  return times.length >= 2
    ? { min: Math.min(...times), max: Math.max(...times) }
    : times.length === 1 ? { min: times[0] - 10, max: times[0] + 10 } : null;
}

function getSameDayLogs(log) {
  // åŒã˜æ—¥ä»˜ã®å…¨ãƒ­ã‚°ã‚’è¿”ã™
  const allLogs = getLogs();
  const logDate = new Date(log.date).toDateString();
  return allLogs.filter(l => new Date(l.date).toDateString() === logDate);
}

function mergeDayLogs(logs) {
  // åŒæ—¥è¤‡æ•°ãƒ­ã‚°ã‚’åˆç®—ã—ãŸä»®æƒ³ãƒ­ã‚°ã‚’è¿”ã™
  const totalDist = logs.reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);
  const totalTime = logs.reduce((s, l) => s + (parseInt(l.moving_time) || 0), 0);
  // æœ€ã‚‚å¼·åº¦ã®é«˜ã„ãƒ­ã‚°ã®ãƒšãƒ¼ã‚¹ã‚’ã€Œã‚­ãƒ¼ãƒšãƒ¼ã‚¹ã€ã¨ã—ã¦ä½¿ã†ï¼ˆTEMPO/INTERVALã‚’å„ªå…ˆï¼‰
  const typePriority = { interval: 4, race: 4, tempo: 3, long: 2, easy: 1 };
  const sorted = [...logs].sort((a, b) => {
    const pa = typePriority[a.runType] || 1;
    const pb = typePriority[b.runType] || 1;
    return pb - pa;
  });
  const keyLog = sorted[0];
  return {
    distKm: totalDist,
    moving_time: totalTime,
    average_heartrate: keyLog?.average_heartrate,
    avg_power: keyLog?.avg_power,
    runType: keyLog?.runType,
    keyPace: keyLog ? (parseInt(keyLog.moving_time) / parseFloat(keyLog.distKm)) : null,
    keyDist: parseFloat(keyLog?.distKm) || 0,
    logCount: logs.length,
    date: logs[0].date
  };
}

function judgePlanVsActual(mission, log) {
  // åŒæ—¥ã®å…¨ãƒ­ã‚°ã‚’åˆç®—ã—ã¦åˆ¤å®š
  const dayLogs = getSameDayLogs(log);
  const merged = mergeDayLogs(dayLogs);

  const totalDist = merged.distKm;
  const plannedDist = parseFloat(mission.distance) || 0;
  const paceRange = parsePlannedPaceRange(mission.pace);

  // è·é›¢åˆ¤å®šï¼šåŒæ—¥åˆè¨ˆãŒè¨ˆç”»ã®85%ä»¥ä¸Š
  let distOk = plannedDist > 0 ? totalDist >= plannedDist * 0.85 : true;

  // ãƒšãƒ¼ã‚¹åˆ¤å®šï¼šæœ€ã‚‚ã‚­ãƒ„ã„ãƒ­ã‚°ã®ãƒšãƒ¼ã‚¹ã§åˆ¤å®šï¼ˆé–¾å€¤èµ°ãªã‚‰é–¾å€¤ãƒ‘ãƒ¼ãƒˆã®ãƒšãƒ¼ã‚¹ã§è¦‹ã‚‹ï¼‰
  let paceOk = true;
  if (paceRange && merged.keyPace) {
    paceOk = merged.keyPace >= paceRange.min - 20 && merged.keyPace <= paceRange.max + 30;
  }

  if (distOk && paceOk) return 'ACHIEVED';
  if (distOk || paceOk) return 'PARTIAL';
  return 'MISSED';
}

async function runPlanAnalysis(logIndex, missionItem) {
  const logs = getLogs();
  const log = logs[logIndex];
  if (!log || !missionItem) return;

  const dist = parseFloat(log.distKm) || 0;
  const timeSec = parseInt(log.moving_time) || 0;
  const pace = formatPace(dist, timeSec);
  const hr = log.average_heartrate ? Math.round(log.average_heartrate) : 'â€”';

  // åŒæ—¥è¤‡æ•°ãƒ­ã‚°ã‚’åˆç®—
  const dayLogs = getSameDayLogs(log);
  const merged = mergeDayLogs(dayLogs);
  const totalDistStr = merged.distKm.toFixed(1) + 'km';
  const keyPaceStr = merged.keyPace ? formatPace(1, merged.keyPace) : pace;
  const multiLogNote = dayLogs.length > 1
    ? `ï¼ˆ${dayLogs.length}æœ¬ã«åˆ†å‰²è¨˜éŒ²ï¼š${dayLogs.map(l => parseFloat(l.distKm).toFixed(1)+'km@'+formatPace(parseFloat(l.distKm),parseInt(l.moving_time))).join('ã€')}ï¼‰`
    : '';

  const verdict = judgePlanVsActual(missionItem, log);

  const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚å·å³¶å¤§è¼é¸æ‰‹ï¼ˆVDOT${findBestVdotWithFallback()}ã€ç›®æ¨™ã‚µãƒ–3ï¼‰ã®ç·´ç¿’è¨ˆç”»ã¨å®Ÿç¸¾ã‚’æ¯”è¼ƒåˆ†æã—ã¦ãã ã•ã„ã€‚
åˆ†æã¯ä»¥ä¸‹ã®å½¢å¼ã§JSONå½¢å¼ã®ã¿è¿”ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆä¸è¦ï¼‰ï¼š
{"verdict":"${verdict}","comment":"100å­—ä»¥å†…ã®å…·ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯<strong>ã‚¿ã‚°ã§ï¼‰","score":0ã‹ã‚‰100ã®é”æˆåº¦}`;

  const userPrompt = `è¨ˆç”»ï¼š${missionItem.type} ${missionItem.distance}ã€ãƒšãƒ¼ã‚¹ç›®æ¨™ï¼š${missionItem.pace}ã€æ„å›³ï¼š${missionItem.key || missionItem.detail}
å®Ÿç¸¾ï¼šåˆè¨ˆ${totalDistStr}${multiLogNote}ã€ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆ${keyPaceStr}/kmã€å¿ƒæ‹${hr}bpm${log.avg_power ? 'ã€ãƒ‘ãƒ¯ãƒ¼' + log.avg_power + 'W' : ''}
â€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆè¨ˆè·é›¢ãƒ»ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚`;

  try {
    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 300,
      system: systemPrompt,
      messages: [{ role: 'user', content: userPrompt }]
    });
    const raw = data.content?.[0]?.text || '{}';
    const clean = raw.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    // ãƒ­ã‚°ã«ä¿å­˜
    logs[logIndex].planAnalysis = {
      missionType: missionItem.type,
      plannedPace: missionItem.pace,
      plannedDist: missionItem.distance,
      verdict: result.verdict || verdict,
      score: result.score || 0,
      comment: result.comment || '',
      analyzedAt: new Date().toISOString()
    };
    saveLogs(logs);
    renderPlanActualSummary();
    return logs[logIndex].planAnalysis;
  } catch(e) {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šAIãªã—ã§ä¿å­˜
    logs[logIndex].planAnalysis = {
      missionType: missionItem.type,
      plannedPace: missionItem.pace,
      plannedDist: missionItem.distance,
      verdict,
      score: verdict === 'ACHIEVED' ? 90 : verdict === 'PARTIAL' ? 60 : 30,
      comment: '',
      analyzedAt: new Date().toISOString()
    };
    saveLogs(logs);
    renderPlanActualSummary();
    return logs[logIndex].planAnalysis;
  }
}


// ===== ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—ã‚²ãƒ¼ã‚¸ =====
function closeRecovery() { var w = document.getElementById("recoveryProposalWrap"); if(w) w.style.display="none"; }

// ===== ãƒªã‚«ãƒãƒªãƒ¼ææ¡ˆ =====
let recoveryPlanText = '';
let recoveryMissionUpdate = null;

async function checkRecovery() {
  const recoveryCard = document.getElementById('recoveryCard');
  if (!recoveryCard) return;

  // dismissedãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  const dismissedDate = localStorage.getItem('recoveryDismissed');
  if (dismissedDate === new Date().toDateString()) return;

  const mission = getMission();
  if (!mission || !mission.missions) return;

  const logs = getLogs();
  const now = new Date();
  const dowMap = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

  // æ˜¨æ—¥ã®æ›œæ—¥
  const yesterday = new Date(now);
  yesterday.setDate(now.getDate() - 1);
  const yesterdayDow = dowMap[yesterday.getDay()];

  // æ˜¨æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
  const yesterdayMission = mission.missions.find(function(m) { return m.day === yesterdayDow; });
  if (!yesterdayMission) return; // æ˜¨æ—¥ã¯ã‚ªãƒ•æ—¥

  // æ˜¨æ—¥ã®ãƒ­ã‚°ã‚’æ¢ã™
  const yesterdayStr = yesterday.toISOString().substring(0, 10);
  const yesterdayLog = logs.find(function(l) { return l.date && l.date.substring(0, 10) === yesterdayStr; });
  if (yesterdayLog) return; // æ˜¨æ—¥ã¯å®Ÿæ–½æ¸ˆã¿

  // æœªå®Ÿæ–½ç¢ºå®š â†’ AIã«åˆ¤æ–­ã•ã›ã‚‹
  recoveryCard.style.display = 'block';
  document.getElementById('recoveryBody').textContent = 'ã‚«ãƒãƒ¼ãƒãŒæ˜¨æ—¥ã®æœªå®Ÿæ–½ã‚’åˆ†æä¸­...';

  // ç›´è¿‘7æ—¥ã®ç–²åŠ´åº¦ã‚’è¨ˆç®—
  const weekAgo = new Date(now - 7 * 86400000);
  const recentLogs = logs.filter(function(l) { return new Date(l.date) >= weekAgo; });
  const recentDist = recentLogs.reduce(function(s, l) { return s + (parseFloat(l.distKm) || 0); }, 0);
  const avgHR = recentLogs.filter(function(l) { return l.average_heartrate; })
    .reduce(function(s, l, _, a) { return s + l.average_heartrate / a.length; }, 0);

  const prompt = 'æ˜¨æ—¥ï¼ˆ' + yesterdayDow + 'æ›œæ—¥ï¼‰ã®äºˆå®šï¼š' + yesterdayMission.type + ' ' + yesterdayMission.distance + ' ãƒšãƒ¼ã‚¹' + yesterdayMission.pace + 'ãŒæœªå®Ÿæ–½ã€‚'
    + 'ç›´è¿‘7æ—¥ã®èµ°è¡Œè·é›¢ï¼š' + recentDist.toFixed(0) + 'kmï¼ˆ' + recentLogs.length + 'æœ¬ï¼‰ã€å¹³å‡HRï¼š' + Math.round(avgHR || 0) + 'ã€‚'
    + 'ä»Šæ—¥ï¼ˆ' + dowMap[now.getDay()] + 'æ›œæ—¥ï¼‰ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã©ã†ã™ã¹ãã‹ï¼Ÿãƒªã‚«ãƒãƒªãƒ¼ã™ã¹ãã‹ã€ç„¡è¦–ã—ã¦æ¬¡ã«é€²ã‚€ã¹ãã‹ã€‚50å­—ä»¥å†…ã§åˆ¤æ–­ã¨ç†ç”±ã‚’è¿°ã¹ã‚ˆã€‚';

  try {
    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 200,
      system: 'ã‚ãªãŸã¯Renato Canovaã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã€‚ç«¯çš„ã«ã€æ•°å­—ã§è©±ã›ã€‚',
      messages: [{ role: 'user', content: prompt }]
    });
    const reply = data.content?.[0]?.text || '';
    recoveryPlanText = reply;
    document.getElementById('recoveryBody').textContent = reply;
  } catch(e) {
    recoveryCard.style.display = 'none';
  }
}

function applyRecoveryPlan() {
  document.getElementById('recoveryCard').style.display = 'none';
  if (recoveryPlanText) {
    // COACHãƒšãƒ¼ã‚¸ã¸èª˜å°
    showToast('COACHã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã¿æ›¿ãˆã¦ãã ã•ã„');
    document.getElementById('chatInput').value = 'æ˜¨æ—¥ã®æœªå®Ÿæ–½ã‚’è¸ã¾ãˆã¦ä»Šé€±ã®ãƒ—ãƒ©ãƒ³ã‚’è¦‹ç›´ã—ã¦ãã‚Œï¼š' + recoveryPlanText;
    showTab('coach');
  }
}

function dismissRecovery() {
  localStorage.setItem('recoveryDismissed', new Date().toDateString());
  document.getElementById('recoveryCard').style.display = 'none';
}

function renderPlanActualSummary() {
  const container = document.getElementById('planActualSummary');
  if (!container) return;
  const logs = getLogs();
  const mission = getMission();
  if (!mission || !mission.missions) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-dim);text-align:center;padding:16px;">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã¨ã“ã“ã«è¨ˆç”»vså®Ÿç¸¾ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
    return;
  }

  // ä»Šé€±ã®ãƒ­ã‚°ï¼ˆæœˆã€œæ—¥ï¼‰
  const now = new Date();
  const mondayOffset = now.getDay() === 0 ? -6 : 1 - now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() + mondayOffset);
  monday.setHours(0,0,0,0);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23,59,59,999);

  const weekLogs = logs.filter(l => {
    const d = new Date(l.date);
    return d >= monday && d <= sunday;
  });

  const verdictColor = { ACHIEVED: 'var(--accent)', PARTIAL: '#ff9900', MISSED: '#ff4444', UNKNOWN: '#888' };
  const verdictLabel = { ACHIEVED: 'é”æˆ', PARTIAL: 'éƒ¨åˆ†é”æˆ', MISSED: 'æœªé”', UNKNOWN: 'åˆ†æä¸­' };
  const verdictIcon = {
    ACHIEVED: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
    PARTIAL:  `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
    MISSED:   `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
    UNKNOWN:  `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
    NONE:     `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>`
  };

  const rows = mission.missions.map(m => {
    const dowMap = { 'æœˆ':1,'ç«':2,'æ°´':3,'æœ¨':4,'é‡‘':5,'åœŸ':6,'æ—¥':0 };
    const mDate = new Date(monday);
    mDate.setDate(monday.getDate() + (dowMap[m.day] !== undefined ? (dowMap[m.day] === 0 ? 6 : dowMap[m.day] - 1) : 0));
    const matchedLogs = weekLogs.filter(l => {
      const ld = new Date(l.date);
      return ld.toDateString() === mDate.toDateString();
    });
    const matched = matchedLogs.length > 0 ? matchedLogs[0] : null;

    // åŒæ—¥è¤‡æ•°ãƒ­ã‚°ã®palnAnalysisã¯æœ€ã‚‚å¼·åº¦ãŒé«˜ã„ã‚‚ã®ï¼ˆTEMPO/INTERVALã‚’å„ªå…ˆï¼‰ã‚’ä½¿ã†
    const typePriority = { interval: 4, race: 4, tempo: 3, long: 2, easy: 1 };
    const bestLog = matchedLogs.sort((a, b) => (typePriority[b.runType]||1) - (typePriority[a.runType]||1))[0];
    const analysis = bestLog?.planAnalysis;

    // analysisãŒãªã„å ´åˆã¯åŒæ—¥åˆç®—ã§ä»®åˆ¤å®š
    let verdict = analysis?.verdict || null;
    if (!verdict && matchedLogs.length > 0) {
      verdict = judgePlanVsActual(m, matched);
    }
    const score = analysis?.score || null;

    // è¡¨ç¤ºç”¨ï¼šåŒæ—¥åˆè¨ˆè·é›¢
    const totalDayDist = matchedLogs.reduce((s, l) => s + (parseFloat(l.distKm)||0), 0);

    return { m, matched, matchedLogs, totalDayDist, analysis, verdict, score, mDate };
  });

  // æ›œæ—¥é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœˆ=1,ç«=2...æ—¥=0â†’7ã¨ã—ã¦æ‰±ã†ï¼‰
  const dowOrder = {'æœˆ':1,'ç«':2,'æ°´':3,'æœ¨':4,'é‡‘':5,'åœŸ':6,'æ—¥':7};
  rows.sort((a, b) => (dowOrder[a.m.day] || 8) - (dowOrder[b.m.day] || 8));

  const achieved = rows.filter(r => r.verdict === 'ACHIEVED').length;
  const total = rows.filter(r => r.verdict).length;

  // æ›œæ—¥é †ï¼ˆæœˆâ†’ç«â†’æ°´â†’æœ¨â†’é‡‘â†’åœŸâ†’æ—¥ï¼‰ã«ã‚½ãƒ¼ãƒˆ
  container.innerHTML = `
    ${total > 0 ? `<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">ä»Šé€±ã®é”æˆç‡: <span style="color:var(--accent);font-weight:700;">${total > 0 ? Math.round(achieved/total*100) : 0}%</span> (${achieved}/${total})</div>` : ''}
    ${rows.map(r => `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;display:flex;align-items:flex-start;gap:10px;">
        <div style="flex-shrink:0;width:28px;text-align:center;">
          <div style="font-size:9px;color:var(--text-dim);">${r.m.day}</div>
          <div style="font-size:${r.verdict ? '14px' : '14px'};color:${r.verdict ? verdictColor[r.verdict] : '#444'};line-height:1.2;display:flex;align-items:center;justify-content:center;">
            ${r.verdict ? verdictIcon[r.verdict] : verdictIcon.NONE}
          </div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
            <span style="font-size:11px;font-weight:700;">${r.m.type}</span>
            <span style="font-size:10px;color:var(--text-muted);">${r.m.distance}</span>
            ${r.verdict ? `<span style="font-size:9px;color:${verdictColor[r.verdict]};margin-left:auto;white-space:nowrap;">${verdictLabel[r.verdict]}</span>` : '<span style="font-size:9px;color:#444;margin-left:auto;">æœªå®Ÿæ–½</span>'}
          </div>
          <div style="font-size:10px;color:var(--text-dim);">è¨ˆç”» ${r.m.pace}</div>
          ${r.matched ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">å®Ÿç¸¾ ${r.matchedLogs.length > 1
              ? r.matchedLogs.map(l => `${parseFloat(l.distKm).toFixed(1)}km@${formatPace(parseFloat(l.distKm),parseInt(l.moving_time)||0)}`).join('ï¼‹') + ` = è¨ˆ${r.totalDayDist.toFixed(1)}km`
              : `${formatPace(parseFloat(r.matched.distKm), parseInt(r.matched.moving_time)||0)}/km ${parseFloat(r.matched.distKm).toFixed(1)}km`
            }</div>` : ''}
          ${r.analysis?.comment ? `<div style="font-size:11px;color:var(--text-muted);margin-top:4px;line-height:1.5;">${r.analysis.comment}</div>` : r.matched && !r.analysis ? `<button onclick="triggerPlanAnalysis(${logs.indexOf(r.matched)})" style="margin-top:4px;font-size:10px;color:var(--accent);background:none;border:1px solid var(--accent);border-radius:4px;padding:3px 8px;cursor:pointer;">AIã§åˆ†æ</button>` : ''}
        </div>
      </div>`).join('')}
  `;
}

async function triggerPlanAnalysis(logIndex) {
  const logs = getLogs();
  const log = logs[logIndex];
  if (!log) return;
  const mission = findMissionForLog(log);
  if (!mission) { showToast('ã“ã®æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  showToast('åˆ†æä¸­...');
  await runPlanAnalysis(logIndex, mission);
  showToast('âœ… åˆ†æå®Œäº†');
}


// ===== â‘  é–¾å€¤å¼·åŒ–ã‚²ãƒ¼ã‚¸ =====
function renderPhaseGauge() {
  const wrap = document.getElementById('phaseGaugeWrap');
  const titleEl = document.getElementById('phaseGaugeTitle');
  const pctEl = document.getElementById('phaseGaugePct');
  const fillEl = document.getElementById('phaseGaugeFill');
  const tasksEl = document.getElementById('phaseGaugeTasks');
  if (!wrap) return;

  const phase = getCurrentPhase();
  const mission = getMission();
  if (!mission || !mission.missions) return;

  let doneState = {};
  try { doneState = JSON.parse(localStorage.getItem('sub3_mission_done') || '{}'); } catch {}

  const total = mission.missions.length;
  const doneCount = Object.values(doneState).filter(Boolean).length;
  const pct = total > 0 ? Math.round(doneCount / total * 100) : 0;

  titleEl.textContent = phase.name + ' Â· ' + phase.label;
  pctEl.textContent = pct + '%';
  fillEl.style.width = pct + '%';

  // ã‚¿ã‚¹ã‚¯ãƒ‰ãƒƒãƒˆ
  tasksEl.innerHTML = mission.missions.map(function(m, i) {
    const done = doneState[i] || false;
    return '<div class="phase-task-dot' + (done ? ' done' : '') + '" title="' + m.day + ' ' + m.type + '"></div>';
  }).join('');

  // å…‰æ¼”å‡ºï¼ˆ50%ä»¥ä¸Šã§glowï¼‰
  if (pct >= 50) {
    wrap.classList.add('glowing');
  } else {
    wrap.classList.remove('glowing');
  }
}

// toggleMissionDoneã‚’ãƒ©ãƒƒãƒ—ã—ã¦æ¯å›ã‚²ãƒ¼ã‚¸ã‚’æ›´æ–°
const _origToggle = window.toggleMissionDone;
window.toggleMissionDone = function(idx) {
  if (_origToggle) _origToggle(idx);
  setTimeout(renderPhaseGauge, 100);
};

// ===== â‘¡ ãƒ—ãƒ©ãƒ³å‹•çš„å†æ§‹æˆï¼ˆãƒªã‚«ãƒãƒªãƒ¼ææ¡ˆï¼‰ =====
async function checkAndSuggestRecovery() {
  const wrap = document.getElementById('recoveryProposalWrap');
  if (!wrap) return;

  const mission = getMission();
  const logs = getLogs();
  if (!mission || !mission.missions) return;

  const now = new Date();
  const yesterday = new Date(now);
  yesterday.setDate(now.getDate() - 1);
  const yDow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][yesterday.getDay()];

  // æ˜¨æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
  const yMission = mission.missions.find(function(m) { return m.day === yDow; });
  if (!yMission) return;

  // æ˜¨æ—¥ã®ãƒ­ã‚°ãŒã‚ã‚‹ã‹ç¢ºèª
  const yLog = logs.find(function(l) {
    const d = new Date(l.date);
    return d.toDateString() === yesterday.toDateString();
  });
  if (yLog) return; // å®Ÿæ–½æ¸ˆã¿ãªã‚‰è¡¨ç¤ºã—ãªã„

  // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã¯1å›ã ã‘ï¼‰
  if (sessionStorage.getItem('recoveryShown_' + yesterday.toDateString())) return;
  sessionStorage.setItem('recoveryShown_' + yesterday.toDateString(), '1');

  wrap.style.display = 'block';
  wrap.innerHTML = '<div class="recovery-card"><div class="recovery-card-title">âš¡ RECOVERY ALERT</div><div class="recovery-card-body">æ˜¨æ—¥ã®' + yMission.type + 'ï¼ˆ' + yMission.distance + 'ï¼‰ãŒæœªå®Ÿæ–½ã€‚AIãŒç–²åŠ´çŠ¶æ…‹ã‚’åˆ†æã—ã¦ãƒªã‚«ãƒãƒªãƒ¼ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¾ã™...</div></div>';

  try {
    const vdot = findBestVdotWithFallback();
    const recentLogs = logs.slice(0, 7);
    const recentSummary = recentLogs.map(function(l) {
      const dist = parseFloat(l.distKm) || 0;
      const timeSec = parseInt(l.moving_time) || 0;
      return l.date + ' ' + dist.toFixed(1) + 'km ' + formatPace(dist, timeSec) + '/km HR' + (l.average_heartrate || '-');
    }).join('\n');

    const prompt = 'å·å³¶å¤§è¼ï¼ˆVDOT' + vdot + 'ï¼‰ã®æ˜¨æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€Œ' + yMission.type + ' ' + yMission.distance + ' ' + yMission.pace + 'ã€ãŒæœªå®Ÿæ–½ã§ã—ãŸã€‚\n\nç›´è¿‘7æ—¥é–“ã®ãƒ­ã‚°ï¼š\n' + recentSummary + '\n\nç–²åŠ´çŠ¶æ…‹ã‚’æ¨å®šã—ã€ä»¥ä¸‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ï¼š\n1. ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚«ãƒãƒªãƒ¼ï¼ˆä»Šæ—¥/æ˜æ—¥ã«å®Ÿæ–½ï¼‰ã™ã¹ãã‹ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã«é€²ã‚€ã¹ãã‹\n2. ä»Šæ—¥ã®æ¨å¥¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå…·ä½“çš„ãªãƒšãƒ¼ã‚¹ãƒ»è·é›¢ï¼‰\n\n150å­—ä»¥å†…ã§ç›´æ¥çš„ã«å›ç­”ã€‚';

    const data = await callClaude({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 300,
      system: 'ã‚ãªãŸã¯Renato Canovaã§ã™ã€‚ç–²åŠ´ç®¡ç†ã¨ç·´ç¿’å¯†åº¦ã®ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã¾ã™ã€‚æ•°å­—ã§è©±ã—ã€é å›ã—ãªè¨€ã„æ–¹ã‚’ã—ãªã„ã€‚',
      messages: [{ role: 'user', content: prompt }]
    });

    const reply = data.content && data.content[0] ? data.content[0].text : 'åˆ†æå¤±æ•—';
    const isSkip = reply.includes('ã‚¹ã‚­ãƒƒãƒ—') || reply.includes('ç„¡è¦–') || reply.includes('æ¬¡ã«é€²');

    wrap.innerHTML = '<div class="recovery-card">'
      + '<div class="recovery-card-title">âš¡ ' + (isSkip ? 'SKIPæ¨å¥¨' : 'RECOVERYæ¨å¥¨') + ' Â· æ˜¨æ—¥ã®' + yMission.type + 'æœªå®Ÿæ–½</div>'
      + '<div class="recovery-card-body">' + reply + '</div>'
      + '<div class="recovery-card-action">'
      + '<button class="btn-recovery" onclick="closeRecovery()">é–‰ã˜ã‚‹</button>'
      + '</div></div>';
  } catch(e) {
    wrap.innerHTML = '';
  }
}

// ===== â‘¢ ãƒ¬ãƒ¼ã‚¹å±•é–‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆäºˆè¨€ï¼‰ =====


</script>

<!-- å…¨ç”»é¢ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="chat-fullscreen" id="chatFullscreen">
  <div class="chat-fs-header">
    <button class="chat-fs-back" onclick="closeChatFullscreen()">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <div>
      <div class="chat-fs-title">RENATO CANOVA</div>
      <div class="chat-fs-subtitle">AIã‚³ãƒ¼ãƒ ã‚³ãƒ³ã‚µãƒ«ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</div>
    </div>
  </div>
  <div class="chat-fs-messages" id="chatFsMessages"></div>
  <div class="chat-fs-input-area">
    <textarea id="chatFsInput"
      placeholder="ä¾‹ï¼šæ¥é€±æ°´æœ¨ã¯é£²ã¿ä¼šã§èµ°ã‚Œãªã„ã€èª¿æ•´ã—ã¦&#10;Shift+Enterã§é€ä¿¡"
      onkeydown="if(event.key==='Enter'&&event.shiftKey){event.preventDefault();sendChatFs();}"
      oninput="this.style.height='48px';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
    <button class="send-btn" onclick="sendChatFs()">é€ä¿¡</button>
  </div>
</div>
</body>
</html>
