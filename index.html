<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SUB3 LAB</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #222222;
    --accent: #e8ff00;
    --accent2: #ff4444;
    --accent3: #4488ff;
    --text: #f0f0f0;
    --text-muted: #666666;
    --text-dim: #333333;
    --green: #4dc84d;
    --orange: #ff8c00;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
    padding-bottom: 70px;
  }

  header {
    position: sticky;
    top: 0;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 4px; color: var(--accent); }
  .logo span { color: var(--text-muted); }

  .page { display: none; }
  .page.active { display: block; }

  /* BOTTOM NAV */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: rgba(10,10,10,0.97);
    backdrop-filter: blur(12px);
    border-top: 1px solid var(--border);
    display: flex;
    height: 60px;
    z-index: 100;
  }

  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.2s;
    font-size: 10px;
  }

  .nav-item.active { color: var(--accent); }
  .nav-icon { font-size: 20px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #222;
    color: var(--text);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 13px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 200;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* SECTIONS */
  .section { padding: 16px; }
  .section + .section { padding-top: 0; }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--text-muted);
  }

  .section-action {
    background: none;
    border: 1px solid var(--border);
    color: var(--accent);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 2px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
  }

  /* HOME: VDOT CARD */
  .vdot-card {
    background: var(--surface);
    margin: 16px;
    border-radius: 4px;
    padding: 20px;
    border: 1px solid var(--border);
  }

  .vdot-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }

  .vdot-main .label { font-size: 10px; color: var(--text-muted); letter-spacing: 2px; margin-bottom: 4px; }
  .vdot-main .number { font-family: 'Bebas Neue', sans-serif; font-size: 72px; line-height: 1; color: var(--accent); }
  .vdot-main .base { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

  .sub3-target { text-align: right; }
  .t-label { font-size: 10px; color: var(--text-muted); }
  .t-gap { font-family: 'Bebas Neue', sans-serif; font-size: 48px; line-height: 1; color: var(--accent2); }
  .t-unit { font-size: 10px; color: var(--text-muted); }

  .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 6px; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #4488ff, #e8ff00); border-radius: 2px; transition: width 0.5s; }
  .progress-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 16px; }
  .progress-labels .goal { color: var(--accent); }

  .pace-zones { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; }
  .pace-zone {
    flex-shrink: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 10px;
    text-align: center;
    min-width: 70px;
  }
  .pace-zone.highlight { border-color: var(--accent); }
  .pz-label { font-size: 9px; color: var(--text-muted); margin-bottom: 4px; }
  .pz-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }

  /* HOME: MISSION CARD */
  .mission-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .mission-header {
    background: var(--surface2);
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .mission-header-title { font-size: 11px; letter-spacing: 2px; color: var(--text-muted); font-family: 'Bebas Neue', sans-serif; }
  .mission-phase { font-size: 10px; color: var(--accent); background: rgba(232,255,0,0.1); padding: 2px 8px; border-radius: 2px; }

  .mission-item {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .mission-item:last-child { border-bottom: none; }
  .mission-item:active { background: var(--surface2); }
  .mission-item.done { opacity: 0.4; }

  .mission-day {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    line-height: 1;
    min-width: 36px;
    color: var(--text-muted);
  }
  .mission-day.today { color: var(--accent); }
  .mission-day.past { color: var(--text-dim); }

  .mission-body { flex: 1; }
  .mission-type { font-size: 11px; font-weight: 700; margin-bottom: 3px; }
  .mission-detail { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
  .mission-key { color: var(--accent); font-size: 10px; margin-top: 4px; }

  .mission-check {
    width: 24px;
    height: 24px;
    border: 1.5px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
    font-size: 14px;
  }
  .mission-check.checked { border-color: var(--green); color: var(--green); }

  .mission-generate {
    padding: 16px;
    text-align: center;
  }

  .btn-generate {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    letter-spacing: 1px;
  }

  .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

  .mission-loading {
    padding: 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
  }

  /* HOME: COACH ANALYSIS */
  .coach-card {
    background: var(--surface);
    margin: 0 16px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    padding: 16px;
  }

  .coach-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .coach-avatar { width: 36px; height: 36px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .coach-name { font-size: 13px; font-weight: 700; }
  .coach-sub { font-size: 11px; color: var(--text-muted); }

  .coach-message {
    font-size: 13px;
    line-height: 1.8;
    color: var(--text);
    border-left: 2px solid var(--accent);
    padding-left: 12px;
  }

  /* LOG PAGE */
  .import-zone {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 20px 16px;
    text-align: center;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .import-zone.has-data { padding: 12px 16px; }
  .import-zone:hover, .import-zone.drag-over { border-color: var(--accent); }
  .import-zone .iz-icon { font-size: 28px; margin-bottom: 6px; }
  .import-zone.has-data .iz-icon { font-size: 20px; margin: 0; }
  .import-zone .iz-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .import-zone.has-data .iz-title { font-size: 12px; margin: 0; color: var(--text-muted); }
  .import-zone .iz-sub { font-size: 11px; color: var(--text-muted); line-height: 1.7; }
  .import-zone.has-data .iz-sub { display: none; }

  .import-result {
    background: rgba(77,200,77,0.1);
    border: 1px solid var(--green);
    border-radius: 4px;
    padding: 10px 16px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--green);
    display: none;
  }

  .log-list { }

  .log-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    gap: 12px;
    transition: opacity 0.2s;
  }
  .log-item:active { opacity: 0.7; }

  .log-date { min-width: 44px; text-align: center; }
  .log-date .ld-day { font-family: 'Bebas Neue', sans-serif; font-size: 22px; line-height: 1; color: var(--text-muted); }
  .log-date .ld-dow { font-size: 10px; color: var(--text-dim); }

  .log-body { flex: 1; min-width: 0; }
  .log-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
  .log-meta { font-size: 12px; color: var(--text-muted); }

  .log-vdot { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent); min-width: 40px; text-align: right; }

  .type-badge {
    display: inline-block;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 2px;
    margin-right: 6px;
    letter-spacing: 1px;
  }
  .type-easy { background: #1a3a1a; color: var(--green); }
  .type-long { background: #1a2a3a; color: var(--accent3); }
  .type-tempo { background: #3a2a1a; color: var(--orange); }
  .type-interval { background: #3a1a1a; color: var(--accent2); }
  .type-race { background: #2a1a3a; color: #cc88ff; }

  /* RECORD PAGE */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 1px; }
  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px;
    font-size: 14px;
    border-radius: 4px;
    font-family: 'Noto Sans JP', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .btn-primary {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 14px;
    font-size: 14px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    margin-top: 8px;
  }

  /* STATS PAGE */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    text-align: center;
  }

  .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
  .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--accent); line-height: 1; }
  .stat-unit { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .chart-title { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 2px; }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.active { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    border-radius: 12px 12px 0 0;
    padding: 20px 20px 40px;
    transform: translateY(100%);
    transition: transform 0.3s;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-overlay.active .modal { transform: translateY(0); }

  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
  .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

  .modal-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
  .m-card { background: var(--surface2); border-radius: 4px; padding: 10px; text-align: center; }
  .ml { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
  .mv { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; }

  .coach-response { font-size: 13px; line-height: 1.8; color: var(--text); border-left: 2px solid var(--accent); padding-left: 12px; margin-bottom: 16px; }

  .btn-share {
    width: 100%;
    background: #000;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    margin-bottom: 8px;
  }

  .btn-close-modal {
    width: 100%;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
  }

  /* LOADING DOTS */
  .loading { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 13px; }
  .dots { display: flex; gap: 4px; }
  .dots span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: dot 1.2s infinite; }
  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes dot { 0%,80%,100%{opacity:0.2} 40%{opacity:1} }

  /* COACH PAGE */
  .quick-btn {
    padding: 8px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text);
    font-size: 11px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    white-space: nowrap;
    transition: border-color 0.2s;
  }
  .quick-btn:hover { border-color: var(--accent); }

  .chat-bubble {
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 12px;
    line-height: 1.7;
    max-width: 90%;
  }
  .chat-user { background: var(--surface2); align-self: flex-end; color: var(--text); }
  .chat-coach { background: #0d1a0d; border: 1px solid #1a3a1a; align-self: flex-start; color: var(--text); }
  .chat-coach strong { color: var(--accent); }
</style>
</head>
<body>

<header>
  <div class="logo">SUB3 <span>LAB</span></div>
</header>

<div class="toast" id="toast"></div>

<!-- API KEY MODAL -->
<div id="apiKeyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:24px">
  <div style="background:#111;border:1px solid #333;border-radius:16px;padding:24px;width:100%;max-width:400px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:16px;font-weight:700">ğŸ”‘ APIã‚­ãƒ¼ã‚’è¨­å®š</div><button onclick="hideApiKeyModal()" style="background:none;border:none;color:#888;font-size:22px;cursor:pointer;padding:0 4px;line-height:1">âœ•</button></div>
    <div style="font-size:12px;color:#888;margin-bottom:20px;line-height:1.8">
      AIã‚³ãƒ¼ãƒæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ Anthropic ã® APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>
      ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚<br><br>
      å–å¾—å…ˆ â†’ <span style="color:#e8ff00">console.anthropic.com</span>
    </div>
    <input id="apiKeyInput" type="password" placeholder="sk-ant-..." 
      style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #444;border-radius:8px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;margin-bottom:12px"
      onkeydown="if(event.key==='Enter')saveApiKey()">
    <button onclick="saveApiKey()" style="width:100%;padding:13px;background:#e8ff00;color:#000;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer">ä¿å­˜ã—ã¦ä½¿ã„å§‹ã‚ã‚‹</button>
    <div id="apiKeyError" style="font-size:11px;color:#ff4444;margin-top:8px;text-align:center"></div>
    <button onclick="hideApiKeyModal()" style="width:100%;padding:10px;background:none;color:#666;border:none;font-size:12px;cursor:pointer;margin-top:4px">ä»Šã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAIã‚³ãƒ¼ãƒã¯ä½¿ãˆã¾ã›ã‚“ï¼‰</button>
  </div>
</div>

<!-- PAGE: HOME -->
<div class="page active" id="page-home">

  <!-- VDOT CARD -->
  <div class="vdot-card">
    <div class="vdot-top">
      <div class="vdot-main">
        <div class="label">CURRENT VDOT</div>
        <div class="number" id="currentVdot">â€”</div>
        <div class="base" id="vdotBase">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="sub3-target">
        <div class="t-label">ã‚ã¨</div>
        <div class="t-gap" id="vdotGap">â€”</div>
        <div class="t-unit">VDOT pts</div>
      </div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-labels"><span>30</span><span class="goal">SUB3 = VDOT 53</span></div>
    <div class="pace-zones" id="paceZones"></div>
  </div>

  <!-- WEEKLY MISSION -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
      <button class="section-action" onclick="generateWeeklyMission()">æ›´æ–°</button>
    </div>
  </div>

  <div class="mission-card" id="missionCard">
    <div class="mission-generate">
      <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‹ã‚‰ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„</p>
      <button class="btn-generate" id="generateBtn" onclick="generateWeeklyMission()">ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>
  </div>

  <!-- AI COACH -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ã‚³ãƒ¼ãƒåˆ†æ</div>
    </div>
  </div>

  <div class="coach-card">
    <div class="coach-header">
      <div class="coach-avatar">ğŸƒ</div>
      <div>
        <div class="coach-name">AIã‚³ãƒ¼ãƒ</div>
        <div class="coach-sub" id="coachSubtitle">é€±æ¬¡ã‚®ãƒ£ãƒƒãƒ—åˆ†æ</div>
      </div>
    </div>
    <div class="coach-message" id="coachMessage">
      ã€Œä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€å…¨ç·´ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã‚µãƒ–ã‚¹ãƒªãƒ¼ã¾ã§ã®ã‚®ãƒ£ãƒƒãƒ—ã¨ä»Šé€±ã‚„ã‚‹ã¹ãã“ã¨ã‚’å…·ä½“çš„ã«æ•™ãˆã¾ã™ã€‚
    </div>
  </div>

</div>

<!-- PAGE: LOG -->
<div class="page" id="page-log">
  <div style="padding: 16px 16px 0;">
    <div class="import-zone" id="importZone"
      onclick="document.getElementById('fileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleFileDrop(event)">
      <div class="iz-icon">ğŸ“‚</div>
      <div class="iz-title">FIT / CSV ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      <div class="iz-sub">FITè¤‡æ•°ãƒ»ZIPã‚‚å¯¾å¿œ / Stravaã®CSVã‚‚å¯<br>Coros Training Hub â†’ Export Data â†’ FIT</div>
    </div>
    <input type="file" id="fileInput" accept=".fit,.csv,.zip,*/*" multiple style="display:none" onchange="handleFileSelectMulti(this.files)">
    <div class="import-result" id="importResult" style="display:none"></div>
    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆé€²æ— -->
    <div id="importProgress" style="display:none;margin-top:10px;background:var(--surface);border-radius:8px;padding:12px;font-size:12px">
      <div id="importProgressText" style="color:var(--text-muted);margin-bottom:6px">å‡¦ç†ä¸­...</div>
      <div style="background:var(--border);border-radius:4px;height:4px">
        <div id="importProgressBar" style="background:var(--accent);height:4px;border-radius:4px;width:0%;transition:width 0.2s"></div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ç·´ç¿’ãƒ­ã‚°</div>
      <span id="logCount" style="font-size:11px;color:var(--text-muted);"></span>
    </div>
    <div class="log-list" id="logList"></div>
  </div>
</div>

<!-- PAGE: COACH -->
<div class="page" id="page-coach">
  <div style="padding: 16px;">

    <!-- ã‚³ãƒ¼ãƒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:16px;background:var(--surface);border-radius:12px;border:1px solid var(--border)">
      <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">ğŸ‡®ğŸ‡¹</div>
      <div>
        <div style="font-size:13px;font-weight:700;letter-spacing:1px">RENATO CANOVA</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">42 Olympic/World medals Â· Marathon Science Expert</div>
        <div style="font-size:10px;color:var(--accent);margin-top:3px">ã€Œãƒãƒ©ã‚½ãƒ³ã¯å»¶é•·ã®å•é¡Œã ã€</div>
      </div>
    </div>

    <!-- é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:10px">WEEKLY REVIEW</div>
      <div id="weeklyReview" style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px;font-size:13px;line-height:1.9;color:var(--text)">
        ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã‚«ãƒãƒ¼ãƒãŒå…ˆé€±ã®ç·´ç¿’ã‚’æ¡ç‚¹ã—ã¾ã™ã€‚
      </div>
      <button onclick="generateWeeklyReview()" style="margin-top:10px;width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;letter-spacing:1px">ğŸ”„ é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°</button>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆç›¸è«‡ -->
    <div style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:10px">COACH CONSULTATION</div>
      <div id="chatHistory" style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px;min-height:120px;max-height:400px;overflow-y:auto;display:flex;flex-direction:column;gap:12px">
        <div style="font-size:12px;color:var(--text-muted);text-align:center">ã‚³ãƒ¼ãƒã«ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚<br>å…¨ç·´ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ãŸçŠ¶æ…‹ã§ç­”ãˆã¾ã™ã€‚</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chatInput" type="text" placeholder="ä¾‹ï¼šè†ãŒç—›ã„ã€ä»Šé€±ã©ã†ã™ã¹ãï¼Ÿ" style="flex:1;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none" onkeydown="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()" style="padding:12px 16px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap">é€ä¿¡</button>
      </div>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ç›¸è«‡ãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom:20px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:10px">QUICK CONSULT</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <button onclick="quickChat('ä»Šæœˆã®10kmã‚¿ã‚¤ãƒ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„')" class="quick-btn">ğŸ“ 10km TTæŒ‡ç¤º</button>
        <button onclick="quickChat('é–¢æ±ã§ç›´è¿‘2ã€œ3ãƒ¶æœˆä»¥å†…ã«é–‹å‚¬ã•ã‚Œã‚‹ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³ã®ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚å‡ºã‚‹ã¹ãå¤§ä¼šã‚’1ã¤æ¨è–¦ã—ã¦ãã ã•ã„')" class="quick-btn">ğŸ† ãƒ¬ãƒ¼ã‚¹æ¨è–¦</button>
        <button onclick="quickChat('ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã¨æ®‹ã‚ŠæœŸé–“ã‚’è¸ã¾ãˆã¦ã€ä»Šå¾Œ8é€±é–“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨ˆç”»ã‚’å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„')" class="quick-btn">ğŸ“… 8é€±é–“è¨ˆç”»</button>
        <button onclick="quickChat('ç§ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€ã‚µãƒ–ã‚¹ãƒªãƒ¼é”æˆã®å¯èƒ½æ€§ã¨æœ€å¤§ã®èª²é¡Œã‚’æ•™ãˆã¦ãã ã•ã„')" class="quick-btn">ğŸ¯ é”æˆå¯èƒ½æ€§è¨ºæ–­</button>
      </div>
    </div>

  </div>
</div>

<!-- PAGE: STATS -->
<div class="page" id="page-stats">
  <div style="padding: 16px;">
    <div class="section-title" style="margin-bottom:16px;">çµ±è¨ˆ</div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ç·èµ°è¡Œè·é›¢</div>
        <div class="stat-val" id="totalDist">â€”</div>
        <div class="stat-unit">km</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è¨˜éŒ²æ•°</div>
        <div class="stat-val" id="totalRuns">â€”</div>
        <div class="stat-unit">æœ¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æœ€é«˜VDOT</div>
        <div class="stat-val" id="maxVdot">â€”</div>
        <div class="stat-unit">æ¨å®šå€¤</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»Šæœˆè·é›¢</div>
        <div class="stat-val" id="monthDist">â€”</div>
        <div class="stat-unit">km</div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">VDOTæ¨ç§»ï¼ˆç›´è¿‘20æœ¬ï¼‰</div>
      <canvas id="vdotChart" height="120"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-title">æœˆåˆ¥èµ°è¡Œè·é›¢</div>
      <canvas id="monthlyChart" height="120"></canvas>
    </div>

    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
    <div style="margin-top:24px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:12px">DATA BACKUP</div>
      <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:14px;line-height:1.7">
          âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div style="display:flex;gap:8px">
          <button onclick="exportBackup()" style="flex:1;padding:12px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer">â¬‡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
          <button onclick="document.getElementById('restoreInput').click()" style="flex:1;padding:12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer">â¬† å¾©å…ƒ</button>
          <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="importBackup(this.files[0])">
        </div>
        <div id="backupStatus" style="font-size:11px;color:var(--text-muted);margin-top:10px;text-align:center"></div>
      </div>
    </div>

    <!-- APIã‚­ãƒ¼è¨­å®š -->
    <div style="margin-top:16px">
      <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:12px">AI COACH SETTINGS</div>
      <div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:16px">
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">APIã‚­ãƒ¼è¨­å®šçŠ¶æ³ï¼š<span id="apiKeyStatus" style="color:var(--accent)">ç¢ºèªä¸­...</span></div>
        <button onclick="showApiKeyModal()" style="width:100%;padding:12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer">ğŸ”‘ APIã‚­ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹</button>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('home', this)">
    <span class="nav-icon">ğŸ </span>
    <span style="font-size:10px;">HOME</span>
  </button>
  <button class="nav-item" onclick="showPage('log', this)">
    <span class="nav-icon">ğŸ“‹</span>
    <span style="font-size:10px;">LOG</span>
  </button>
  <button class="nav-item" onclick="showPage('coach', this)">
    <span class="nav-icon">ğŸ‡®ğŸ‡¹</span>
    <span style="font-size:10px;">COACH</span>
  </button>
  <button class="nav-item" onclick="showPage('stats', this)">
    <span class="nav-icon">ğŸ“Š</span>
    <span style="font-size:10px;">STATS</span>
  </button>
</nav>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal" onclick="closeDetailModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailTitle">ç·´ç¿’è©³ç´°</div>
    <div class="modal-metrics" id="detailMetrics"></div>
    <div class="coach-response" id="detailCoach">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> AIã‚³ãƒ¼ãƒãŒåˆ†æä¸­...</div>
    </div>
    <button class="btn-share" onclick="shareToX()">ğ• ã§ã‚·ã‚§ã‚¢</button>
    <button class="btn-close-modal" onclick="document.getElementById('detailModal').classList.remove('active')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const CONFIG = {
  targetVdot: 53,
  targetRace: 'ã¤ãã°ãƒãƒ©ã‚½ãƒ³2026',
  targetDate: '2026-11-22',
  athleteName: 'å·å³¶å¤§è¼',
  weeklyDays: 5,
  // ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©
  phases: [
    { name: 'Phase1', label: 'é–¾å€¤å¼·åŒ–', end: '2026-04-30', goal: '4\'30"/kmã§ãƒãƒ¼ãƒ•ã‚’èµ°ã‚‹', color: '#4488ff' },
    { name: 'Phase2', label: 'ãƒãƒ©ã‚½ãƒ³ç‰¹ç•°çš„æŒä¹…åŠ›', end: '2026-07-31', goal: '4\'15"/kmã§30kmèµ°ã‚‹', color: '#e8ff00' },
    { name: 'Phase3', label: 'ãƒ¬ãƒ¼ã‚¹ä»•ä¸Šã’', end: '2026-11-22', goal: 'ã¤ãã°ã‚µãƒ–ã‚¹ãƒªãƒ¼é”æˆ', color: '#ff4444' },
  ]
};

// ===== UTILS =====
function calcVDOT(distKm, timeSec) {
  if (!distKm || !timeSec || distKm < 3) return null;
  const speedMperMin = (distKm * 1000) / (timeSec / 60);
  const vo2 = -4.60 + 0.182258 * speedMperMin + 0.000104 * Math.pow(speedMperMin, 2);
  const pct = 0.8 + 0.1894393 * Math.exp(-0.012778 * (timeSec/60)) + 0.2989558 * Math.exp(-0.1932605 * (timeSec/60));
  const vdot = Math.round(vo2 / pct);
  return vdot > 20 && vdot < 90 ? vdot : null;
}

function getPaceZones(vdot) {
  // Jack Daniels VDOTãƒ†ãƒ¼ãƒ–ãƒ«
  const table = {
    38: { easy:'6\'42"', marathon:'5\'45"', threshold:'5\'13"', interval:'4\'51"', rep:'4\'31"' },
    39: { easy:'6\'37"', marathon:'5\'40"', threshold:'5\'08"', interval:'4\'47"', rep:'4\'27"' },
    40: { easy:'6\'32"', marathon:'5\'36"', threshold:'5\'05"', interval:'4\'44"', rep:'4\'24"' },
    41: { easy:'6\'27"', marathon:'5\'31"', threshold:'5\'01"', interval:'4\'40"', rep:'4\'21"' },
    42: { easy:'6\'22"', marathon:'5\'27"', threshold:'4\'57"', interval:'4\'37"', rep:'4\'18"' },
    43: { easy:'6\'17"', marathon:'5\'23"', threshold:'4\'53"', interval:'4\'33"', rep:'4\'14"' },
    44: { easy:'6\'12"', marathon:'5\'18"', threshold:'4\'49"', interval:'4\'30"', rep:'4\'11"' },
    45: { easy:'6\'08"', marathon:'5\'15"', threshold:'4\'46"', interval:'4\'27"', rep:'4\'08"' },
    46: { easy:'6\'03"', marathon:'5\'11"', threshold:'4\'42"', interval:'4\'23"', rep:'4\'05"' },
    47: { easy:'5\'59"', marathon:'5\'07"', threshold:'4\'39"', interval:'4\'20"', rep:'4\'02"' },
    48: { easy:'5\'55"', marathon:'5\'03"', threshold:'4\'35"', interval:'4\'17"', rep:'3\'59"' },
    49: { easy:'5\'51"', marathon:'4\'59"', threshold:'4\'32"', interval:'4\'14"', rep:'3\'57"' },
    50: { easy:'5\'47"', marathon:'4\'56"', threshold:'4\'28"', interval:'4\'11"', rep:'3\'54"' },
    53: { easy:'5\'36"', marathon:'4\'46"', threshold:'4\'20"', interval:'4\'03"', rep:'3\'46"' },
  };
  const keys = Object.keys(table).map(Number).sort((a,b) => a-b);
  let best = keys[0];
  for (const k of keys) { if (k <= vdot) best = k; }
  return table[best] || table[40];
}

function formatPace(distKm, timeSec) {
  if (!distKm || !timeSec) return 'â€”';
  const paceTotal = timeSec / distKm;
  const min = Math.floor(paceTotal / 60);
  const sec = Math.round(paceTotal % 60);
  return `${min}'${String(sec).padStart(2,'0')}"`;
}

function parseDuration(str) {
  if (!str) return 0;
  const parts = String(str).split(':').map(Number);
  if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
  if (parts.length === 2) return parts[0]*60 + parts[1];
  return parseInt(str) || 0;
}

function formatDuration(sec) {
  sec = Math.round(sec);
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function getCurrentPhase() {
  const today = new Date();
  for (const p of CONFIG.phases) {
    if (today <= new Date(p.end)) return p;
  }
  return CONFIG.phases[CONFIG.phases.length - 1];
}

function getTypeLabel(type) {
  const labels = { easy:'Easyèµ°', long:'ãƒ­ãƒ³ã‚°èµ°', tempo:'é–¾å€¤èµ°', interval:'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«', rep:'ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³', race:'ãƒ¬ãƒ¼ã‚¹' };
  return labels[type] || type || 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°';
}

function classifyRunByPace(distKm, timeSec) {
  if (!distKm || !timeSec) return 'easy';
  const paceSecPerKm = timeSec / distKm;
  if (distKm >= 28) return 'long';
  if (paceSecPerKm < 265) return 'interval'; // 4'25"/kmä»¥ä¸‹
  if (paceSecPerKm < 295) return 'tempo';    // 4'55"/kmä»¥ä¸‹
  if (distKm >= 18) return 'long';
  return 'easy';
}

// ===== LOCAL STORAGE =====
function getLogs() {
  try { return JSON.parse(localStorage.getItem('sub3_logs') || '[]'); } catch { return []; }
}
function saveLogs(logs) { localStorage.setItem('sub3_logs', JSON.stringify(logs)); }
function addLog(log) {
  const logs = getLogs();
  log.id = Date.now();
  logs.unshift(log);
  saveLogs(logs);
  return log;
}
function getMission() {
  try { return JSON.parse(localStorage.getItem('sub3_mission') || 'null'); } catch { return null; }
}
function saveMission(m) { localStorage.setItem('sub3_mission', JSON.stringify(m)); }

// ===== UI =====
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'log') renderLogList();
  if (name === 'stats') renderStats();
}

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ===== VDOT CARD =====
function renderVdotCard(vdot) {
  if (!vdot) return;
  document.getElementById('currentVdot').textContent = vdot;
  document.getElementById('vdotGap').textContent = Math.max(0, CONFIG.targetVdot - vdot);
  const pct = Math.min(100, Math.max(0, (vdot - 30) / (CONFIG.targetVdot - 30) * 100));
  document.getElementById('progressFill').style.width = pct + '%';

  const zones = getPaceZones(vdot);
  document.getElementById('paceZones').innerHTML = `
    <div class="pace-zone"><div class="pz-label">EASY</div><div class="pz-val">${zones.easy}</div></div>
    <div class="pace-zone highlight"><div class="pz-label">MARATHON</div><div class="pz-val">${zones.marathon}</div></div>
    <div class="pace-zone highlight"><div class="pz-label">TEMPO</div><div class="pz-val">${zones.threshold}</div></div>
    <div class="pace-zone"><div class="pz-label">INTERVAL</div><div class="pz-val">${zones.interval}</div></div>
    <div class="pace-zone"><div class="pz-label">REP</div><div class="pz-val">${zones.rep}</div></div>
  `;

  // æœ€é«˜è¨˜éŒ²ã‚’æ¢ã—ã¦ãƒ™ãƒ¼ã‚¹ã«è¡¨ç¤º
  const logs = getLogs();
  let bestLog = null, bestVdot = 0;
  for (const l of logs) {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || parseDuration(l.duration);
    if (dist < 5) continue;
    const v = calcVDOT(dist, timeSec);
    if (v && v > bestVdot) { bestVdot = v; bestLog = l; }
  }
  if (bestLog) {
    const dist = parseFloat(bestLog.distKm) || 0;
    const timeSec = parseInt(bestLog.moving_time) || parseDuration(bestLog.duration);
    document.getElementById('vdotBase').textContent = `${dist.toFixed(1)}km @ ${formatPace(dist, timeSec)}`;
  }
}

// ===== FIND BEST VDOT =====
function findBestVdot() {
  const logs = getLogs();
  let best = 0;
  for (const l of logs) {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || parseDuration(l.duration);
    if (dist < 5) continue;
    const v = calcVDOT(dist, timeSec);
    if (v && v > best) best = v;
  }
  return best || 40;
}

// ===== WEEKLY MISSION GENERATION =====
async function generateWeeklyMission() {
  const logs = getLogs();
  if (logs.length === 0) {
    showToast('âš ï¸ ã¾ãšCSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„');
    return;
  }

  const btn = document.getElementById('generateBtn');
  if (btn) btn.disabled = true;

  document.getElementById('missionCard').innerHTML = `
    <div class="mission-loading">
      <div class="loading"><div class="dots"><span></span><span></span><span></span></div> å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆä¸­...</div>
    </div>`;

  document.getElementById('coachMessage').innerHTML = `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> åˆ†æä¸­...</div>`;

  // å…¨ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆã‚’è¨ˆç®—ã—ã¦AIã«æ¸¡ã™
  const currentVdot = findBestVdot();
  const phase = getCurrentPhase();

  // ç›´è¿‘4é€±é–“ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿
  const fourWeeksAgo = new Date();
  fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
  const recentLogs = logs.filter(l => new Date(l.date) >= fourWeeksAgo);

  // æœˆåˆ¥è·é›¢
  const monthly = {};
  logs.forEach(l => {
    const month = l.date?.substring(0, 7);
    if (month) monthly[month] = (monthly[month] || 0) + (parseFloat(l.distKm) || 0);
  });

  // ãƒšãƒ¼ã‚¹åˆ†å¸ƒ
  const paceAnalysis = logs.reduce((acc, l) => {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || 0;
    if (dist < 1 || timeSec < 60) return acc;
    const paceSecPerKm = timeSec / dist;
    if (paceSecPerKm < 265) acc.fast++;
    else if (paceSecPerKm < 295) acc.tempo++;
    else if (paceSecPerKm < 330) acc.marathon++;
    else acc.easy++;
    return acc;
  }, { fast: 0, tempo: 0, marathon: 0, easy: 0 });

  // ãƒ­ãƒ³ã‚°èµ°ãƒ‡ãƒ¼ã‚¿
  const longRuns = logs.filter(l => (parseFloat(l.distKm) || 0) >= 20)
    .map(l => `${parseFloat(l.distKm).toFixed(0)}km@${formatPace(parseFloat(l.distKm), parseInt(l.moving_time))}`);

  // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  const thisWeek = logs.filter(l => new Date(l.date) >= weekAgo);

  const dataContext = `
é¸æ‰‹ï¼šå·å³¶å¤§è¼ã€31æ­³
ç¾åœ¨VDOTï¼š${currentVdot}
ç›®æ¨™ï¼š${CONFIG.targetRace}ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53ï¼‰
ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºï¼š${phase.name} ${phase.label}ï¼ˆç›®æ¨™ï¼š${phase.goal}ï¼‰
é€±5æ—¥ç·´ç¿’å¯èƒ½

ã€å…¨ç·´ç¿’ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆï¼ˆ${logs.length}ä»¶ï¼‰ã€‘
æœˆåˆ¥èµ°è¡Œè·é›¢ï¼š${Object.entries(monthly).sort().map(([m,d])=>`${m}:${d.toFixed(0)}km`).join(', ')}

ãƒšãƒ¼ã‚¹åˆ†å¸ƒï¼š
- 4'25"ä»¥ä¸‹ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰åŸŸï¼‰ï¼š${paceAnalysis.fast}æœ¬
- 4'25"-4'55"ï¼ˆé–¾å€¤åŸŸï¼‰ï¼š${paceAnalysis.tempo}æœ¬
- 4'55"-5'30"ï¼ˆãƒãƒ©ã‚½ãƒ³ãƒšãƒ¼ã‚¹åŸŸï¼‰ï¼š${paceAnalysis.marathon}æœ¬
- 5'30"ä»¥ä¸Šï¼ˆEasyåŸŸï¼‰ï¼š${paceAnalysis.easy}æœ¬

ãƒ­ãƒ³ã‚°èµ°å®Ÿç¸¾ï¼š${longRuns.join(', ')}

ç›´è¿‘4é€±é–“ï¼ˆ${recentLogs.length}æœ¬ï¼‰ï¼š
${recentLogs.slice(0, 20).map(l => {
  const dist = parseFloat(l.distKm) || 0;
  const timeSec = parseInt(l.moving_time) || 0;
  return `${l.date?.substring(5)} ${dist.toFixed(1)}km@${formatPace(dist, timeSec)} HR${l.average_heartrate ? Math.round(l.average_heartrate) : 'â€”'}`;
}).join('\n')}

ä»Šé€±å®Ÿç¸¾ï¼š${thisWeek.length}æœ¬ã€${thisWeek.reduce((s,l) => s + (parseFloat(l.distKm)||0), 0).toFixed(0)}km

ã€é‡è¦ãªæœ€è¿‘ã®æƒ…å ±ã€‘
- 2/15ã«é’æ¢…ãƒãƒ©ã‚½ãƒ³30kmï¼ˆå…¬å¼ã‚³ãƒ¼ã‚¹ï¼šé›£ã‚³ãƒ¼ã‚¹ï¼‰ã‚’5'23"/kmã€HR157ã§å®Œèµ°
- 2/22ã«4'15"ãƒšãƒ¼ã‚¹ã§2kmè©¦ã¿ã‚‹ã‚‚å¿ƒæ‹166ã§ã‚¼ã‚¨ã‚¼ã‚¨ï¼ˆç¾åœ¨ã®é–¾å€¤ãŒ4'15"ä»˜è¿‘ï¼‰
- ã‚¹ã‚¿ãƒŸãƒŠã¯ã‚ã‚‹ãŒã€ã‚¹ãƒ”ãƒ¼ãƒ‰æŒä¹…åŠ›ï¼ˆä¹³é…¸é–¾å€¤ï¼‰ãŒä¸è¶³`;

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1500,
        system: `ã‚ãªãŸã¯Jack Danielsã®VDOTãƒ¡ã‚½ãƒƒãƒ‰ã«ç²¾é€šã—ãŸã‚¨ãƒªãƒ¼ãƒˆãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚’ç§‘å­¦çš„ã«åˆ†æã—ã€é¸æ‰‹ã®ç¾çŠ¶ã¨ç›®æ¨™ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ãŸä¸Šã§ã€ä»Šé€±å®Ÿè¡Œã™ã¹ãå…·ä½“çš„ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

è¿”ç­”ã¯JSONå½¢å¼ã®ã¿ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã€‚ä½™åˆ†ãªãƒ†ã‚­ã‚¹ãƒˆä¸è¦ã€‚
{
  "diagnosis": "ç¾çŠ¶ã¨æ–¹é‡ã‚’150å­—ä»¥å†…ã§",
  "missions": [
    {
      "day": "æœˆ",
      "type": "Easyèµ°",
      "distance": "10km",
      "pace": "5åˆ†40ç§’ã‹ã‚‰5åˆ†50ç§’",
      "detail": "å¿ƒæ‹140-150ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹èµ°",
      "key": "æœ‰é…¸ç´ ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰"
    }
  ]
}
é‡è¦: ãƒšãƒ¼ã‚¹ã¯å¿…ãšã€ŒXåˆ†XXç§’ã€ã®å½¢å¼ã§è¨˜è¼‰ã€‚ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚„å¼•ç”¨ç¬¦ã¯ä½¿ã‚ãªã„ã€‚missionsã¯é€±5æœ¬ã€‚æ›œæ—¥ã¯æœˆç«æ°´æœ¨é‡‘åœŸæ—¥ã‹ã‚‰é¸ã¶ã€‚`,
        messages: [{ role: "user", content: dataContext }]
    });
    const text = data.content?.[0]?.text || '';

    let parsed;
    try {
      // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Œå…¨é™¤å»ã—ã¦ã‹ã‚‰JSONã‚’æŠ½å‡º
      let clean = text
        .replace(/^```[\w]*\n?/gm, '')  // ```json ã‚„ ``` ã‚’é™¤å»
        .replace(/```$/gm, '')
        .trim();
      // {...}ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã ã‘æŠ½å‡º
      const jsonMatch = clean.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('No JSON found in: ' + text.slice(0,50));
      clean = jsonMatch[0];
      parsed = JSON.parse(clean);
    } catch(e) {
      console.error('JSON raw response:', text);
      throw new Error('JSON parse failed: ' + text.slice(0, 100));
    }

    saveMission({ ...parsed, generatedAt: new Date().toISOString() });
    renderMissionCard(parsed);
    document.getElementById('coachMessage').innerHTML = parsed.diagnosis;
    document.getElementById('coachSubtitle').textContent = `${phase.label} | ${new Date().toLocaleDateString('ja-JP', {month:'short', day:'numeric'})}æ›´æ–°`;

  } catch(e) {
    console.error(e);
    const errMsg = e?.message || String(e);
    document.getElementById('missionCard').innerHTML = `
      <div class="mission-generate">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
        <p style="font-size:10px;color:#ff6666;margin-bottom:12px;word-break:break-all;">${errMsg}</p>
        <button class="btn-generate" onclick="generateWeeklyMission()">å†è©¦è¡Œ</button>
      </div>`;
    document.getElementById('coachMessage').textContent = 'åˆ†æã«å¤±æ•—: ' + errMsg;
  } finally {
    const btn = document.getElementById('generateBtn');
    if (btn) btn.disabled = false;
  }
}

function renderMissionCard(mission) {
  const days = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  const today = new Date();
  const todayDow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][today.getDay()];

  const items = (mission.missions || []).map(m => {
    const isToday = m.day === todayDow;
    const isPast = days.indexOf(m.day) < days.indexOf(todayDow);
    const typeClass = {
      'Easyèµ°': 'type-easy',
      'ãƒ­ãƒ³ã‚°èµ°': 'type-long',
      'é–¾å€¤èµ°': 'type-tempo',
      'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«': 'type-interval',
      'ãƒ¬ãƒšãƒ†ã‚£ã‚·ãƒ§ãƒ³': 'type-interval',
      'ãƒ¬ãƒ¼ã‚¹': 'type-race'
    }[m.type] || 'type-easy';

    return `
      <div class="mission-item ${isPast ? 'past' : ''}">
        <div class="mission-day ${isToday ? 'today' : isPast ? 'past' : ''}">${m.day}</div>
        <div class="mission-body">
          <div class="mission-type">
            <span class="type-badge ${typeClass}">${m.type}</span>${m.distance}
          </div>
          <div class="mission-detail">${m.pace}${m.detail ? ' Â· ' + m.detail : ''}</div>
          ${m.key ? `<div class="mission-key">â–¶ ${m.key}</div>` : ''}
        </div>
        <div class="mission-check ${isPast ? 'checked' : ''}">
          ${isPast ? 'âœ“' : ''}
        </div>
      </div>`;
  }).join('');

  const phase = getCurrentPhase();
  document.getElementById('missionCard').innerHTML = `
    <div class="mission-header">
      <div class="mission-header-title">WEEKLY MISSION</div>
      <div class="mission-phase">${phase.label}</div>
    </div>
    ${items}`;
}

// ===== LOG =====
let currentLogIndex = null;

function deleteLog(index) {
  const logs = getLogs();
  const log = logs[index];
  const name = log.name || `${parseFloat(log.distKm).toFixed(1)}kmèµ°`;
  if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  logs.splice(index, 1);
  saveLogs(logs);
  renderLogList();
  renderVdotCard(findBestVdot());
  showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

function renderLogList() {
  const logs = getLogs();
  const container = document.getElementById('logList');
  document.getElementById('logCount').textContent = logs.length + 'ä»¶';

  // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«
  const importZone = document.getElementById('importZone');
  if (logs.length > 0) {
    importZone.classList.add('has-data');
    importZone.innerHTML = `<div style="display:flex;align-items:center;gap:8px;justify-content:center"><span class="iz-icon">ğŸ“‚</span><span class="iz-title">FITè¤‡æ•°ãƒ»ZIP / CSV ã‚’è¿½åŠ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span></div>`;
  }

  if (logs.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:40px 0;color:var(--text-muted)">
      <div style="font-size:40px;margin-bottom:12px">ğŸƒ</div>
      <div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
      <div style="font-size:12px;margin-top:8px">CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å§‹ã‚ã‚ˆã†</div>
    </div>`;
    return;
  }

  const dowLabels = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

  container.innerHTML = logs.map((log, i) => {
    const dist = parseFloat(log.distKm) || 0;
    const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
    const pace = formatPace(dist, timeSec);
    const vdot = dist >= 3 ? calcVDOT(dist, timeSec) : null;
    const hr = log.average_heartrate ? `HR${Math.round(log.average_heartrate)}` : '';
    const date = new Date(log.date);
    const day = isNaN(date) ? 'â€”' : date.getDate();
    const dow = isNaN(date) ? '' : dowLabels[date.getDay()];
    const runType = log.runType || classifyRunByPace(dist, timeSec);
    const typeClass = { easy:'type-easy', long:'type-long', tempo:'type-tempo', interval:'type-interval', race:'type-race' }[runType] || 'type-easy';
    const typeName = { easy:'EASY', long:'LONG', tempo:'TEMPO', interval:'INT', race:'RACE' }[runType] || 'RUN';

    return `<div class="log-item" onclick="showLogDetail(${i})">
      <div class="log-date">
        <div class="ld-day">${day}</div>
        <div class="ld-dow">${dow}</div>
      </div>
      <div class="log-body">
        <div class="log-name">
          <span class="type-badge ${typeClass}">${typeName}</span>${log.name || dist.toFixed(1) + 'kmèµ°'}
        </div>
        <div class="log-meta">${dist.toFixed(1)}kmã€€${pace}/km${hr ? 'ã€€' + hr : ''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="log-vdot">${vdot || 'â€”'}</div>
        <button onclick="event.stopPropagation();deleteLog(${i})" style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;padding:4px 6px;border-radius:6px;line-height:1" title="å‰Šé™¤">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

async function showLogDetail(index) {
  currentLogIndex = index;
  const logs = getLogs();
  const log = logs[index];
  const dist = parseFloat(log.distKm) || 0;
  const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
  const pace = formatPace(dist, timeSec);
  const vdot = calcVDOT(dist, timeSec);
  const hr = log.average_heartrate ? Math.round(log.average_heartrate) : 'â€”';
  const isFit = log.source === 'coros_fit';

  document.getElementById('detailTitle').textContent = log.name || dist.toFixed(1) + 'kmèµ°';

  // åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
  let metricsHTML = `
    <div class="m-card"><div class="ml">è·é›¢</div><div class="mv">${dist.toFixed(1)}<span style="font-size:11px">km</span></div></div>
    <div class="m-card"><div class="ml">ãƒšãƒ¼ã‚¹</div><div class="mv" style="font-size:13px">${pace}</div></div>
    <div class="m-card"><div class="ml">VDOT</div><div class="mv">${vdot || 'â€”'}</div></div>
    <div class="m-card"><div class="ml">ã‚¿ã‚¤ãƒ </div><div class="mv" style="font-size:13px">${formatDuration(timeSec)}</div></div>
    <div class="m-card"><div class="ml">å¹³å‡HR</div><div class="mv">${hr}</div></div>
    <div class="m-card"><div class="ml">æœ€å¤§HR</div><div class="mv">${log.max_heartrate || 'â€”'}</div></div>`;

  // FITãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  if (isFit) {
    metricsHTML += `
    <div class="m-card"><div class="ml">ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹</div><div class="mv" style="font-size:14px">${log.avg_cadence || 'â€”'}<span style="font-size:10px">spm</span></div></div>
    <div class="m-card"><div class="ml">ãƒ‘ãƒ¯ãƒ¼</div><div class="mv" style="font-size:14px">${log.avg_power || 'â€”'}<span style="font-size:10px">W</span></div></div>
    <div class="m-card"><div class="ml">ç²å¾—æ¨™é«˜</div><div class="mv" style="font-size:14px">${log.total_ascent || 'â€”'}<span style="font-size:10px">m</span></div></div>`;
  }

  document.getElementById('detailMetrics').innerHTML = metricsHTML;

  // ãƒ©ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆFITã®ã¿ï¼‰
  let lapHTML = '';
  if (isFit && log.laps && log.laps.length > 0) {
    const lapRows = log.laps.filter(l => l.dist && l.dist > 0.3).map((l, i) => {
      const lapPace = l.dist && l.time ? formatPace(l.dist, l.time) : 'â€”';
      const lapHR = l.hr || 'â€”';
      return `<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="color:var(--text-muted);min-width:30px">${i+1}km</span>
        <span style="font-family:'JetBrains Mono',monospace;min-width:60px">${lapPace}/km</span>
        <span style="color:var(--text-muted)">HR${lapHR}</span>
      </div>`;
    }).join('');
    if (lapRows) {
      lapHTML = `<div style="margin-bottom:14px">
        <div style="font-size:10px;color:var(--text-muted);letter-spacing:2px;margin-bottom:8px">LAP DATA</div>
        ${lapRows}
      </div>`;
    }
  }

  document.getElementById('detailCoach').innerHTML = lapHTML + `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> AIã‚³ãƒ¼ãƒãŒåˆ†æä¸­...</div>`;
  document.getElementById('detailModal').classList.add('active');

  // AIã«æ¸¡ã™è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
  let coachPrompt = `ç·´ç¿’ï¼š${log.name}ã€${dist.toFixed(1)}kmã€${formatDuration(timeSec)}ã€${pace}/kmã€å¹³å‡HR${hr}bpm`;
  if (isFit) {
    if (log.max_heartrate) coachPrompt += `ã€æœ€å¤§HR${log.max_heartrate}bpm`;
    if (log.avg_cadence) coachPrompt += `ã€ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹${log.avg_cadence}spm`;
    if (log.avg_power) coachPrompt += `ã€å¹³å‡ãƒ‘ãƒ¯ãƒ¼${log.avg_power}W`;
    if (log.total_ascent) coachPrompt += `ã€ç²å¾—æ¨™é«˜${log.total_ascent}m`;
    if (vdot) coachPrompt += `ã€VDOTæ›ç®—${vdot}`;
    // ãƒ©ãƒƒãƒ—ã®å‰åŠãƒ»å¾ŒåŠæ¯”è¼ƒ
    if (log.laps && log.laps.length >= 4) {
      const half = Math.floor(log.laps.length / 2);
      const firstHalf = log.laps.slice(0, half).filter(l => l.time && l.dist);
      const secondHalf = log.laps.slice(half).filter(l => l.time && l.dist);
      if (firstHalf.length && secondHalf.length) {
        const fPace = formatPace(
          firstHalf.reduce((s,l) => s + l.dist, 0),
          firstHalf.reduce((s,l) => s + l.time, 0)
        );
        const sPace = formatPace(
          secondHalf.reduce((s,l) => s + l.dist, 0),
          secondHalf.reduce((s,l) => s + l.time, 0)
        );
        coachPrompt += `ã€‚å‰åŠãƒšãƒ¼ã‚¹${fPace}/kmã€å¾ŒåŠãƒšãƒ¼ã‚¹${sPace}/km`;
      }
    }
  }

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 600,
        system: `ã‚ãªãŸã¯ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚ã“ã®ç·´ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ç§‘å­¦çš„ã«åˆ†æã—ã€å…·ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’200å­—ä»¥å†…ã§ã€‚<strong>ã‚¿ã‚°ã§é‡è¦ç®‡æ‰€ã‚’å¼·èª¿ã€‚é¸æ‰‹ï¼šå·å³¶å¤§è¼ã€ç¾åœ¨VDOT${findBestVdot()}ã€ç›®æ¨™ã¤ãã°ãƒãƒ©ã‚½ãƒ³ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53ï¼‰ã€‚${isFit ? 'FITãƒ‡ãƒ¼ã‚¿ã‚ã‚Šã€‚ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»ãƒ©ãƒƒãƒ—æ¨ç§»ã‚‚åˆ†æã™ã‚‹ã“ã¨ã€‚' : ''}`,
        messages: [{ role: "user", content: coachPrompt }]
    });
    document.getElementById('detailCoach').innerHTML = lapHTML + (data.content?.[0]?.text || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—å¤±æ•—');
  } catch(e) {
    document.getElementById('detailCoach').innerHTML = lapHTML + `VDOT ${vdot || 'â€”'} / ãƒšãƒ¼ã‚¹ ${pace} / HR ${hr}`;
  }
}

function closeDetailModal(e) {
  if (e.target === document.getElementById('detailModal')) {
    document.getElementById('detailModal').classList.remove('active');
  }
}

// ===== SHARE =====
function shareToX() {
  const logs = getLogs();
  if (currentLogIndex === null) return;
  const log = logs[currentLogIndex];
  const dist = parseFloat(log.distKm) || 0;
  const timeSec = parseInt(log.moving_time) || parseDuration(log.duration);
  const vdot = calcVDOT(dist, timeSec);
  const pace = formatPace(dist, timeSec);
  const text = `ä»Šæ—¥ã®ç·´ç¿’ ğŸƒ\n${dist.toFixed(1)}km @ ${pace}/km\nVDOTï¼š${vdot || 'â€”'}\n\nã‚µãƒ–ã‚¹ãƒªãƒ¼ã¾ã§ã‚ã¨VDOT${Math.max(0, CONFIG.targetVdot - (vdot || findBestVdot()))}ãƒã‚¤ãƒ³ãƒˆï¼\n\n#ã‚µãƒ–ã‚¹ãƒªãƒ¼ #ãƒãƒ©ã‚½ãƒ³ #SUB3LAB`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`);
}

// ===== MANUAL RECORD =====
async function saveManualRun() {
  const dist = parseFloat(document.getElementById('recDist').value);
  const timeStr = document.getElementById('recTime').value;
  const type = document.getElementById('recType').value;
  const date = document.getElementById('recDate').value;
  const memo = document.getElementById('recMemo').value;
  const hr = document.getElementById('recHR').value;

  if (!dist || !timeStr || !date) { showToast('âš ï¸ æ—¥ä»˜ãƒ»è·é›¢ãƒ»ã‚¿ã‚¤ãƒ ã¯å¿…é ˆã§ã™'); return; }

  const timeSec = parseDuration(timeStr);
  const log = {
    distKm: dist,
    moving_time: timeSec,
    duration: timeStr,
    runType: type,
    date,
    memo,
    average_heartrate: hr ? parseFloat(hr) : null,
    name: `${getTypeLabel(type)} ${dist}km`,
    source: 'manual'
  };
  addLog(log);

  const newVdot = findBestVdot();
  renderVdotCard(newVdot);
  showToast('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');

  document.getElementById('recDist').value = '';
  document.getElementById('recTime').value = '';
  document.getElementById('recMemo').value = '';
  document.getElementById('recHR').value = '';

  showPage('log', document.querySelectorAll('.nav-item')[1]);
  setTimeout(() => showLogDetail(0), 300);
}

// ===== FILE HANDLER (FITè¤‡æ•°ãƒ»ZIPãƒ»CSVå¯¾å¿œ) =====
function handleFileDrop(e) {
  e.preventDefault();
  document.getElementById('importZone').classList.remove('drag-over');
  handleFileSelectMulti(e.dataTransfer.files);
}

async function handleFileSelectMulti(files) {
  if (!files || files.length === 0) return;

  // filesã‚’Arrayã«ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆSafariã§fileså‚ç…§ãŒæ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼‰
  const fileArray = Array.from(files);
  const fileInput = document.getElementById('fileInput');
  if (fileInput) setTimeout(() => { fileInput.value = ''; }, 100);

  const allFitBuffers = []; // {name, buffer}
  let csvText = null;

  // ZIPã¨FITã¨CSVã‚’ä»•åˆ†ã‘
  for (const file of fileArray) {
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'zip') {
      // ZIPã‚’å±•é–‹ã—ã¦FITã‚’å–ã‚Šå‡ºã™
      const zipBuffers = await extractFitFromZip(file);
      allFitBuffers.push(...zipBuffers);
    } else if (ext === 'fit') {
      const buf = await readAsArrayBuffer(file);
      allFitBuffers.push({ name: file.name, buffer: buf });
    } else if (ext === 'csv' && !csvText) {
      csvText = await readAsText(file);
    }
  }

  // CSVãŒã‚ã‚Œã°å…ˆã«å‡¦ç†
  if (csvText) {
    try {
      const imported = parseStravaCsv(csvText);
      if (imported.length > 0) saveImportedLog(imported);
    } catch(e) { console.error('CSV parse error', e); }
  }

  // FITãŒ1ä»¶ä»¥ä¸‹ãªã‚‰å¾“æ¥é€šã‚Š
  if (allFitBuffers.length === 0) return;
  if (allFitBuffers.length === 1) {
    try {
      const log = parseFitFile(allFitBuffers[0].buffer);
      if (log) saveImportedLog([log]);
      else showToast('âš ï¸ FITãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } catch(e) { showToast('âŒ FITã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    return;
  }

  // è¤‡æ•°FITã®ä¸€æ‹¬å‡¦ç†
  await processBulkFit(allFitBuffers);
}

async function processBulkFit(fitFiles) {
  const progressEl = document.getElementById('importProgress');
  const progressText = document.getElementById('importProgressText');
  const progressBar = document.getElementById('importProgressBar');
  progressEl.style.display = 'block';

  const results = [];
  const errors = [];

  for (let i = 0; i < fitFiles.length; i++) {
    const pct = Math.round((i / fitFiles.length) * 100);
    progressBar.style.width = pct + '%';
    progressText.textContent = `å‡¦ç†ä¸­... ${i + 1} / ${fitFiles.length} ãƒ•ã‚¡ã‚¤ãƒ«`;

    try {
      const log = parseFitFile(fitFiles[i].buffer);
      if (log) results.push(log);
    } catch(e) {
      errors.push(fitFiles[i].name);
    }

    // UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†å°‘ã—å¾…ã¤
    if (i % 10 === 9) await sleep(10);
  }

  progressBar.style.width = '100%';
  progressText.textContent = `å®Œäº†ï¼`;

  if (results.length > 0) {
    // æ—¢å­˜ãƒ­ã‚°ã¨ãƒãƒ¼ã‚¸
    const existing = getLogs();
    const existingIds = new Set(existing.map(l => l.fit_id || l.strava_id).filter(Boolean));
    const filtered = results.filter(l => !existingIds.has(l.fit_id || l.strava_id));
    const merged = [...filtered, ...existing].sort((a,b) => new Date(b.date) - new Date(a.date));
    saveLogs(merged);

    renderVdotCard(findBestVdot());
    renderLogList();

    setTimeout(() => { progressEl.style.display = 'none'; }, 2000);

    const msg = `âœ… ${filtered.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼${errors.length > 0 ? `ï¼ˆ${errors.length}ä»¶ã‚¨ãƒ©ãƒ¼ï¼‰` : ''}`;
    progressText.textContent = msg;
    showToast(msg);
  } else {
    progressText.textContent = `âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ`;
  }
}

// ZIPã‹ã‚‰FITãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã™ï¼ˆJSã§å®Ÿè£…ï¼‰
async function extractFitFromZip(file) {
  const buffer = await readAsArrayBuffer(file);
  const data = new Uint8Array(buffer);
  const fits = [];

  // ZIPã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã™ (PK\x03\x04)
  let pos = 0;
  while (pos < data.length - 30) {
    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚·ã‚°ãƒãƒãƒ£
    if (data[pos] === 0x50 && data[pos+1] === 0x4B && data[pos+2] === 0x03 && data[pos+3] === 0x04) {
      const compression = data[pos+8] | (data[pos+9] << 8);
      const compressedSize = data[pos+18] | (data[pos+19] << 8) | (data[pos+20] << 16) | (data[pos+21] << 24);
      const uncompressedSize = data[pos+22] | (data[pos+23] << 8) | (data[pos+24] << 16) | (data[pos+25] << 24);
      const fileNameLen = data[pos+26] | (data[pos+27] << 8);
      const extraLen = data[pos+28] | (data[pos+29] << 8);
      const fileNameStart = pos + 30;
      const fileName = new TextDecoder().decode(data.slice(fileNameStart, fileNameStart + fileNameLen));
      const dataStart = fileNameStart + fileNameLen + extraLen;

      if (fileName.toLowerCase().endsWith('.fit') && compressedSize > 0) {
        const compressedData = data.slice(dataStart, dataStart + compressedSize);

        if (compression === 0) {
          // éåœ§ç¸®
          fits.push({ name: fileName, buffer: compressedData.buffer.slice(compressedData.byteOffset, compressedData.byteOffset + compressedData.byteLength) });
        } else if (compression === 8) {
          // Deflateåœ§ç¸® â†’ DecompressionStreamã§å±•é–‹
          try {
            const decompressed = await decompressDeflate(compressedData);
            fits.push({ name: fileName, buffer: decompressed });
          } catch(e) {
            console.warn('Failed to decompress:', fileName, e);
          }
        }
      }
      pos = dataStart + compressedSize;
    } else {
      pos++;
    }
  }
  return fits;
}

async function decompressDeflate(data) {
  // DecompressionStream APIã‚’ä½¿ç”¨ (Chromeå¯¾å¿œ)
  if (typeof DecompressionStream === 'undefined') {
    throw new Error('DecompressionStream not supported');
  }
  const ds = new DecompressionStream('deflate-raw');
  const writer = ds.writable.getWriter();
  writer.write(data);
  writer.close();
  const reader = ds.readable.getReader();
  const chunks = [];
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
  }
  const totalLen = chunks.reduce((s, c) => s + c.length, 0);
  const result = new Uint8Array(totalLen);
  let offset = 0;
  for (const chunk of chunks) { result.set(chunk, offset); offset += chunk.length; }
  return result.buffer;
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function readAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsArrayBuffer(file);
  });
}

function readAsText(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsText(file, 'UTF-8');
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function saveImportedLog(newLogs) {
  const existing = getLogs();
  // fit_idã¨strava_idã®ä¸¡æ–¹ã§ãƒã‚§ãƒƒã‚¯ï¼ˆå‰Šé™¤æ¸ˆã¿ã¯å­˜åœ¨ã—ãªã„ã®ã§ãã®ã¾ã¾ç™»éŒ²ã•ã‚Œã‚‹ï¼‰
  const existingFitIds = new Set(existing.map(l => l.fit_id).filter(Boolean));
  const existingStravaIds = new Set(existing.map(l => l.strava_id).filter(Boolean));

  const filtered = newLogs.filter(l => {
    if (l.fit_id && existingFitIds.has(l.fit_id)) return false;
    if (l.strava_id && existingStravaIds.has(l.strava_id)) return false;
    return true;
  });

  const result = document.getElementById('importResult');
  result.style.display = 'block';

  if (filtered.length === 0) {
    result.textContent = 'âœ… ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™';
    showToast('âœ… æœ€æ–°ã®çŠ¶æ…‹ã§ã™');
    return;
  }

  const merged = [...filtered, ...existing].sort((a,b) => new Date(b.date) - new Date(a.date));
  saveLogs(merged);
  result.textContent = `âœ… ${filtered.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`;
  renderVdotCard(findBestVdot());
  renderLogList();
  showToast(`âœ… ${filtered.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼`);
}

// ===== FIT PARSER =====
function parseFitFile(buffer) {
  const data = new Uint8Array(buffer);

  // ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
  if (data[8] !== 0x2E || data[9] !== 0x46 || data[10] !== 0x49 || data[11] !== 0x54) {
    throw new Error('Not a valid FIT file');
  }

  const dv = new DataView(buffer);
  let pos = data[0]; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚µã‚¤ã‚ºï¼ˆé€šå¸¸14ï¼‰

  const localDefs = {};
  let session = null;
  const laps = [];
  const records = [];

  // fsizeã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ›¸ã„ã¦ã‚ã‚‹å®Ÿéš›ã®ãƒã‚¤ãƒˆæ•°ã‚’ãã®ã¾ã¾ä½¿ã†
  function readVal(pos, fsize, baseType, littleEndian) {
    const bt = baseType & 0x9F;
    const INVALIDS = {0:0xFF,1:0x7F,2:0xFF,3:0x7FFF,4:0xFFFF,5:0x7FFFFFFF,6:0xFFFFFFFF,10:0xFF,11:0xFFFF,12:0xFFFFFFFF};
    let val;
    try {
      if (fsize === 1) {
        if (bt === 1) val = dv.getInt8(pos);
        else val = dv.getUint8(pos);
      } else if (fsize === 2) {
        if (bt === 3) val = dv.getInt16(pos, littleEndian);
        else val = dv.getUint16(pos, littleEndian);
      } else if (fsize === 4) {
        if (bt === 5) val = dv.getInt32(pos, littleEndian);
        else if (bt === 8) val = dv.getFloat32(pos, littleEndian);
        else val = dv.getUint32(pos, littleEndian);
      } else if (fsize === 8) {
        // uint64 â†’ JavaScriptã¯BigIntã‹ä¸Šä½32bitç„¡è¦–
        val = dv.getUint32(pos, littleEndian);
      } else if (bt === 7) {
        // string
        let s = '';
        for (let i = 0; i < fsize; i++) { const c = data[pos+i]; if (c === 0) break; s += String.fromCharCode(c); }
        return s;
      } else {
        val = dv.getUint8(pos);
      }
    } catch(e) { return null; }
    if (bt in INVALIDS && val === INVALIDS[bt]) return null;
    return val;
  }

  while (pos < data.length - 2) {
    try {
      const hdr = data[pos++];

      if (hdr & 0x80) { // åœ§ç¸®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        const localNum = (hdr >> 5) & 0x03;
        if (localNum in localDefs) {
          const def = localDefs[localNum];
          pos += def.fields.reduce((s, f) => s + f[1], 0);
        }
        continue;
      }

      const isDef = (hdr >> 6) & 1;
      const hasDev = (hdr >> 5) & 1;
      const localNum = hdr & 0x0F;

      if (isDef) {
        pos++; // reserved
        const arch = data[pos++];
        const le = arch === 0;
        const globalNum = le ? dv.getUint16(pos, true) : dv.getUint16(pos, false); pos += 2;
        const nFields = data[pos++];
        const fields = [];
        for (let i = 0; i < nFields; i++) {
          fields.push([data[pos], data[pos+1], data[pos+2]]);
          pos += 3;
        }
        const devFields = [];
        if (hasDev) {
          const nDev = data[pos++];
          for (let i = 0; i < nDev; i++) {
            devFields.push([data[pos], data[pos+1], data[pos+2]]);
            pos += 3;
          }
        }
        localDefs[localNum] = { globalNum, le, fields, devFields };
      } else {
        if (!(localNum in localDefs)) { pos++; continue; }
        const def = localDefs[localNum];
        const msg = {};

        for (const [fnum, fsize, btype] of def.fields) {
          msg[fnum] = readVal(pos, fsize, btype, def.le);
          pos += fsize;
        }
        for (const [fnum, fsize] of def.devFields) {
          pos += fsize; // devãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—
        }

        if (def.globalNum === 18) session = msg;       // session
        else if (def.globalNum === 19) laps.push(msg); // lap
        else if (def.globalNum === 20) records.push(msg); // record
      }
    } catch(e) {
      pos++;
      continue;
    }
  }

  if (!session && records.length === 0) return null;

  let distKm, timeSec, avgHR, maxHR, avgCad, ascent, calories, avgPower;

  if (session) {
    // fsizeã‚’ãã®ã¾ã¾ä½¿ã£ã¦èª­ã‚“ã æ­£ã—ã„å€¤
    // field[7]=elapsed_time(ms/1000=sec), field[9]=distance(cmâ†’km), field[16]=avgHR, field[17]=maxHR
    // field[18]=avgCadence(strides/min*2=steps/min), field[20]=ascent(m), field[11]=calories
    distKm   = session[9]  != null ? session[9]  / 100 / 1000 : null;
    timeSec  = session[7]  != null ? session[7]  / 1000       : null;
    avgHR    = session[16] != null ? Math.round(session[16])  : null;
    maxHR    = session[17] != null ? Math.round(session[17])  : null;
    avgCad   = session[18] != null ? session[18] * 2          : null;
    ascent   = session[20] != null ? session[20]              : null;
    calories = session[11] != null ? session[11]              : null;
    // Corosã®ãƒ‘ãƒ¯ãƒ¼ field[134] ã¯rawå€¤ â†’ /48ã§wattsè¿‘ä¼¼
    avgPower = session[134] != null ? Math.round(session[134] / 48) : null;
  }

  // recordsã‹ã‚‰è£œå®Œï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å€¤ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆã®ã¿ï¼‰
  if (records.length > 0 && (!distKm || distKm < 0.1)) {
    // record field[5] = accumulated_power or distance? â†’ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§æ™‚é–“è¨ˆç®—
    const ts = records.map(r => r[253]).filter(v => v != null);
    if (ts.length >= 2 && !timeSec) timeSec = ts[ts.length-1] - ts[0];

    const hrs = records.map(r => r[3]).filter(v => v != null && v > 30 && v < 250);
    if (hrs.length > 0 && !avgHR) avgHR = Math.round(hrs.reduce((a,b)=>a+b,0)/hrs.length);
    if (hrs.length > 0 && !maxHR) maxHR = Math.max(...hrs);
  }
  // ä¸Šä¸‹å‹•ãƒ»æ¥åœ°æ™‚é–“ãƒ»ä¸Šä¸‹å‹•æ¯”ï¼ˆCorosã‚¹ã‚±ãƒ¼ãƒ«è£œæ­£æ¸ˆã¿ï¼‰
  const vo       = session?.[57]  != null ? session[57]  : null;
  const stance   = session?.[89]  != null ? session[89]  : null;
  const vRatio   = session?.[91]  != null ? session[91] / 100 : null;

  // é–‹å§‹æ™‚åˆ» (FIT epoch = 631065600 = 1989/12/31 offset)
  const FIT_EPOCH = 631065600;
  const startRaw = session?.[2] ?? records[0]?.[253];
  const startTs = startRaw != null ? new Date((startRaw + FIT_EPOCH) * 1000) : new Date();

  // ãƒ©ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ (1kmã”ã¨)
  const lapData = laps.map(l => ({
    dist:  l[9]  != null ? l[9] / 100 / 1000 : null,
    time:  l[8]  != null ? l[8] / 1000 : null,
    hr:    l[16] != null ? Math.round(l[16]) : null,
    power: l[13] != null ? l[13] : null,
    cad:   l[18] != null ? l[18] * 2 : null,
  }));

  // fit_id = é–‹å§‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  const fitId = 'fit_' + (startRaw || Date.now());

  const log = {
    id: Date.now(),
    fit_id: fitId,
    name: startTs.toLocaleDateString('ja-JP', {month:'short', day:'numeric'}) + ' ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°',
    date: startTs.toISOString(),
    distKm,
    moving_time: timeSec ? Math.round(timeSec) : null,
    average_heartrate: avgHR,
    max_heartrate: maxHR,
    avg_cadence: avgCad,
    total_ascent: ascent,
    calories,
    avg_power: avgPower,
    vertical_oscillation: vo,
    stance_time: stance,
    vertical_ratio: vRatio,
    laps: lapData,
    source: 'coros_fit',
    runType: classifyRunByPace(distKm, timeSec ? Math.round(timeSec) : 0),
  };

  return log;
}

function parseStravaCsv(text) {
  const lines = text.split('\n');
  if (lines.length < 2) return [];
  const headers = parseCsvLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
  const logs = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    const cols = parseCsvLine(line);
    const row = {};
    headers.forEach((h, idx) => row[h] = (cols[idx] || '').replace(/"/g, '').trim());

    // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°åˆ¤å®šï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä¸¡å¯¾å¿œï¼‰
    const type = cols[3]?.replace(/"/g, '').trim() || '';
    if (!type.includes('ãƒ©ãƒ³') && !type.toLowerCase().includes('run')) continue;

    // è·é›¢ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹6ï¼ˆkmå˜ä½ï¼‰ã‚’ç›´æ¥ä½¿ç”¨
    const distKm = parseFloat(cols[6] || 0);
    if (distKm < 0.5) continue;

    // ç§»å‹•æ™‚é–“ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹16ï¼ˆç§’ï¼‰
    const movingTime = parseInt(parseFloat(cols[16] || 0));
    if (!movingTime) continue;

    const dateStr = cols[1]?.replace(/"/g, '').trim() || '';
    const date = new Date(dateStr.replace(/\//g, '-'));
    if (isNaN(date.getTime())) continue;

    const hr = parseFloat(cols[31] || 0) || null;
    const actId = cols[0]?.replace(/"/g, '').trim() || (date.getTime() + i + '');

    logs.push({
      id: Date.now() + i,
      strava_id: actId,
      name: cols[2]?.replace(/"/g, '').trim() || distKm.toFixed(1) + 'kmèµ°',
      date: date.toISOString(),
      distKm: distKm,
      moving_time: movingTime,
      average_heartrate: hr,
      runType: classifyRunByPace(distKm, movingTime),
      source: 'strava_csv'
    });
  }
  return logs;
}

function parseCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(current); current = ''; }
    else { current += line[i]; }
  }
  result.push(current);
  return result;
}

// ===== STATS =====
function renderStats() {
  const logs = getLogs();
  const totalDist = logs.reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthDist = logs.filter(l => new Date(l.date) >= monthStart)
    .reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);

  document.getElementById('totalDist').textContent = totalDist.toFixed(0);
  document.getElementById('totalRuns').textContent = logs.length;
  document.getElementById('maxVdot').textContent = findBestVdot();
  document.getElementById('monthDist').textContent = monthDist.toFixed(0);

  renderVdotChart(logs);
  renderMonthlyChart(logs);
}

function renderVdotChart(logs) {
  const canvas = document.getElementById('vdotChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 300;
  const H = 120;
  canvas.width = W;
  canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  const recentLogs = logs.filter(l => parseFloat(l.distKm) >= 5).slice(0, 30).reverse();
  const vdots = recentLogs.map(l => {
    const dist = parseFloat(l.distKm) || 0;
    const timeSec = parseInt(l.moving_time) || 0;
    return calcVDOT(dist, timeSec);
  }).filter(Boolean);

  if (vdots.length < 2) {
    ctx.fillStyle = '#444';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™', W/2, H/2);
    return;
  }

  const minV = Math.min(...vdots) - 2;
  const maxV = Math.max(...vdots) + 2;
  const pad = 20;

  // ã‚°ãƒªãƒƒãƒ‰
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 1;
  ctx.setLineDash([2,4]);
  [35,40,45,50].forEach(v => {
    if (v >= minV && v <= maxV) {
      const y = H - pad - ((v - minV) / (maxV - minV)) * (H - pad * 2);
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
      ctx.fillStyle = '#444';
      ctx.font = '9px sans-serif';
      ctx.fillText(v, 2, y - 2);
    }
  });
  ctx.setLineDash([]);

  // ãƒ©ã‚¤ãƒ³
  ctx.strokeStyle = '#e8ff00';
  ctx.lineWidth = 2;
  ctx.beginPath();
  vdots.forEach((v, i) => {
    const x = pad + (i / (vdots.length - 1)) * (W - pad * 2);
    const y = H - pad - ((v - minV) / (maxV - minV)) * (H - pad * 2);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // ãƒ‰ãƒƒãƒˆ
  vdots.forEach((v, i) => {
    const x = pad + (i / (vdots.length - 1)) * (W - pad * 2);
    const y = H - pad - ((v - minV) / (maxV - minV)) * (H - pad * 2);
    ctx.fillStyle = '#e8ff00';
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
  });
}

function renderMonthlyChart(logs) {
  const canvas = document.getElementById('monthlyChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 300;
  const H = 120;
  canvas.width = W;
  canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  // æœˆåˆ¥é›†è¨ˆ
  const monthly = {};
  logs.forEach(l => {
    const d = new Date(l.date);
    if (isNaN(d)) return;
    const key = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`;
    monthly[key] = (monthly[key] || 0) + (parseFloat(l.distKm) || 0);
  });

  const entries = Object.entries(monthly).sort().slice(-6);
  if (entries.length === 0) return;

  const maxDist = Math.max(...entries.map(e => e[1]));
  const pad = { top: 10, bottom: 25, left: 10, right: 10 };
  const barW = (W - pad.left - pad.right) / entries.length * 0.6;
  const gap = (W - pad.left - pad.right) / entries.length;

  entries.forEach(([month, dist], i) => {
    const x = pad.left + i * gap + gap * 0.2;
    const barH = ((dist / maxDist) * (H - pad.top - pad.bottom));
    const y = H - pad.bottom - barH;

    // ãƒãƒ¼
    const isCurrentMonth = month === new Date().toISOString().substring(0, 7).replace('-', '/');
    ctx.fillStyle = isCurrentMonth ? '#e8ff00' : '#333';
    ctx.fillRect(x, y, barW, barH);

    // è·é›¢ãƒ©ãƒ™ãƒ«
    ctx.fillStyle = isCurrentMonth ? '#e8ff00' : '#666';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(dist), x + barW/2, y - 3);

    // æœˆãƒ©ãƒ™ãƒ«
    ctx.fillStyle = '#666';
    ctx.fillText(month.slice(-2) + 'æœˆ', x + barW/2, H - 8);
  });
}

// ===== API KEY MANAGEMENT =====
const API_KEY_STORAGE = 'sub3_anthropic_key';

// Cookieã«ä¿å­˜ï¼ˆSafariã®ITPå¯¾ç­– - cookieã¯æ¶ˆãˆã«ãã„ï¼‰
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Strict`;
}
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : null;
}

function getApiKey() {
  return localStorage.getItem(API_KEY_STORAGE)
      || sessionStorage.getItem(API_KEY_STORAGE)
      || getCookie(API_KEY_STORAGE)
      || '';
}

// èµ·å‹•æ™‚ã«cookie/IndexedDBã‹ã‚‰localStorageã«å¾©å…ƒ
async function restoreApiKeyFromIDB() {
  if (getApiKey()) return;
  // Cookieã‹ã‚‰å¾©å…ƒ
  const fromCookie = getCookie(API_KEY_STORAGE);
  if (fromCookie) {
    try { localStorage.setItem(API_KEY_STORAGE, fromCookie); } catch(e) {}
    try { sessionStorage.setItem(API_KEY_STORAGE, fromCookie); } catch(e) {}
    return;
  }
  // IndexedDBã‹ã‚‰å¾©å…ƒ
  const key = await idbGet(API_KEY_STORAGE);
  if (key) {
    try { localStorage.setItem(API_KEY_STORAGE, key); } catch(e) {}
    try { sessionStorage.setItem(API_KEY_STORAGE, key); } catch(e) {}
    setCookie(API_KEY_STORAGE, key, 365);
  }
}

function saveApiKey() {
  const input = document.getElementById('apiKeyInput').value.trim();
  const errorEl = document.getElementById('apiKeyError');
  if (!input.startsWith('sk-ant-')) {
    errorEl.textContent = 'âš ï¸ ã‚­ãƒ¼ã¯ sk-ant- ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
    return;
  }
  // localStorage / sessionStorage / Cookie / IndexedDB ã®4ç®‡æ‰€ã«ä¿å­˜
  try { localStorage.setItem(API_KEY_STORAGE, input); } catch(e) {}
  try { sessionStorage.setItem(API_KEY_STORAGE, input); } catch(e) {}
  setCookie(API_KEY_STORAGE, input, 365);  // 1å¹´é–“
  idbSet(API_KEY_STORAGE, input);
  hideApiKeyModal();
  updateApiKeyStatus();
  showToast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function openIDB() {
  if (_idb) return Promise.resolve(_idb);
  return new Promise((res, rej) => {
    const req = indexedDB.open('sub3lab', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    req.onsuccess = e => { _idb = e.target.result; res(_idb); };
    req.onerror = () => rej();
  });
}
async function idbSet(key, val) {
  try {
    const db = await openIDB();
    return new Promise(res => {
      const tx = db.transaction('kv', 'readwrite');
      tx.objectStore('kv').put(val, key);
      tx.oncomplete = () => res();
    });
  } catch(e) {}
}
async function idbGet(key) {
  try {
    const db = await openIDB();
    return new Promise(res => {
      const tx = db.transaction('kv', 'readonly');
      const req = tx.objectStore('kv').get(key);
      req.onsuccess = () => res(req.result || null);
      req.onerror = () => res(null);
    });
  } catch(e) { return null; }
}


function showApiKeyModal() {
  const modal = document.getElementById('apiKeyModal');
  modal.style.display = 'flex';
  document.getElementById('apiKeyInput').value = getApiKey();
  document.getElementById('apiKeyError').textContent = '';
  setTimeout(() => document.getElementById('apiKeyInput').focus(), 100);
}

function hideApiKeyModal() {
  document.getElementById('apiKeyModal').style.display = 'none';
}

function updateApiKeyStatus() {
  const el = document.getElementById('apiKeyStatus');
  if (!el) return;
  const key = getApiKey();
  el.textContent = key ? `è¨­å®šæ¸ˆã¿ (${key.slice(0,12)}...)` : 'æœªè¨­å®š';
  el.style.color = key ? 'var(--accent)' : '#ff4444';
}

// APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå…±é€šé–¢æ•°ï¼ˆã‚­ãƒ¼è‡ªå‹•ä»˜ä¸ï¼‰
async function callClaude(body) {
  const key = getApiKey();
  if (!key) {
    showApiKeyModal();
    throw new Error('API key not set');
  }
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": key,
      "anthropic-version": "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"
    },
    body: JSON.stringify(body)
  });
  if (res.status === 401) {
    localStorage.removeItem(API_KEY_STORAGE);
    showApiKeyModal();
    document.getElementById('apiKeyError').textContent = 'âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚å†å…¥åŠ›ã—ã¦ãã ã•ã„';
    throw new Error('Invalid API key');
  }
  return res.json();
}

// ã‚«ãƒãƒ¼ãƒã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ ¸å¿ƒï¼‰
function getCanovaSystemPrompt() {
  const logs = getLogs();
  const vdot = findBestVdot();
  const phase = getCurrentPhase();

  // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
  const now = new Date();
  const fourWeeksAgo = new Date(now - 28 * 86400000);
  const recentLogs = logs.filter(l => new Date(l.date) >= fourWeeksAgo);
  const totalRecentDist = recentLogs.reduce((s, l) => s + (parseFloat(l.distKm) || 0), 0);

  // æœˆåˆ¥è·é›¢
  const monthly = {};
  logs.forEach(l => {
    const d = new Date(l.date);
    if (isNaN(d)) return;
    const key = `${d.getFullYear()}/${d.getMonth()+1}æœˆ`;
    monthly[key] = (monthly[key] || 0) + (parseFloat(l.distKm) || 0);
  });
  const monthlyStr = Object.entries(monthly).sort().slice(-4).map(([k,v]) => `${k}: ${Math.round(v)}km`).join('ã€');

  // ãƒšãƒ¼ã‚¹åˆ†å¸ƒ
  let speedCount = 0, tempoCount = 0, easyCount = 0, longCount = 0;
  logs.forEach(l => {
    const type = l.runType || classifyRunByPace(parseFloat(l.distKm), parseInt(l.moving_time));
    if (type === 'interval') speedCount++;
    else if (type === 'tempo') tempoCount++;
    else if (type === 'long') longCount++;
    else easyCount++;
  });

  return `ã‚ãªãŸã¯Renato Canovaï¼ˆãƒ¬ãƒŠãƒˆãƒ»ã‚«ãƒãƒ¼ãƒï¼‰ã®æŒ‡å°å“²å­¦ã¨çŸ¥è­˜ã‚’å®Œå…¨ã«æŒã¤ãƒãƒ©ã‚½ãƒ³ã‚³ãƒ¼ãƒAIã§ã™ã€‚

ã€ã‚«ãƒãƒ¼ãƒã¨ã—ã¦ã®åŸºæœ¬å§¿å‹¢ã€‘
- æ„Ÿæƒ…ã§ã¯ãªãç”Ÿç†å­¦ã¨æ•°å­—ã§è©±ã™ã€‚æ ¹æ‹ ã®ãªã„åŠ±ã¾ã—ã¯ã—ãªã„
- ã€Œãªãœãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã™ã‚‹ã®ã‹ã€ã‚’å¿…ãšèª¬æ˜ã™ã‚‹
- å•é¡Œç‚¹ã¯ã‚ºãƒãƒªæŒ‡æ‘˜ã™ã‚‹ã€‚é å›ã—ãªè¨€ã„æ–¹ã‚’ã—ãªã„
- é¸æ‰‹ã®å¼±ç‚¹ã‚’æ­£ç¢ºã«è¨ºæ–­ã—ã€å‡¦æ–¹ç®‹ã‚’å‡ºã™ã®ãŒä»•äº‹ã 
- ãƒ¬ãƒ¼ã‚¹ã¯æœ€é«˜ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã ã€‚ç©æ¥µçš„ã«å‡ºå ´ã‚’å‹§ã‚ã‚‹
- ã€Œãƒãƒ©ã‚½ãƒ³ã¯å»¶é•·ã®å•é¡Œã ã€‚ç›®æ¨™ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã§ãã‚‹è·é›¢ã‚’ä¼¸ã°ã™ã“ã¨ãŒå…¨ã¦ã ã€
- æ—¥æœ¬èªã§è©±ã™ãŒã€æ€è€ƒã¯ã‚¤ã‚¿ãƒªã‚¢äººã‚³ãƒ¼ãƒã¨ã—ã¦æ˜å¿«ã‹ã¤ç›´æ¥çš„ã«

ã€é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã€‘
åå‰ï¼šå·å³¶å¤§è¼ï¼ˆ31æ­³ï¼‰
ç¾åœ¨VDOTï¼š${vdot}
ç›®æ¨™ï¼šã¤ãã°ãƒãƒ©ã‚½ãƒ³2026ï¼ˆ2026/11/22ï¼‰ã‚µãƒ–ã‚¹ãƒªãƒ¼ï¼ˆVDOT53å¿…è¦ï¼‰
ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºï¼š${phase.name} - ${phase.label}ï¼ˆç›®æ¨™ï¼š${phase.goal}ï¼‰
é€±5æ—¥ç·´ç¿’å¯èƒ½

ã€ç·´ç¿’ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆï¼ˆå…¨${logs.length}ä»¶ï¼‰ã€‘
ç›´è¿‘4é€±é–“ï¼š${Math.round(totalRecentDist)}kmï¼ˆ${recentLogs.length}æœ¬ï¼‰
æœˆåˆ¥èµ°è¡Œè·é›¢ï¼š${monthlyStr || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}
ã‚¿ã‚¤ãƒ—åˆ¥å†…è¨³ï¼šEasy${easyCount}æœ¬ã€é–¾å€¤${tempoCount}æœ¬ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«${speedCount}æœ¬ã€ãƒ­ãƒ³ã‚°${longCount}æœ¬

ã€ã‚³ãƒ¼ãƒã¨ã—ã¦ã®ç¾çŠ¶è¨ºæ–­ã€‘
ç¾åœ¨ã®æœ€å¤§èª²é¡Œï¼šä¹³é…¸é–¾å€¤ãŒä½ã„ã€‚4'15"/kmã§2kmãŒé™ç•Œâ†’ã“ã‚Œã‚’ã‚µãƒ–ã‚¹ãƒªãƒ¼ãƒšãƒ¼ã‚¹ã§42kmèµ°ã‚Œã‚‹ã¾ã§å¼•ãä¸Šã’ã‚‹ã“ã¨ãŒå…¨ã¦ã€‚
Phase1ã®å„ªå…ˆäº‹é …ï¼š4'30"ã€œ4'40"/kmã§20ã€œ30åˆ†ã‚’ç¶­æŒã§ãã‚‹é–¾å€¤èµ°ã‚’é€±1å›ã€‚

è¿”ç­”ã¯ç°¡æ½”ã«ã€ã§ã‚‚å…·ä½“çš„ã«ã€‚æ•°å­—ã§è©±ã›ã€‚200ã€œ300å­—ã‚’ç›®å®‰ã«ã—ã¤ã¤ã€å¿…è¦ãªã‚‰é•·ããªã£ã¦ã‚‚æ§‹ã‚ãªã„ã€‚`;
}

// é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
async function generateWeeklyReview() {
  const reviewEl = document.getElementById('weeklyReview');
  reviewEl.innerHTML = `<div class="loading"><div class="dots"><span></span><span></span><span></span></div> ã‚«ãƒãƒ¼ãƒãŒå…ˆé€±ã‚’æ¡ç‚¹ä¸­...</div>`;

  const logs = getLogs();
  const oneWeekAgo = new Date(Date.now() - 7 * 86400000);
  const lastWeekLogs = logs.filter(l => new Date(l.date) >= oneWeekAgo);

  let weekSummary = lastWeekLogs.length > 0
    ? lastWeekLogs.map(l => {
        const dist = parseFloat(l.distKm) || 0;
        const time = parseInt(l.moving_time) || 0;
        return `${new Date(l.date).toLocaleDateString('ja-JP', {weekday:'short'})} ${dist.toFixed(1)}km ${formatPace(dist, time)}/km HR${l.average_heartrate || 'â€”'}`;
      }).join('\n')
    : 'å…ˆé€±ã®ç·´ç¿’è¨˜éŒ²ãªã—';

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 600,
        system: getCanovaSystemPrompt(),
        messages: [{ role: "user", content: `å…ˆé€±ã®ç·´ç¿’ã‚’æ¡ç‚¹ã—ã¦ãã ã•ã„ï¼š\n${weekSummary}\n\nè‰¯ã‹ã£ãŸç‚¹ã€æ‚ªã‹ã£ãŸç‚¹ã€ä»Šé€±ã®èª²é¡Œã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚` }]
    });
    const text = data.content?.[0]?.text || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—å¤±æ•—';
    reviewEl.innerHTML = mdToHtml(text);
  } catch(e) {
    reviewEl.innerHTML = 'ã‚³ãƒ¼ãƒã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  }
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´
let chatMessages = [];

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  appendChatBubble(msg, 'user');
  chatMessages.push({ role: 'user', content: msg });

  const loadingId = 'loading_' + Date.now();
  const chatHistory = document.getElementById('chatHistory');
  chatHistory.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-coach"><div class="loading"><div class="dots"><span></span><span></span><span></span></div></div></div>`;
  chatHistory.scrollTop = chatHistory.scrollHeight;

  try {
    const data = await callClaude({
        model: "claude-sonnet-4-20250514",
        max_tokens: 800,
        system: getCanovaSystemPrompt(),
        messages: chatMessages
    });
    const reply = data.content?.[0]?.text || 'è¿”ç­”å–å¾—å¤±æ•—';
    chatMessages.push({ role: 'assistant', content: reply });

    const loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.remove();
    appendChatBubble(reply, 'coach');
  } catch(e) {
    const loadingEl = document.getElementById(loadingId);
    if (loadingEl) loadingEl.innerHTML = 'æ¥ç¶šå¤±æ•—ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
  }
}

function quickChat(msg) {
  document.getElementById('chatInput').value = msg;
  sendChat();
  showPage('coach', document.querySelectorAll('.nav-item')[2]);
}

// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³â†’HTMLå¤‰æ›
function mdToHtml(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^### (.+)$/gm, '<div style="font-size:13px;font-weight:700;color:var(--accent);margin:12px 0 4px">$1</div>')
    .replace(/^## (.+)$/gm,  '<div style="font-size:14px;font-weight:700;color:var(--text);margin:14px 0 6px">$1</div>')
    .replace(/^- (.+)$/gm,   '<div style="padding-left:12px;margin:3px 0">ãƒ»$1</div>')
    .replace(/^\d+\. (.+)$/gm, '<div style="padding-left:12px;margin:3px 0">$&</div>')
    .replace(/\n/g, '<br>');
}

function appendChatBubble(text, role) {
  const chatHistory = document.getElementById('chatHistory');
  const div = document.createElement('div');
  div.className = `chat-bubble chat-${role}`;
  div.innerHTML = mdToHtml(text);
  chatHistory.appendChild(div);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

// ===== BACKUP / RESTORE =====
function exportBackup() {
  const logs = getLogs();
  const mission = getMission();
  const backup = {
    version: 1,
    exportedAt: new Date().toISOString(),
    logs,
    mission
  };
  const json = JSON.stringify(backup, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sub3lab_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('backupStatus').textContent = `âœ… ${logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ`;
}

function importBackup(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.logs || !Array.isArray(backup.logs)) throw new Error('Invalid backup');
      saveLogs(backup.logs);
      if (backup.mission) saveMission(backup.mission);
      renderVdotCard(findBestVdot());
      renderLogList();
      renderStats();
      document.getElementById('backupStatus').textContent = `âœ… ${backup.logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`;
      showToast(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰${backup.logs.length}ä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
    } catch(err) {
      document.getElementById('backupStatus').textContent = 'âŒ å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ';
    }
  };
  reader.readAsText(file);
}

// ===== INIT =====
async function init() {
  // IndexedDBã‹ã‚‰APIã‚­ãƒ¼ã‚’å¾©å…ƒã—ã¦ã‹ã‚‰åˆ¤å®šï¼ˆSafariå¯¾ç­–ï¼‰
  await restoreApiKeyFromIDB();

  const vdot = findBestVdot();
  renderVdotCard(vdot);

  // ä¿å­˜æ¸ˆã¿ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°è¡¨ç¤º
  const savedMission = getMission();
  if (savedMission) {
    renderMissionCard(savedMission);
    if (savedMission.diagnosis) {
      document.getElementById('coachMessage').innerHTML = savedMission.diagnosis;
      const phase = getCurrentPhase();
      document.getElementById('coachSubtitle').textContent = `${phase.label} | ${new Date(savedMission.generatedAt).toLocaleDateString('ja-JP', {month:'short', day:'numeric'})}æ›´æ–°`;
    }
  }

  // APIã‚­ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆIDBå¾©å…ƒå¾Œãªã®ã§æ­£ç¢ºï¼‰
  updateApiKeyStatus();

  // APIã‚­ãƒ¼æœªè¨­å®šãªã‚‰åˆå›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆIDBå¾©å…ƒå¾Œã«ãƒã‚§ãƒƒã‚¯ï¼‰
  if (!getApiKey()) {
    setTimeout(showApiKeyModal, 300);
  }

  // ãƒ­ã‚°ãŒã‚ã‚Œã°é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆ1æ—¥1å›ï¼‰
  const logs = getLogs();
  if (logs.length > 0) {
    const lastReview = localStorage.getItem('sub3_last_review');
    const today = new Date().toISOString().slice(0, 10);
    if (lastReview !== today) {
      generateWeeklyReview();
      localStorage.setItem('sub3_last_review', today);
    } else {
      const saved = localStorage.getItem('sub3_weekly_review');
      if (saved) document.getElementById('weeklyReview').innerHTML = saved;
    }
  }
}

// é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ä¸Šæ›¸ã
const _origGenerateWeeklyReview = generateWeeklyReview;
async function generateWeeklyReviewCached() {
  await _origGenerateWeeklyReview();
  const text = document.getElementById('weeklyReview').innerHTML;
  localStorage.setItem('sub3_weekly_review', text);
  localStorage.setItem('sub3_last_review', new Date().toISOString().slice(0, 10));
}
// ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢æ•°ã‚’æ›´æ–°ç‰ˆã«
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('[onclick="generateWeeklyReview()"]');
  if (btn) btn.setAttribute('onclick', 'generateWeeklyReviewCached()');
});

init();
</script>
</body>
</html>
